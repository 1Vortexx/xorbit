<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-ORBIT Support Center</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #6B46C1 0%, #9333EA 50%, #EC4899 100%);
            --dark-bg: #0a0a0f;
            --card-bg: rgba(17, 17, 28, 0.95);
            --card-border: rgba(147, 51, 234, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --purple-glow: 0 0 20px rgba(147, 51, 234, 0.5);
            --pink-glow: 0 0 20px rgba(236, 72, 153, 0.5);
            --accent-purple: #9333EA;
            --accent-pink: #EC4899;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark-bg);
            min-height: 100vh;
            color: var(--text-primary);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(147, 51, 234, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(236, 72, 153, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 100%, rgba(107, 70, 193, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .login-box {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), var(--purple-glow);
            width: 450px;
            max-width: 100%;
            backdrop-filter: blur(10px);
        }

        .login-box h1 {
            text-align: center;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .login-box h1 i {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-box > p {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        select,
        textarea {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent-purple);
            background: rgba(147, 51, 234, 0.05);
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
        }

        .form-group input::placeholder {
            color: rgba(161, 161, 170, 0.5);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary-gradient);
            border: none;
            color: white;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .login-btn:hover::before {
            left: 100%;
        }

        .login-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(147, 51, 234, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-option-btn {
            width: 100%;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(147, 51, 234, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .login-option-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(147, 51, 234, 0.1), transparent);
            transition: left 0.4s;
        }

        .login-option-btn:hover::before {
            left: 100%;
        }

        .login-option-btn:hover {
            border-color: var(--accent-purple);
            background: rgba(147, 51, 234, 0.1);
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(147, 51, 234, 0.2);
        }

        .login-option-btn i {
            font-size: 28px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            min-width: 40px;
        }

        .login-option-btn h3 {
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .login-option-btn p {
            color: var(--text-secondary);
            font-size: 13px;
            margin: 0;
        }

        .back-link {
            background: none;
            border: none;
            color: var(--accent-purple);
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0;
            transition: all 0.2s;
            font-weight: 500;
        }

        .back-link:hover {
            color: var(--accent-pink);
            transform: translateX(-3px);
        }

        .error-message,
        .success-message {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .error-message.show,
        .success-message.show {
            display: block;
        }

        #supportDashboard {
            display: none;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--card-border);
            padding: 20px 0;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: var(--text-secondary);
        }

        .user-info strong {
            color: var(--text-primary);
        }

        .logout-btn {
            background: rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.3);
            color: var(--accent-purple);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(147, 51, 234, 0.3);
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .welcome-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            margin-bottom: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(147, 51, 234, 0.1) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .welcome-section h1 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-size: 36px;
            font-weight: 800;
            position: relative;
        }

        .welcome-section p {
            color: var(--text-secondary);
            position: relative;
        }

        .my-tickets-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .my-tickets-section h2 {
            color: var(--text-primary);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 24px;
            font-weight: 700;
        }

        .new-ticket-btn {
            padding: 12px 24px;
            background: var(--primary-gradient);
            border: none;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .new-ticket-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(147, 51, 234, 0.4);
        }

        .ticket-list {
            display: grid;
            gap: 15px;
        }

        .ticket-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(147, 51, 234, 0.2);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .ticket-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(147, 51, 234, 0.05), transparent);
            transition: left 0.5s;
        }

        .ticket-card:hover::before {
            left: 100%;
        }

        .ticket-card:hover {
            border-color: var(--accent-purple);
            background: rgba(147, 51, 234, 0.05);
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(147, 51, 234, 0.2);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .ticket-number {
            font-weight: 600;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ticket-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-open { 
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        .status-in_progress { 
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .status-waiting_response { 
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
            border: 1px solid rgba(236, 72, 153, 0.3);
        }
        .status-resolved { 
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .status-closed { 
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .ticket-subject {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .ticket-preview {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .ticket-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .ticket-meta i {
            color: var(--accent-purple);
            margin-right: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0.5;
        }

        .ticket-closed-state {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 40px 20px;
            background: transparent;
        }

        .ticket-closed-modal {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), var(--purple-glow);
            width: 450px;
            max-width: 100%;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .ticket-closed-modal i.status-icon {
            font-size: 64px;
            margin-bottom: 24px;
            color: var(--warning);
            display: block;
        }

        .ticket-closed-modal.closed-status i.status-icon {
            color: var(--text-secondary);
        }

        .ticket-closed-modal h2 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 28px;
            font-weight: 700;
        }

        .ticket-closed-modal p {
            color: var(--text-secondary);
            margin-bottom: 30px;
            line-height: 1.6;
            font-size: 15px;
        }

        .ticket-closed-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .reopen-btn {
            width: 100%;
            padding: 14px 24px;
            background: var(--primary-gradient);
            border: none;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .reopen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(147, 51, 234, 0.4);
        }

        .delete-btn {
            width: 100%;
            padding: 14px 24px;
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            transform: translateY(-2px);
        }

        .ticket-info-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(147, 51, 234, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--accent-purple);
            margin-bottom: 24px;
            font-weight: 600;
            border: 1px solid rgba(147, 51, 234, 0.3);
        }

        #chatView {
            display: none;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            height: 650px;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 25px;
            border-bottom: 1px solid var(--card-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
        }

        .chat-header h3 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            font-size: 18px;
        }

        .chat-header span {
            margin-left: 15px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .back-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid rgba(147, 51, 234, 0.3);
            color: var(--accent-purple);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            border-color: var(--accent-purple);
            background: rgba(147, 51, 234, 0.1);
            transform: translateX(-3px);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: rgba(0, 0, 0, 0.2);
        }

        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(147, 51, 234, 0.3);
            border-radius: 10px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: rgba(147, 51, 234, 0.5);
        }

        .message {
            max-width: 70%;
            margin-bottom: 20px;
            animation: fadeIn 0.3s;
        }

        .message.user {
            margin-left: auto;
        }

        .message-header {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message.user .message-header {
            text-align: right;
        }

        .message-bubble {
            display: inline-block;
            padding: 14px 18px;
            border-radius: 16px;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 15px;
        }

        .message.user .message-bubble {
            background: var(--primary-gradient);
            color: white;
            border-bottom-right-radius: 4px;
            float: right;
            box-shadow: 0 5px 15px rgba(147, 51, 234, 0.3);
        }

        .message.staff .message-bubble {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(147, 51, 234, 0.2);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .message.system {
            max-width: 100%;
            text-align: center;
            margin: 25px 0;
        }

        .message.system .message-bubble {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 14px 24px;
            font-size: 14px;
            border-radius: 10px;
            display: inline-block;
            max-width: 90%;
            line-height: 1.6;
            font-weight: 500;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
            clear: both;
            opacity: 0.7;
        }

        .message.user .message-time {
            text-align: right;
        }

        .message-input-area {
            padding: 20px;
            border-top: 1px solid var(--card-border);
            background: rgba(0, 0, 0, 0.3);
        }

        .message-input-container {
            display: flex;
            gap: 12px;
        }

        .message-input {
            flex: 1;
            padding: 14px 16px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 10px;
            color: var(--text-primary);
            resize: none;
            font-family: inherit;
            font-size: 15px;
            transition: all 0.3s;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--accent-purple);
            background: rgba(147, 51, 234, 0.05);
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
        }

        .message-input::placeholder {
            color: rgba(161, 161, 170, 0.5);
        }

        .send-btn {
            padding: 14px 28px;
            background: var(--primary-gradient);
            border: none;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(147, 51, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), var(--purple-glow);
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(147, 51, 234, 0.3);
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(147, 51, 234, 0.5);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: 1px solid rgba(147, 51, 234, 0.2);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: rgba(147, 51, 234, 0.1);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
            transform: rotate(90deg);
        }

        .modal h2 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: 700;
        }

        select {
            background: rgba(0, 0, 0, 0.4);
            color: var(--text-primary);
            cursor: pointer;
        }

        select option {
            background: var(--card-bg);
            color: var(--text-primary);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }
        
</style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-box">
            <h1><i class="fas fa-satellite"></i> X-ORBIT Support</h1>
            <p>How can we help you today?</p>
            
            <div id="loginOptions">
                <button class="login-option-btn" onclick="showClientLogin()">
                    <i class="fas fa-user"></i>
                    <div>
                        <h3>X-ORBIT Member</h3>
                        <p>Login with your X-ORBIT account</p>
                    </div>
                </button>
                <button class="login-option-btn" onclick="showGuestServices()">
                    <i class="fas fa-headset"></i>
                    <div>
                        <h3>Account Services</h3>
                        <p>Password reset or account creation</p>
                    </div>
                </button>
                <button class="login-option-btn" onclick="showGuestLogin()">
                    <i class="fas fa-envelope"></i>
                    <div>
                        <h3>Returning Guest</h3>
                        <p>Continue previous support conversation</p>
                    </div>
                </button>
            </div>

            <div id="clientLoginForm" style="display: none;">
                <button class="back-link" onclick="showLoginOptions()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="error-message" id="loginError"></div>
                <form onsubmit="handleLogin(event)" id="loginForm">
                    <div class="form-group">
                        <label for="username">Email</label>
                        <input type="text" id="username" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="login-btn" id="loginBtn">Login</button>
                </form>
            </div>

            <div id="guestServicesForm" style="display: none;">
                <button class="back-link" onclick="showLoginOptions()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h2 style="text-align: center; color: #9333EA; margin-bottom: 10px;">Account Services</h2>
                <p style="text-align: center; color: #a1a1aa; margin-bottom: 20px; font-size: 14px;">
                    Get help with password resets or account creation
                </p>
                <div class="error-message" id="guestError"></div>
                <form onsubmit="handleGuestServices(event)" id="guestForm">
                    <div class="form-group">
                        <label for="guestFirstName">First Name</label>
                        <input type="text" id="guestFirstName" required placeholder="John">
                    </div>
                    <div class="form-group">
                        <label for="guestLastName">Last Name</label>
                        <input type="text" id="guestLastName" required placeholder="Doe">
                    </div>
                    <div class="form-group">
                        <label for="guestEmail">Email</label>
                        <input type="email" id="guestEmail" required placeholder="your@email.com">
                    </div>
                    <button type="submit" class="login-btn" id="guestBtn">Continue to Support</button>
                </form>
            </div>

            <div id="guestLoginForm" style="display: none;">
                <button class="back-link" onclick="showLoginOptions()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h2 style="text-align: center; background: linear-gradient(135deg, #6B46C1 0%, #9333EA 50%, #EC4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px;">Returning Guest</h2>
                <p style="text-align: center; color: #a1a1aa; margin-bottom: 20px; font-size: 14px;">
                    Access your previous support tickets
                </p>
                <div class="error-message" id="guestLoginError"></div>
                <form onsubmit="handleGuestLogin(event)" id="guestLoginFormElement">
                    <div class="form-group">
                        <label for="guestLoginFirstName">First Name</label>
                        <input type="text" id="guestLoginFirstName" required placeholder="John">
                    </div>
                    <div class="form-group">
                        <label for="guestLoginLastName">Last Name</label>
                        <input type="text" id="guestLoginLastName" required placeholder="Doe">
                    </div>
                    <div class="form-group">
                        <label for="guestLoginEmail">Email</label>
                        <input type="email" id="guestLoginEmail" required placeholder="your@email.com">
                    </div>
                    <button type="submit" class="login-btn" id="guestLoginBtn">Access Support</button>
                </form>
            </div>
        </div>
    </div>

    <div id="supportDashboard">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-satellite"></i> X-ORBIT Support
                </div>
                <div class="user-info">
                    <span>Welcome, <strong id="userName"></strong></span>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <div class="container">
            <div id="ticketsView">
                <div class="welcome-section">
                    <h1>Support Center</h1>
                    <p>View your tickets or start a new conversation with X-ORBIT support</p>
                </div>

                <div class="my-tickets-section">
                    <h2>
                        <span>My Support Tickets</span>
                        <button class="new-ticket-btn" onclick="openNewTicketModal()">
                            <i class="fas fa-plus"></i> New Ticket
                        </button>
                    </h2>
                    <div class="ticket-list" id="ticketList">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>Loading your tickets...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chatView">
                <div class="chat-header">
                    <div>
                        <h3 id="chatTicketNumber"></h3>
                        <span id="chatTicketStatus"></span>
                    </div>
                    <button class="back-btn" onclick="backToTickets()">
                        <i class="fas fa-arrow-left"></i> Back to Tickets
                    </button>
                </div>

                <div id="ticketClosedMessage" style="display: none;" class="ticket-closed-state">
                    <div class="ticket-closed-modal" id="closedModalContent">
                        <div class="ticket-info-badge" id="ticketBadge">
                            <i class="fas fa-ticket-alt"></i>
                            <span id="modalTicketNumber"></span>
                        </div>
                        <i class="fas fa-check-circle status-icon" id="closedIcon"></i>
                        <h2 id="closedTitle">Ticket Resolved</h2>
                        <p id="closedMessage">
                            This ticket has been marked as resolved. If you're still experiencing issues, you can reopen it below.
                        </p>
                        <div class="ticket-closed-actions">
                            <button class="reopen-btn" onclick="reopenTicket()">
                                <i class="fas fa-arrow-rotate-left"></i>
                                Reopen Ticket
                            </button>
                            <button class="delete-btn" onclick="confirmDeleteTicket()">
                                <i class="fas fa-trash-can"></i>
                                Delete Ticket
                            </button>
                        </div>
                    </div>
                </div>

                <div id="chatMessagesArea" style="display: flex; flex-direction: column; flex: 1;">
                    <div class="messages-container" id="messagesContainer"></div>

                    <div class="message-input-area">
                        <div class="message-input-container">
                            <textarea 
                                id="messageInput" 
                                class="message-input" 
                                placeholder="Type your message..." 
                                rows="3"
                                onkeydown="handleMessageKeydown(event)"
                            ></textarea>
                            <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="newTicketModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeNewTicketModal()">
                <i class="fas fa-times"></i>
            </button>
            <h2>Create New Ticket</h2>
            <div class="success-message" id="ticketSuccess"></div>
            <div class="error-message" id="ticketError"></div>
            <form onsubmit="createNewTicket(event)" id="newTicketForm">
                <div class="form-group">
                    <label for="ticketCategory">Category</label>
                    <select id="ticketCategory" required>
                        <option value="">Select a category...</option>
                        <option value="technical">Technical Issue</option>
                        <option value="account">Account Problem</option>
                        <option value="billing">Billing Question</option>
                        <option value="feature">Feature Request</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ticketSubject">Subject</label>
                    <input type="text" id="ticketSubject" required placeholder="Brief description">
                </div>
                <div class="form-group">
                    <label for="ticketMessage">Message</label>
                    <textarea id="ticketMessage" required placeholder="Describe your issue..."></textarea>
                </div>
                <button type="submit" class="login-btn" id="createTicketBtn">Create Ticket</button>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://rujvmtvozorylfzsqppc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1anZtdHZvem9yeWxmenNxcHBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjQxNDEsImV4cCI6MjA3MzA0MDE0MX0.b7jJz3Se_oXXDwwd0dWQ8-rEvhY0aU4JDHQVioE39iY';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentTicket = null;
        let userTickets = [];
        let messagesSubscription = null;
        let isGuest = false;

        window.addEventListener('load', async () => {
            const savedUser = localStorage.getItem('xorbit_support_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                isGuest = currentUser.isGuest || false;
                await showDashboard();
            }
        });

        function showLoginOptions() {
            document.getElementById('loginOptions').style.display = 'block';
            document.getElementById('clientLoginForm').style.display = 'none';
            document.getElementById('guestServicesForm').style.display = 'none';
            document.getElementById('guestLoginForm').style.display = 'none';
        }

        function showClientLogin() {
            document.getElementById('loginOptions').style.display = 'none';
            document.getElementById('clientLoginForm').style.display = 'block';
        }

        function showGuestServices() {
            document.getElementById('loginOptions').style.display = 'none';
            document.getElementById('guestServicesForm').style.display = 'block';
        }

        function showGuestLogin() {
            document.getElementById('loginOptions').style.display = 'none';
            document.getElementById('guestLoginForm').style.display = 'block';
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorMsg = document.getElementById('loginError');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            errorMsg.classList.remove('show');

            try {
                const { data, error } = await supabaseClient
                    .from('clients')
                    .select('*')
                    .eq('email', username)
                    .eq('password', password)
                    .single();

                if (error || !data) {
                    throw new Error('Invalid email or password');
                }

                currentUser = {
                    id: data.id,
                    username: data.email,
                    name: data.name,
                    email: data.email,
                    phone: data.phone,
                    blocked: data.blocked,
                    isGuest: false
                };
                
                localStorage.setItem('xorbit_support_user', JSON.stringify(currentUser));
                isGuest = false;
                await showDashboard();

            } catch (error) {
                console.error('Login error:', error);
                errorMsg.textContent = error.message || 'Login failed.';
                errorMsg.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        }

        // Profanity and inappropriate name filter
        function containsInappropriateContent(text) {
            // List of blocked words/phrases (you can add more)
            const blockedWords = [
                // System/Staff names
                'admin', 'administrator', 'moderator', 'support', 'staff',
                'xorbit', 'system', 'bot', 'test', 'demitri', 'dmitri', 'demetri',
                
                // Profanity
                'fuck', 'fucking', 'fucker', 'fck', 'fuk',
                'shit', 'shit', 'crap',
                'ass', 'asshole', 'arse',
                'bitch', 'bastard',
                'damn', 'dammit',
                'hell',
                'piss', 'pissed',
                'cock', 'dick', 'penis',
                'pussy', 'vagina', 'cunt',
                'motherfucker', 'mofo',
                'whore', 'slut',
                'nigger', 'nigga', 'faggot', 'fag',
                'retard', 'retarded',
                'sex', 'sexy', 'porn', 'xxx',
                'kill', 'die', 'death', 'suicide',
                'nazi', 'hitler'
                // Add more words as needed
            ];
            
            const lowerText = text.toLowerCase();
            
            // Check for exact matches and partial matches
            for (const word of blockedWords) {
                if (lowerText.includes(word)) {
                    return true;
                }
            }
            
            return false;
        }

        async function handleGuestServices(event) {
            event.preventDefault();
            
            // Check if a guest account has already been created on this device
            const hasGuestAccount = localStorage.getItem('xorbit_guest_account_created');
            const errorMsg = document.getElementById('guestError');
            
            if (hasGuestAccount === 'true') {
                errorMsg.textContent = 'You have already created a guest account. Only one guest account is allowed per device. Please use "Returning Guest" to log in.';
                errorMsg.classList.add('show');
                return;
            }
            
            const firstName = document.getElementById('guestFirstName').value.trim();
            const lastName = document.getElementById('guestLastName').value.trim();
            const email = document.getElementById('guestEmail').value.trim();
            const guestBtn = document.getElementById('guestBtn');

            // Check for inappropriate content in names
            if (containsInappropriateContent(firstName) || containsInappropriateContent(lastName)) {
                errorMsg.textContent = 'Please use appropriate language in your name.';
                errorMsg.classList.add('show');
                return;
            }

            guestBtn.disabled = true;
            guestBtn.textContent = 'Processing...';
            errorMsg.classList.remove('show');

            try {
                let { data: existingGuest } = await supabaseClient
                    .from('guest_users')
                    .select('*')
                    .eq('email', email)
                    .single();

                let guestUser;

                if (existingGuest) {
                    const { data, error } = await supabaseClient
                        .from('guest_users')
                        .update({
                            first_name: firstName,
                            last_name: lastName,
                            last_login: new Date().toISOString()
                        })
                        .eq('id', existingGuest.id)
                        .select()
                        .single();

                    if (error) throw error;
                    guestUser = data;
                } else {
                    const { data, error } = await supabaseClient
                        .from('guest_users')
                        .insert([{
                            first_name: firstName,
                            last_name: lastName,
                            email: email
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    guestUser = data;
                    
                    // Mark that a guest account has been created on this device
                    localStorage.setItem('xorbit_guest_account_created', 'true');
                }

                currentUser = {
                    id: guestUser.id,
                    username: email,
                    name: `${firstName} ${lastName}`,
                    email: email,
                    isGuest: true
                };

                localStorage.setItem('xorbit_support_user', JSON.stringify(currentUser));
                isGuest = true;
                await showDashboard();

            } catch (error) {
                console.error('Guest services error:', error);
                errorMsg.textContent = 'An error occurred. Please try again.';
                errorMsg.classList.add('show');
            } finally {
                guestBtn.disabled = false;
                guestBtn.textContent = 'Continue to Support';
            }
        }

        async function handleGuestLogin(event) {
            event.preventDefault();
            const firstName = document.getElementById('guestLoginFirstName').value.trim();
            const lastName = document.getElementById('guestLoginLastName').value.trim();
            const email = document.getElementById('guestLoginEmail').value.trim();
            const guestLoginBtn = document.getElementById('guestLoginBtn');
            const errorMsg = document.getElementById('guestLoginError');

            // Check for inappropriate content in names
            if (containsInappropriateContent(firstName) || containsInappropriateContent(lastName)) {
                errorMsg.textContent = 'Please use appropriate language in your name.';
                errorMsg.classList.add('show');
                return;
            }

            guestLoginBtn.disabled = true;
            guestLoginBtn.textContent = 'Accessing...';
            errorMsg.classList.remove('show');

            try {
                const { data, error } = await supabaseClient
                    .from('guest_users')
                    .select('*')
                    .eq('email', email)
                    .eq('first_name', firstName)
                    .eq('last_name', lastName)
                    .single();

                if (error || !data) {
                    throw new Error('No account found with those details. Please check your information or use Account Services.');
                }

                await supabaseClient
                    .from('guest_users')
                    .update({ last_login: new Date().toISOString() })
                    .eq('id', data.id);

                currentUser = {
                    id: data.id,
                    username: email,
                    name: `${firstName} ${lastName}`,
                    email: email,
                    isGuest: true
                };

                localStorage.setItem('xorbit_support_user', JSON.stringify(currentUser));
                isGuest = true;
                await showDashboard();

            } catch (error) {
                console.error('Guest login error:', error);
                errorMsg.textContent = error.message || 'Login failed.';
                errorMsg.classList.add('show');
            } finally {
                guestLoginBtn.disabled = false;
                guestLoginBtn.textContent = 'Access Support';
            }
        }

        async function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('supportDashboard').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name;
            await loadUserTickets();
        }

        function logout() {
            localStorage.removeItem('xorbit_support_user');
            currentUser = null;
            currentTicket = null;
            
            if (messagesSubscription) {
                messagesSubscription.unsubscribe();
            }

            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('supportDashboard').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('ticketsView').style.display = 'block';
            document.getElementById('chatView').style.display = 'none';
        }

        async function loadUserTickets() {
            try {
                const { data, error } = await supabaseClient
                    .from('support_tickets')
                    .select('*')
                    .eq('email', currentUser.email)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                userTickets = data || [];
                displayTickets();
            } catch (error) {
                console.error('Error loading tickets:', error);
            }
        }

        function displayTickets() {
            const container = document.getElementById('ticketList');
            
            if (userTickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>You don't have any support tickets yet.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = userTickets.map(ticket => `
                <div class="ticket-card" onclick="openTicket('${ticket.id}')">
                    <div class="ticket-header">
                        <span class="ticket-number">${ticket.ticket_number}</span>
                        <span class="ticket-status status-${ticket.status}">${ticket.status.replace('_', ' ')}</span>
                    </div>
                    <div class="ticket-subject">${ticket.subject || 'No Subject'}</div>
                    <div class="ticket-preview">${ticket.message.substring(0, 100)}...</div>
                    <div class="ticket-meta">
                        <span><i class="fas fa-tag"></i> ${ticket.category}</span>
                        <span><i class="fas fa-clock"></i> ${formatTime(ticket.created_at)}</span>
                    </div>
                </div>
            `).join('');
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        async function openTicket(ticketId) {
            const ticket = userTickets.find(t => t.id === ticketId);
            if (!ticket) return;

            currentTicket = ticket;
            document.getElementById('ticketsView').style.display = 'none';
            document.getElementById('chatView').style.display = 'flex';
            document.getElementById('chatTicketNumber').textContent = ticket.ticket_number;
            document.getElementById('chatTicketStatus').textContent = ticket.status.replace('_', ' ').toUpperCase();
            document.getElementById('chatTicketStatus').className = `ticket-status status-${ticket.status}`;

            if (ticket.status === 'resolved' || ticket.status === 'closed') {
                document.getElementById('ticketClosedMessage').style.display = 'flex';
                document.getElementById('chatMessagesArea').style.display = 'none';
                
                document.getElementById('modalTicketNumber').textContent = ticket.ticket_number;
                const modalContent = document.getElementById('closedModalContent');
                const icon = document.getElementById('closedIcon');
                
                if (ticket.status === 'resolved') {
                    modalContent.classList.remove('closed-status');
                    icon.className = 'fas fa-check-circle status-icon';
                    document.getElementById('closedTitle').textContent = 'Ticket Resolved';
                    document.getElementById('closedMessage').textContent = 
                        'This ticket has been marked as resolved. If you\'re still experiencing issues, you can reopen it below.';
                } else {
                    modalContent.classList.add('closed-status');
                    icon.className = 'fas fa-lock status-icon';
                    document.getElementById('closedTitle').textContent = 'Ticket Closed';
                    document.getElementById('closedMessage').textContent = 
                        'This ticket has been closed. You can reopen it to continue the conversation or delete it.';
                }
            } else {
                document.getElementById('ticketClosedMessage').style.display = 'none';
                document.getElementById('chatMessagesArea').style.display = 'flex';
                await loadMessages(ticketId);
                subscribeToMessages(ticketId);
            }
        }

        function backToTickets() {
            document.getElementById('chatView').style.display = 'none';
            document.getElementById('ticketsView').style.display = 'block';
            currentTicket = null;

            if (messagesSubscription) {
                messagesSubscription.unsubscribe();
                messagesSubscription = null;
            }

            loadUserTickets();
        }

        async function loadMessages(ticketId) {
            try {
                const { data: conversation, error: convError } = await supabaseClient
                    .from('conversations')
                    .select('id')
                    .eq('ticket_id', ticketId)
                    .single();

                if (convError) {
                    console.error('Conversation error:', convError);
                    throw convError;
                }

                console.log('Found conversation:', conversation);

                const { data: messages, error: msgError } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .eq('conversation_id', conversation.id)
                    .order('created_at', { ascending: true });

                if (msgError) {
                    console.error('Messages error:', msgError);
                    throw msgError;
                }
                
                console.log('Messages loaded:', messages);
                displayMessages(messages || []);
            } catch (error) {
                console.error('Error loading messages:', error);
                const container = document.getElementById('messagesContainer');
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading messages. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                if (msg.sender_email === 'system@xorbit.org') {
                    return `
                        <div class="message system">
                            <div class="message-bubble">
                                ⚠️ ${escapeHtml(msg.message)}
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="message ${msg.is_staff ? 'staff' : 'user'}">
                        <div class="message-header">${escapeHtml(msg.sender_name)}</div>
                        <div class="message-bubble">${escapeHtml(msg.message)}</div>
                        <div class="message-time">${formatTime(msg.created_at)}</div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function subscribeToMessages(ticketId) {
            if (messagesSubscription) {
                messagesSubscription.unsubscribe();
            }

            supabaseClient.from('conversations').select('id').eq('ticket_id', ticketId).single()
                .then(({ data: conversation }) => {
                    if (conversation) {
                        messagesSubscription = supabaseClient.channel('messages')
                            .on('postgres_changes', {
                                event: 'INSERT',
                                schema: 'public',
                                table: 'messages',
                                filter: `conversation_id=eq.${conversation.id}`
                            }, () => loadMessages(ticketId))
                            .subscribe();
                    }
                });
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentTicket) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            try {
                const { data: conversation } = await supabaseClient.from('conversations')
                    .select('id').eq('ticket_id', currentTicket.id).single();

                await supabaseClient.from('messages').insert([{
                    conversation_id: conversation.id,
                    sender_name: currentUser.name,
                    sender_email: currentUser.email,
                    is_staff: false,
                    message: message
                }]);

                messageInput.value = '';
                await loadMessages(currentTicket.id);
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            } finally {
                sendBtn.disabled = false;
            }
        }

        function handleMessageKeydown(event) {
            if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
                event.preventDefault();
                sendMessage();
            }
        }

        function openNewTicketModal() {
            document.getElementById('newTicketModal').classList.add('active');
            document.getElementById('newTicketForm').reset();
            document.getElementById('ticketSuccess').classList.remove('show');
            document.getElementById('ticketError').classList.remove('show');
        }

        function closeNewTicketModal() {
            document.getElementById('newTicketModal').classList.remove('active');
        }

        async function createNewTicket(event) {
            event.preventDefault();
            
            const category = document.getElementById('ticketCategory').value;
            const subject = document.getElementById('ticketSubject').value;
            const message = document.getElementById('ticketMessage').value;
            const createBtn = document.getElementById('createTicketBtn');
            const successMsg = document.getElementById('ticketSuccess');
            const errorMsg = document.getElementById('ticketError');

            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';
            errorMsg.classList.remove('show');
            successMsg.classList.remove('show');

            try {
                const ticketData = {
                    name: currentUser.name,
                    email: currentUser.email,
                    category: category,
                    subject: subject,
                    message: message,
                    is_guest: isGuest
                };

                if (isGuest && currentUser.id) {
                    ticketData.guest_user_id = currentUser.id;
                }

                const { data: ticketResult, error: ticketError } = await supabaseClient
                    .from('support_tickets')
                    .insert([ticketData])
                    .select()
                    .single();

                if (ticketError) {
                    console.error('Ticket creation error:', ticketError);
                    throw ticketError;
                }

                await new Promise(resolve => setTimeout(resolve, 500));

                const { data: conversation, error: convError } = await supabaseClient
                    .from('conversations')
                    .select('id')
                    .eq('ticket_id', ticketResult.id)
                    .single();

                if (convError) throw convError;

                await supabaseClient.from('messages').insert([{
                    conversation_id: conversation.id,
                    sender_name: currentUser.name,
                    sender_email: currentUser.email,
                    is_staff: false,
                    message: message
                }]);

                await supabaseClient.from('messages').insert([{
                    conversation_id: conversation.id,
                    sender_name: 'X-ORBIT Support System',
                    sender_email: 'system@xorbit.org',
                    is_staff: false,
                    message: 'NOTICE: This inbox is checked daily. The X-ORBIT team will respond shortly. Tickets may not be handled immediately. To help us assist you better, please provide a detailed explanation of your issue including any error messages, screenshots, or steps to reproduce the problem.'
                }]);

                successMsg.textContent = `Ticket ${ticketResult.ticket_number} created successfully!`;
                successMsg.classList.add('show');
                
                await loadUserTickets();
                
                setTimeout(() => {
                    closeNewTicketModal();
                    openTicket(ticketResult.id);
                }, 1500);

            } catch (error) {
                console.error('Error creating ticket:', error);
                errorMsg.textContent = 'Failed to create ticket. Please try again.';
                errorMsg.classList.add('show');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'Create Ticket';
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('newTicketModal');
            if (event.target === modal) {
                closeNewTicketModal();
            }
        }

        async function reopenTicket() {
            if (!currentTicket) return;

            const confirmReopen = confirm('Are you sure you want to reopen this ticket?');
            if (!confirmReopen) return;

            try {
                const { error } = await supabaseClient
                    .from('support_tickets')
                    .update({ status: 'open' })
                    .eq('id', currentTicket.id);

                if (error) throw error;

                await loadUserTickets();
                currentTicket.status = 'open';
                
                document.getElementById('ticketClosedMessage').style.display = 'none';
                document.getElementById('chatMessagesArea').style.display = 'flex';
                document.getElementById('chatTicketStatus').textContent = 'OPEN';
                document.getElementById('chatTicketStatus').className = 'ticket-status status-open';
                
                await loadMessages(currentTicket.id);
                subscribeToMessages(currentTicket.id);

                alert('Ticket has been reopened!');
            } catch (error) {
                console.error('Error reopening ticket:', error);
                alert('Failed to reopen ticket. Please try again.');
            }
        }

        async function confirmDeleteTicket() {
            if (!currentTicket) return;

            const confirmDelete = confirm(
                'Are you sure you want to delete this ticket?\n\n' +
                'This action cannot be undone and all conversation history will be permanently deleted.'
            );
            
            if (!confirmDelete) return;

            try {
                const { error } = await supabaseClient
                    .from('support_tickets')
                    .delete()
                    .eq('id', currentTicket.id);

                if (error) throw error;

                alert('Ticket deleted successfully.');
                backToTickets();
            } catch (error) {
                console.error('Error deleting ticket:', error);
                alert('Failed to delete ticket. Please try again or contact support.');
            }
        }

        setInterval(() => {
            if (currentUser && !currentTicket) {
                loadUserTickets();
            }
        }, 30000);

        setInterval(() => {
            if (currentUser && currentTicket) {
                loadMessages(currentTicket.id);
            }
        }, 15000);
    </script>
</body>
</html>
