<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="https://codehs.com/uploads/7f204d91a682cb833441eb2fc59228b6" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>X-ORBIT Desktop</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Theme stylesheet will be loaded dynamically -->
  <link id="theme-stylesheet" rel="stylesheet" href="theme-dark.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: radial-gradient(ellipse at top, #1a0033 0%, #0d001a 50%, #000014 100%);
      background-attachment: fixed;
      color: #f8faff;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
      cursor: default;
      user-select: none;
      margin: 0;
      padding: 0;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(120, 40, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(60, 130, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(180, 40, 255, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: '\f57d'; /* Font Awesome globe icon */
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 25rem;
      color: rgba(120, 80, 255, 0.08);
      pointer-events: none;
      z-index: 0;
      text-shadow: 
        0 0 100px rgba(120, 80, 255, 0.3),
        0 0 200px rgba(120, 80, 255, 0.2);
    }

    /* Halloween Theme - Pumpkin */
    body.halloween-theme::after {
      content: 'üéÉ';
      font-family: 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
      font-weight: normal;
      font-size: 30rem;
      color: transparent;
      text-shadow: none;
      filter: drop-shadow(0 0 100px rgba(255, 140, 0, 0.4))
              drop-shadow(0 0 200px rgba(255, 140, 0, 0.3));
    }

    .menu-bar {
      height: 32px;
      background: rgba(15, 15, 35, 0.6);
      backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
      -webkit-backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
      display: flex;
      align-items: center;
      padding: 0 16px;
      font-size: 0.85rem;
      font-weight: 500;
      color: #e8f0ff;
      border-bottom: 1px solid rgba(120, 80, 255, 0.2);
      box-shadow: 
        0 1px 0 0 rgba(255, 255, 255, 0.1) inset,
        0 4px 16px rgba(0, 0, 0, 0.4);
      position: relative;
      z-index: 1000;
      justify-content: space-between;
    }

    .menu-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .menu-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.8rem;
    }

    .menu-item {
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .menu-item:hover {
      background: rgba(120, 80, 255, 0.2);
    }

    .desktop {
  flex: 1;
  position: relative;
  overflow: hidden;
  background: transparent;
  width: 100%;
  height: 100vh;
}

.desktop-icons {
  position: absolute;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  z-index: 10;
}

.desktop-icon {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 12px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 80px;
  text-align: center;
}

.desktop-icon:hover {
  background: rgba(120, 80, 255, 0.2);
  transform: scale(1.05);
  box-shadow: 0 8px 32px rgba(120, 80, 255, 0.3);
}

.desktop-icon:active {
  transform: scale(0.95);
}

.desktop-icon i {
  font-size: 2rem;
  color: #d0d8ff;
  filter: drop-shadow(0 2px 8px rgba(120, 80, 255, 0.3));
  transition: all 0.3s ease;
}

.desktop-icon:hover i {
  color: #ffffff;
  filter: drop-shadow(0 4px 12px rgba(120, 80, 255, 0.5));
}

.desktop-icon span {
  font-size: 0.75rem;
  color: #e8f0ff;
  font-weight: 500;
  max-width: 100%;
  word-wrap: break-word;
  transition: all 0.3s ease;
}

.desktop-icon:hover span {
  color: #ffffff;
}
    .window {
      position: absolute;
      min-width: 400px;
      min-height: 300px;
      max-width: calc(100vw - 40px) !important;
      max-height: calc(100vh - 112px) !important;
      background: rgba(20, 15, 40, 0.4);
      backdrop-filter: blur(40px) saturate(1.8) brightness(1.1);
      -webkit-backdrop-filter: blur(40px) saturate(1.8) brightness(1.1);
      border-radius: 16px;
      box-shadow: 
        0 0 60px rgba(120, 80, 255, 0.2),
        0 20px 40px rgba(0, 0, 0, 0.4),
        0 1px 0 rgba(255, 255, 255, 0.15) inset;
      border: 1px solid rgba(120, 80, 255, 0.15);
      display: flex;
      flex-direction: column;
      z-index: 100;
      resize: both;
      overflow: hidden;
      opacity: 0;
      transform: translateY(20px) scale(0.95);
      transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .window.window-visible {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .window.active {
      z-index: 200;
      box-shadow: 
        0 0 80px rgba(120, 80, 255, 0.3),
        0 25px 50px rgba(0, 0, 0, 0.5),
        0 1px 0 rgba(255, 255, 255, 0.2) inset;
    }

    .window.fullscreen {
      position: fixed !important;
      top: 32px !important;
      left: 0 !important;
      min-width: 100vw;
      min-height: calc(100vh - 32px);
      resize: none;
      border-radius: 0 !important;
      border-top: none !important;
      margin-top: 0 !important;
    }

    .window.fullscreen .window-titlebar {
      border-radius: 0 !important;
    }

    .window.fullscreen .window-content {
      border-radius: 0 !important;
    }

    .window-titlebar {
      height: 44px;
      background: rgba(30, 25, 50, 0.6);
      backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-radius: 16px 16px 0 0;
      border-bottom: 1px solid rgba(120, 80, 255, 0.1);
      cursor: move;
      user-select: none;
    }

    .window-controls {
      display: flex;
      gap: 8px;
      margin-right: 16px;
    }

    .window-control {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .window-control.close {
      background: #ff5f57;
    }

    .window-control.minimize {
      background: #ffbd2e;
    }

    .window-control.maximize {
      background: #28ca42;
    }

    .window-control:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .window-title {
      font-size: 0.9rem;
      font-weight: 500;
      color: #e8f0ff;
      flex: 1;
    }

    .window-content {
      flex: 1;
      background: rgba(10, 10, 25, 0.3);
      border-radius: 0 0 16px 16px;
      overflow: hidden;
    }

    .window-content iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: transparent;
    }

    .dock {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20, 15, 40, 0.5);
      backdrop-filter: blur(60px) saturate(2) brightness(1.3);
      -webkit-backdrop-filter: blur(60px) saturate(2) brightness(1.3);
      border-radius: 24px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 
        0 0 60px rgba(120, 80, 255, 0.3),
        0 20px 40px rgba(0, 0, 0, 0.4),
        0 1px 0 rgba(255, 255, 255, 0.2) inset;
      border: 1px solid rgba(120, 80, 255, 0.2);
      z-index: 1000;
    }

    .dock-item {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      background: rgba(120, 80, 255, 0.1);
      border: 1px solid rgba(120, 80, 255, 0.2);
    }

    .dock-item:hover {
      transform: translateY(-8px) scale(1.15);
      box-shadow: 
        0 0 30px rgba(120, 80, 255, 0.4),
        0 12px 24px rgba(0, 0, 0, 0.4);
      background: rgba(120, 80, 255, 0.2);
    }

    .dock-item.active::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      background: rgba(120, 80, 255, 0.8);
      border-radius: 50%;
      box-shadow: 0 0 12px rgba(120, 80, 255, 0.6);
    }

    .dock-item i {
      font-size: 1.5rem;
      color: #d0d8ff;
      z-index: 1;
      position: relative;
    }

    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: rgba(30, 25, 50, 0.9);
      backdrop-filter: blur(20px);
      color: #e8f0ff;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      border: 1px solid rgba(120, 80, 255, 0.2);
      z-index: 10002;
      margin-bottom: 8px;
    }

    .dock-item:hover .tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(-8px);
    }

    /* Startup Screen */
    #startupScreen {
      position: fixed;
      z-index: 10000;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: radial-gradient(ellipse at center, #1a0033 0%, #0d001a 50%, #000014 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.8s ease;
    }

    #startupScreen.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .startup-content {
      text-align: center;
      animation: startupFadeIn 1s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .startup-icon {
      font-size: 5rem;
      color: #7d5cff;
      margin-bottom: 24px;
      display: block;
      animation: startupPulse 2s ease-in-out infinite, startupRotate 20s linear infinite;
      text-shadow: 
        0 0 30px rgba(120, 80, 255, 0.6),
        0 0 60px rgba(120, 80, 255, 0.4);
    }

    .startup-text {
      font-size: 2.5rem;
      font-weight: 700;
      color: #e8f0ff;
      margin-bottom: 8px;
      letter-spacing: 4px;
      text-shadow: 0 0 20px rgba(120, 80, 255, 0.5);
    }

    .startup-version {
      font-size: 1rem;
      color: #a8b4d9;
      margin-bottom: 40px;
      letter-spacing: 2px;
    }

    .startup-progress-container {
      width: 300px;
      height: 4px;
      background: rgba(120, 80, 255, 0.2);
      border-radius: 2px;
      margin: 0 auto 16px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(120, 80, 255, 0.3) inset;
    }

    .startup-progress-bar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #7d5cff 0%, #3c82ff 100%);
      border-radius: 2px;
      transition: width 0.3s ease;
      box-shadow: 
        0 0 20px rgba(120, 80, 255, 0.8),
        0 0 40px rgba(120, 80, 255, 0.4);
      animation: progressGlow 1.5s ease-in-out infinite;
    }

    .startup-status {
      font-size: 0.9rem;
      color: #a8b4d9;
      margin-top: 16px;
      animation: statusBlink 1.5s ease-in-out infinite;
    }

    .startup-continue-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: rgba(120, 80, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 3px solid rgba(120, 80, 255, 0.4);
      color: #e8f0ff;
      font-size: 1.8rem;
      cursor: pointer;
      margin-top: 32px;
      align-self: center;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 
        0 0 30px rgba(120, 80, 255, 0.3),
        0 8px 20px rgba(0, 0, 0, 0.2);
      animation: continueButtonPulse 2s ease-in-out infinite;
    }

    .startup-continue-btn:hover {
      transform: scale(1.15);
      background: rgba(120, 80, 255, 0.2);
      border-color: rgba(120, 80, 255, 0.7);
      box-shadow: 
        0 0 50px rgba(120, 80, 255, 0.6),
        0 12px 30px rgba(0, 0, 0, 0.3);
    }

    .startup-continue-btn:active {
      transform: scale(1.05);
    }

    @keyframes continueButtonPulse {
      0%, 100% {
        box-shadow: 
          0 0 30px rgba(120, 80, 255, 0.3),
          0 8px 20px rgba(0, 0, 0, 0.2);
        border-color: rgba(120, 80, 255, 0.4);
      }
      50% {
        box-shadow: 
          0 0 50px rgba(120, 80, 255, 0.5),
          0 12px 25px rgba(0, 0, 0, 0.3);
        border-color: rgba(120, 80, 255, 0.7);
      }
    }

    .fullscreen-prompt {
      margin-top: 32px;
      padding: 14px 28px;
      background: linear-gradient(135deg, rgba(120, 80, 255, 0.3) 0%, rgba(60, 130, 255, 0.3) 100%);
      border: 2px solid rgba(120, 80, 255, 0.5);
      border-radius: 12px;
      color: #e8f0ff;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      animation: pulseGlow 2s ease-in-out infinite;
    }

    .fullscreen-prompt:hover {
      background: linear-gradient(135deg, rgba(120, 80, 255, 0.5) 0%, rgba(60, 130, 255, 0.5) 100%);
      border-color: rgba(120, 80, 255, 0.8);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(120, 80, 255, 0.4);
    }

    .fullscreen-prompt i {
      font-size: 1.1rem;
    }

    @keyframes pulseGlow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(120, 80, 255, 0.3);
      }
      50% {
        box-shadow: 0 0 30px rgba(120, 80, 255, 0.6);
      }
    }

    @keyframes startupFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes startupPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    @keyframes startupRotate {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes progressGlow {
      0%, 100% {
        box-shadow: 
          0 0 20px rgba(120, 80, 255, 0.8),
          0 0 40px rgba(120, 80, 255, 0.4);
      }
      50% {
        box-shadow: 
          0 0 30px rgba(120, 80, 255, 1),
          0 0 60px rgba(120, 80, 255, 0.6);
      }
    }

    @keyframes statusBlink {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    #welcomeOverlay {
      position: fixed;
      z-index: 9999;
      top: 0; 
      left: 0;
      height: 100vh; 
      width: 100vw;
      background: rgba(10, 5, 25, 0.9);
      backdrop-filter: blur(60px) saturate(2);
      -webkit-backdrop-filter: blur(60px) saturate(2);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.8s ease;
    }

    #welcomeOverlay.fade-in {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .desktop-icons {
        position: static;
        flex-direction: row;
        flex-wrap: wrap;
        margin: 20px;
        gap: 12px;
      }
      
      .dock {
        bottom: 8px;
        padding: 8px 12px;
        gap: 8px;
      }
      
      .dock-item {
        width: 48px;
        height: 48px;
      }
      
      .window {
        min-width: 280px;
        min-height: 200px;
      }
    }

    @keyframes windowOpen {
      0% {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .window-opening {
      animation: windowOpen 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    /* Light mode styles */
    body.light-mode {
      background: linear-gradient(135deg, #f8faff 0%, #e8f0ff 100%);
      color: #1a1a2e;
    }

    body.light-mode::after {
      color: rgba(120, 80, 255, 0.12);
      text-shadow: 
        0 0 100px rgba(120, 80, 255, 0.2),
        0 0 200px rgba(120, 80, 255, 0.1);
    }

    body.light-mode::before {
      background: 
        radial-gradient(circle at 20% 50%, rgba(120, 80, 255, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(60, 130, 255, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(180, 40, 255, 0.06) 0%, transparent 50%);
    }

    body.light-mode .menu-bar {
      background: rgba(248, 250, 255, 0.8);
      color: #1a1a2e;
      border-bottom: 1px solid rgba(120, 80, 255, 0.3);
    }

    body.light-mode .window {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(120, 80, 255, 0.2);
      color: #1a1a2e;
    }

    body.light-mode .window-titlebar {
      background: rgba(248, 250, 255, 0.9);
      border-bottom: 1px solid rgba(120, 80, 255, 0.2);
    }

    body.light-mode .window-title {
      color: #1a1a2e;
    }

    body.light-mode .dock {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(120, 80, 255, 0.3);
    }

    body.light-mode .dock-item {
      background: rgba(120, 80, 255, 0.08);
      border: 1px solid rgba(120, 80, 255, 0.15);
    }

    body.light-mode .desktop-icon {
      color: #1a1a2e;
    }

    body.light-mode .desktop-icon i {
      color: #3c4560;
    }

    /* No transparency mode */
    body.no-transparency .window,
    body.no-transparency .dock,
    body.no-transparency .menu-bar {
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }

    body.no-transparency .window {
      background: rgba(20, 15, 40, 0.95) !important;
    }

    body.no-transparency.light-mode .window {
      background: rgba(255, 255, 255, 0.95) !important;
    }

    /* No animations mode */
    body.no-animations * {
      transition: none !important;
      animation: none !important;
    }

    /* Dock auto-hide styles */
    .dock.dock-autohide {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      pointer-events: none;
    }

    /* Hide dock based on position */
    .dock.dock-autohide[style*="bottom"] {
      transform: translateX(-50%) translateY(calc(100% + 20px));
    }

    .dock.dock-autohide[style*="top"] {
      transform: translateX(-50%) translateY(calc(-100% - 20px));
    }

    .dock.dock-autohide[style*="left"][style*="column"] {
      transform: translateY(-50%) translateX(calc(-100% - 20px));
    }

    .dock.dock-autohide[style*="right"][style*="column"] {
      transform: translateY(-50%) translateX(calc(100% + 20px));
    }

    /* Show dock when visible */
    .dock.dock-autohide.dock-visible {
      opacity: 1;
      pointer-events: auto;
    }

    .dock.dock-autohide.dock-visible[style*="bottom"] {
      transform: translateX(-50%) translateY(0);
    }

    .dock.dock-autohide.dock-visible[style*="top"] {
      transform: translateX(-50%) translateY(0);
    }

    .dock.dock-autohide.dock-visible[style*="left"][style*="column"] {
      transform: translateY(-50%) translateX(0);
    }

    .dock.dock-autohide.dock-visible[style*="right"][style*="column"] {
      transform: translateY(-50%) translateX(0);
    }

    /* X-ORBIT Menu Dropdown */
    .xorbit-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: rgba(20, 15, 40, 0.9);
      backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
      -webkit-backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
      border-radius: 12px;
      border: 1px solid rgba(120, 80, 255, 0.2);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
      min-width: 220px;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      z-index: 10001;
      margin-top: 8px;
    }

    .xorbit-menu.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .xorbit-menu-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 8px;
      margin: 6px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.9rem;
      font-weight: 500;
      color: #e8f0ff;
    }

    .xorbit-menu-item:first-child {
      margin-top: 6px;
    }

    .xorbit-menu-item:last-child {
      margin-bottom: 6px;
    }

    .xorbit-menu-item:hover {
      background: rgba(120, 80, 255, 0.2);
      color: #ffffff;
      transform: translateX(2px);
    }

    .xorbit-menu-item i {
      width: 16px;
      text-align: center;
      color: #a8b4d9;
    }

    .xorbit-menu-item:hover i {
      color: #7d5cff;
    }

    .xorbit-menu-divider {
      height: 1px;
      background: rgba(120, 80, 255, 0.2);
      margin: 6px 12px;
    }

    .xorbit-menu-item.danger {
      color: #ff6b6b;
    }

    .xorbit-menu-item.danger:hover {
      background: rgba(255, 107, 107, 0.2);
      color: #ff8a8a;
    }

    .xorbit-menu-item.danger i {
      color: #ff6b6b;
    }

    .menu-item.xorbit-title {
      position: relative;
    }

    /* Light mode menu */
    body.light-mode .xorbit-menu {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(120, 80, 255, 0.3);
    }

    body.light-mode .xorbit-menu-item {
      color: #1a1a2e;
    }

    body.light-mode .xorbit-menu-item:hover {
      background: rgba(120, 80, 255, 0.15);
      color: #000;
    }

    body.light-mode .xorbit-menu-item i {
      color: #64748b;
    }

    body.light-mode .xorbit-menu-item:hover i {
      color: #7d5cff;
    }

    body.light-mode .xorbit-menu-divider {
      background: rgba(120, 80, 255, 0.3);
    }

    /* Time/Weather Dropdown */
    .time-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: rgba(20, 15, 40, 0.9);
      backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
      -webkit-backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
      border-radius: 16px;
      border: 1px solid rgba(120, 80, 255, 0.2);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.1) inset;
      min-width: 320px;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      z-index: 10001;
      margin-top: 8px;
      padding: 20px;
    }

    .time-menu.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .time-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(120, 80, 255, 0.2);
    }

    .time-display {
      font-size: 2rem;
      font-weight: 600;
      color: #e8f0ff;
      margin-bottom: 4px;
      font-family: 'Inter', monospace;
    }

    .date-display {
      font-size: 1rem;
      color: #a8b4d9;
      margin-bottom: 8px;
    }

    .timezone-display {
      font-size: 0.85rem;
      color: #7d5cff;
      font-weight: 500;
    }

    .weather-section {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
      padding: 16px;
      background: rgba(120, 80, 255, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(120, 80, 255, 0.2);
    }

    .weather-icon {
      font-size: 2.5rem;
      width: 60px;
      text-align: center;
    }

    .weather-info {
      flex: 1;
    }

    .weather-temp {
      font-size: 1.5rem;
      font-weight: 600;
      color: #e8f0ff;
      margin-bottom: 2px;
    }

    .weather-desc {
      font-size: 0.9rem;
      color: #a8b4d9;
      margin-bottom: 4px;
    }

    .weather-location {
      font-size: 0.8rem;
      color: #7d5cff;
      font-weight: 500;
    }

    .weather-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .weather-detail {
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(120, 80, 255, 0.1);
      text-align: center;
    }

    .weather-detail-label {
      font-size: 0.75rem;
      color: #a8b4d9;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .weather-detail-value {
      font-size: 0.95rem;
      color: #e8f0ff;
      font-weight: 600;
    }

    .location-section {
      text-align: center;
      padding-top: 12px;
      border-top: 1px solid rgba(120, 80, 255, 0.2);
    }

    .location-text {
      font-size: 0.85rem;
      color: #a8b4d9;
      margin-bottom: 8px;
    }

    .location-update {
      font-size: 0.75rem;
      color: #7d5cff;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .location-update:hover {
      color: #9d7cff;
    }

    .menu-item.time-item {
      position: relative;
      cursor: pointer;
    }

    /* Light mode time menu */
    body.light-mode .time-menu {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(120, 80, 255, 0.3);
    }

    body.light-mode .time-display {
      color: #1a1a2e;
    }

    body.light-mode .weather-temp {
      color: #1a1a2e;
    }

    body.light-mode .weather-detail-value {
      color: #1a1a2e;
    }

    body.light-mode .weather-section {
      background: rgba(120, 80, 255, 0.08);
    }

    body.light-mode .weather-detail {
      background: rgba(120, 80, 255, 0.05);
      border: 1px solid rgba(120, 80, 255, 0.15);
    }

    /* Tutorial/Guide Overlay - Simplified and Fixed */
    .tutorial-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      z-index: 15000;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .tutorial-overlay.show {
      display: flex;
      opacity: 1;
    }

    .tutorial-content {
      background: rgba(20, 15, 40, 0.95);
      backdrop-filter: blur(40px) saturate(1.8);
      -webkit-backdrop-filter: blur(40px) saturate(1.8);
      border-radius: 24px;
      border: 2px solid rgba(120, 80, 255, 0.5);
      box-shadow: 
        0 0 80px rgba(120, 80, 255, 0.4),
        0 30px 60px rgba(0, 0, 0, 0.8),
        0 2px 0 rgba(255, 255, 255, 0.1) inset;
      padding: 40px;
      max-width: 500px;
      width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      transform: scale(0.8) translateY(20px);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
    }

    .tutorial-overlay.show .tutorial-content {
      transform: scale(1) translateY(0);
    }

    .tutorial-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .tutorial-icon {
      font-size: 3rem;
      color: #7d5cff;
      margin-bottom: 16px;
      display: block;
    }

    .tutorial-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #e8f0ff;
      margin-bottom: 8px;
    }

    .tutorial-step {
      font-size: 0.9rem;
      color: #a8b4d9;
      margin-bottom: 16px;
    }

    .tutorial-description {
      color: #e8f0ff;
      line-height: 1.6;
      margin-bottom: 24px;
      font-size: 0.95rem;
    }

    .tutorial-highlight {
      background: rgba(120, 80, 255, 0.2);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(120, 80, 255, 0.3);
      margin-bottom: 24px;
    }

    .tutorial-highlight-title {
      color: #7d5cff;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .tutorial-highlight-text {
      color: #d0d8ff;
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .tutorial-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
    }

    .tutorial-progress {
      display: flex;
      gap: 8px;
    }

    .tutorial-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(120, 80, 255, 0.3);
      transition: all 0.3s ease;
    }

    .tutorial-dot.active {
      background: #7d5cff;
      transform: scale(1.2);
    }

    .tutorial-buttons {
      display: flex;
      gap: 12px;
    }

    .tutorial-btn {
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tutorial-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #a8b4d9;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .tutorial-btn.secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      color: #e8f0ff;
    }

    .tutorial-btn.primary {
      background: linear-gradient(135deg, #7d5cff 0%, #3c82ff 100%);
      color: white;
      border: 1px solid rgba(120, 80, 255, 0.3);
    }

    .tutorial-btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(120, 80, 255, 0.4);
    }

    .tutorial-config-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      background: rgba(120, 80, 255, 0.15);
      border: 2px solid rgba(120, 80, 255, 0.3);
      border-radius: 12px;
      color: #e8f0ff;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      justify-content: center;
    }

    .tutorial-config-btn:hover {
      background: rgba(120, 80, 255, 0.25);
      border-color: rgba(120, 80, 255, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(120, 80, 255, 0.3);
    }

    .tutorial-config-btn.selected {
      background: rgba(120, 80, 255, 0.4);
      border-color: rgba(120, 80, 255, 0.7);
      box-shadow: 0 0 20px rgba(120, 80, 255, 0.4);
    }

    .tutorial-config-btn i {
      font-size: 1.2rem;
      color: #7d5cff;
    }

    /* Tutorial highlighting effects */
    .tutorial-highlight-element {
      position: relative;
      z-index: 14000;
    }

    .tutorial-highlight-element::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      border: 2px solid #7d5cff;
      border-radius: inherit;
      box-shadow: 
        0 0 20px rgba(120, 80, 255, 0.6),
        0 0 40px rgba(120, 80, 255, 0.3);
      animation: tutorialPulse 2s infinite;
      pointer-events: none;
    }

    @keyframes tutorialPulse {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1); 
      }
      50% { 
        opacity: 0.7; 
        transform: scale(1.02); 
      }
    }

    /* Light mode tutorial */
    body.light-mode .tutorial-overlay {
      background: rgba(255, 255, 255, 0.9);
    }

    body.light-mode .tutorial-content {
      background: rgba(255, 255, 255, 0.98);
      border: 2px solid rgba(120, 80, 255, 0.5);
      box-shadow: 
        0 0 80px rgba(120, 80, 255, 0.3),
        0 30px 60px rgba(0, 0, 0, 0.2),
        0 2px 0 rgba(120, 80, 255, 0.1) inset;
    }

    body.light-mode .tutorial-title {
      color: #1a1a2e;
    }

    body.light-mode .tutorial-description {
      color: #3c4560;
    }

    body.light-mode .tutorial-highlight {
      background: rgba(120, 80, 255, 0.1);
      border: 1px solid rgba(120, 80, 255, 0.3);
    }

    body.light-mode .tutorial-highlight-text {
      color: #1a1a2e;
    }

    /* Mobile tutorial adjustments */
    @media (max-width: 768px) {
      .tutorial-content {
        width: 95vw;
        padding: 30px 20px;
        max-height: 85vh;
      }
      
      .tutorial-icon {
        font-size: 2.5rem;
        margin-bottom: 16px;
      }
      
      .tutorial-title {
        font-size: 1.4rem;
        margin-bottom: 8px;
      }
      
      .tutorial-description {
        font-size: 0.95rem;
        margin-bottom: 20px;
        text-align: left;
      }
      
      .tutorial-highlight {
        padding: 16px;
        margin-bottom: 20px;
      }
      
      .tutorial-highlight-text {
        text-align: left;
      }
      
      .tutorial-controls {
        margin-top: 20px;
      }
      
      .tutorial-buttons {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .tutorial-btn {
        min-width: 100px;
        padding: 12px 16px;
      }
      
      .tutorial-btn span {
        font-size: 0.9rem;
      }
    }
 /* Inline Update Progress (within the card) */
.update-progress-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(20, 15, 40, 0.98);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 12px;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
  z-index: 10;
}

.update-progress-overlay.show {
  display: flex;
}

.update-cancel-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgba(255, 87, 87, 0.2);
  border: 2px solid rgba(255, 87, 87, 0.4);
  color: #ff5757;
  font-size: 0.9rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  z-index: 11;
}

.update-cancel-btn:hover {
  background: rgba(255, 87, 87, 0.3);
  border-color: rgba(255, 87, 87, 0.6);
  transform: scale(1.1);
}

.update-progress-icon {
  font-size: 2.5rem;
  color: #7d5cff;
  margin-bottom: 16px;
  animation: updateSpinPulse 2s ease-in-out infinite;
}

@keyframes updateSpinPulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}

.update-progress-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #e8f0ff;
  margin-bottom: 8px;
}

.update-progress-status {
  font-size: 0.85rem;
  color: #a8b4d9;
  margin-bottom: 16px;
  text-align: center;
}

.update-progress-row {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.update-progress-bar-container {
  flex: 1;
  height: 24px;
  background: rgba(40, 202, 66, 0.15);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 0 15px rgba(40, 202, 66, 0.2) inset;
  border: 1px solid rgba(40, 202, 66, 0.3);
}

.update-progress-bar {
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, #28ca42 0%, #20a03a 100%);
  border-radius: 12px;
  transition: width 0.5s ease;
  box-shadow: 
    0 0 20px rgba(40, 202, 66, 0.6),
    0 0 40px rgba(40, 202, 66, 0.3);
  position: relative;
  overflow: hidden;
}

.update-progress-bar::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
  animation: progressShine 1.5s infinite;
}

@keyframes progressShine {
  0% {
    left: -100%;
  }
  100% {
    left: 200%;
  }
}

.update-progress-percent {
  font-size: 1.1rem;
  font-weight: 700;
  color: #28ca42;
  text-shadow: 0 0 15px rgba(40, 202, 66, 0.4);
  min-width: 50px;
  text-align: right;
}

.update-progress-time {
  font-size: 0.75rem;
  color: #a8b4d9;
  margin-top: 4px;
  text-align: center;
  width: 100%;
}

/* Update Success State */
.update-progress-icon.success {
  color: #28ca42 !important;
  animation: successBounce 0.6s ease-in-out;
}

@keyframes successBounce {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.3);
  }
}

/* Light mode */
body.light-mode .update-progress-overlay {
  background: rgba(255, 255, 255, 0.98);
}

body.light-mode .update-progress-title {
  color: #1a1a2e;
}

body.light-mode .update-progress-status {
  color: #3c4560;
}

body.light-mode .update-progress-bar-container {
  background: rgba(40, 202, 66, 0.1);
  border: 1px solid rgba(40, 202, 66, 0.25);
}

body.light-mode .update-progress-time {
  color: #3c4560;
}
/* Update Notification Badge */
.update-notification-badge {
  position: fixed;
  top: 48px;
  right: -350px;
  background: linear-gradient(135deg, rgba(255, 87, 87, 0.95) 0%, rgba(255, 107, 107, 0.95) 100%);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 
    0 8px 32px rgba(255, 87, 87, 0.4),
    0 0 0 1px rgba(255, 255, 255, 0.2) inset;
  border: 1px solid rgba(255, 87, 87, 0.5);
  z-index: 9999;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  max-width: 320px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.update-notification-badge.show {
  right: 20px;
}

.update-notification-badge:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 12px 40px rgba(255, 87, 87, 0.5),
    0 0 0 1px rgba(255, 255, 255, 0.3) inset;
}

.update-notification-icon {
  font-size: 1.5rem;
  color: #ffffff;
  flex-shrink: 0;
}

.update-notification-content {
  flex: 1;
}

.update-notification-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 4px;
}

.update-notification-text {
  font-size: 0.8rem;
  color: rgba(255, 255, 255, 0.9);
  line-height: 1.3;
}

.update-notification-close {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: #ffffff;
  font-size: 0.7rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.update-notification-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

/* Red indicator dot on System settings nav item */
.settings-nav-item .update-indicator {
  width: 8px;
  height: 8px;
  background: #ff5757;
  border-radius: 50%;
  position: absolute;
  top: 14px;
  right: 12px;
  box-shadow: 0 0 12px rgba(255, 87, 87, 0.6);
  animation: updateIndicatorPulse 2s ease-in-out infinite;
}

@keyframes updateIndicatorPulse {
  0%, 100% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.2);
    opacity: 0.7;
  }
}

/* Light mode notification */
body.light-mode .update-notification-badge {
  background: linear-gradient(135deg, rgba(255, 87, 87, 0.98) 0%, rgba(255, 107, 107, 0.98) 100%);
  border: 1px solid rgba(255, 87, 87, 0.6);
}

body.light-mode .update-notification-title,
body.light-mode .update-notification-text {
  color: #ffffff;
}
/* Update Notification Badge - Top Right Corner */
.desktop-update-badge {
  position: fixed;
  top: 48px;
  right: 20px;
  background: linear-gradient(135deg, rgba(255, 87, 87, 0.95) 0%, rgba(255, 107, 107, 0.95) 100%);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 
    0 8px 32px rgba(255, 87, 87, 0.4),
    0 0 0 1px rgba(255, 255, 255, 0.2) inset;
  border: 1px solid rgba(255, 87, 87, 0.5);
  z-index: 9998;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  max-width: 320px;
  display: none;
  align-items: center;
  gap: 12px;
  animation: badgeSlideIn 0.5s ease, badgePulse 2s ease-in-out infinite 1s;
}

.desktop-update-badge.show {
  display: flex;
}

.desktop-update-badge:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 
    0 12px 40px rgba(255, 87, 87, 0.5),
    0 0 0 1px rgba(255, 255, 255, 0.3) inset;
}

.desktop-update-badge-icon {
  font-size: 1.5rem;
  color: #ffffff;
  flex-shrink: 0;
  animation: badgeIconSpin 3s linear infinite;
}

.desktop-update-badge-content {
  flex: 1;
}

.desktop-update-badge-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: #ffffff;
  margin-bottom: 4px;
}

.desktop-update-badge-text {
  font-size: 0.8rem;
  color: rgba(255, 255, 255, 0.9);
  line-height: 1.3;
}

.desktop-update-badge-close {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: #ffffff;
  font-size: 0.7rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.desktop-update-badge-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

@keyframes badgeSlideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes badgePulse {
  0%, 100% {
    box-shadow: 
      0 8px 32px rgba(255, 87, 87, 0.4),
      0 0 0 1px rgba(255, 255, 255, 0.2) inset;
  }
  50% {
    box-shadow: 
      0 12px 40px rgba(255, 87, 87, 0.6),
      0 0 0 1px rgba(255, 255, 255, 0.3) inset;
  }
}

@keyframes badgeIconSpin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* Light mode badge */
body.light-mode .desktop-update-badge {
  background: linear-gradient(135deg, rgba(255, 87, 87, 0.98) 0%, rgba(255, 107, 107, 0.98) 100%);
  border: 1px solid rgba(255, 87, 87, 0.6);
}
  .window.minimized {
  visibility: hidden;
  pointer-events: none;
  /* Keep window in DOM but invisible */
}
  </style>
</head>
<body>

<!-- Startup Screen -->
<div id="startupScreen">
  <div class="startup-content">
    <i class="fas fa-globe startup-icon"></i>
    <div class="startup-text">X-ORBIT</div>
    <div class="startup-version">4.6.0 Astra</div>
    <div class="startup-progress-container">
      <div class="startup-progress-bar" id="startupProgress"></div>
    </div>
    <div class="startup-status" id="startupStatus">Initializing system...</div>
    <button class="startup-continue-btn" id="startupContinueBtn" style="display: none;">
      <i class="fas fa-arrow-right"></i>
    </button>
  </div>
</div>

<div id="welcomeOverlay">
  <iframe id="authFrame" src="auth.html" style="width: 100%; height: 100%; border: none;"></iframe>
</div>

<div class="menu-bar">
  <div class="menu-left">
    <div class="menu-item xorbit-title" style="font-weight: 600;" id="xorbitMenu">
      X-ORBIT
      <div class="xorbit-menu" id="xorbitDropdown">
        <div class="xorbit-menu-item" onclick="showAccountInfo()">
          <i class="fas fa-user-circle"></i>
          <span>Account Information</span>
        </div>
        <div class="xorbit-menu-divider"></div>
        <div class="xorbit-menu-item" onclick="showAboutDialog()">
          <i class="fas fa-info-circle"></i>
          <span>About X-ORBIT</span>
        </div>
        <div class="xorbit-menu-item" onclick="openSettingsWindow()">
          <i class="fas fa-cog"></i>
          <span>Preferences...</span>
        </div>
        <div class="xorbit-menu-divider"></div>
        <div class="xorbit-menu-item" onclick="showSystemInfo()">
          <i class="fas fa-desktop"></i>
          <span>System Information</span>
        </div>
        <div class="xorbit-menu-item" onclick="checkForUpdates()">
          <i class="fas fa-download"></i>
          <span>Check for Updates</span>
        </div>
        <div class="xorbit-menu-item" onclick="openWindow('Help & Support', 'support.html', 'fas fa-question-circle')">
          <i class="fas fa-question-circle"></i>
          <span>Help & Support</span>
        </div>
        <div class="xorbit-menu-item" onclick="restartTutorial()">
          <i class="fas fa-graduation-cap"></i>
          <span>Desktop Tour</span>
        </div>
        <div class="xorbit-menu-divider"></div>
        <div class="xorbit-menu-item" onclick="restartDesktop()">
          <i class="fas fa-sync"></i>
          <span>Restart Desktop</span>
        </div>
        <div class="xorbit-menu-item danger" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </div>
      </div>
    </div>
    <div class="menu-item">File</div>
    <div class="menu-item">Edit</div>
    <div class="menu-item">View</div>
    <div class="menu-item">Window</div>
    <div class="menu-item">Help</div>
  </div>
  <div class="menu-right">
    <div class="menu-item" id="userNameplate" style="cursor: pointer; position: relative;">
      <i class="fas fa-user-circle" style="margin-right: 6px;"></i>
      <span id="userNameDisplay">User</span>
      <div class="xorbit-menu" id="userDropdown">
        <div class="xorbit-menu-item" onclick="showAccountInfo()">
          <i class="fas fa-id-card"></i>
          <span>Account Information</span>
        </div>
        <div class="xorbit-menu-divider"></div>
        <div class="xorbit-menu-item" onclick="openSettingsWindow()">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </div>
        <div class="xorbit-menu-item" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </div>
      </div>
    </div>
    <div class="menu-item" id="wifiMenu" style="cursor: pointer; position: relative;">
      <i class="fas fa-wifi" id="wifiIcon"></i>
      <div class="xorbit-menu" id="wifiDropdown" style="min-width: 280px; left: auto; right: 0;">
        <div style="padding: 16px; border-bottom: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; font-size: 0.95rem; margin-bottom: 12px;">
            <i class="fas fa-network-wired" style="margin-right: 8px;"></i>
            Network Status
          </div>
          <div style="color: #e8f0ff; font-size: 0.85rem; margin-bottom: 8px;">
            <span style="color: #a8b4d9;">Connection:</span>
            <span id="networkStatus" style="margin-left: 8px; color: #28ca42;">
              <i class="fas fa-check-circle"></i> Online
            </span>
          </div>
          <div style="color: #e8f0ff; font-size: 0.85rem;">
            <span style="color: #a8b4d9;">Type:</span>
            <span id="networkType" style="margin-left: 8px;">Unknown</span>
          </div>
        </div>
        
        <div style="padding: 16px; border-bottom: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; font-size: 0.95rem; margin-bottom: 12px;">
            <i class="fas fa-server" style="margin-right: 8px;"></i>
            X-ORBIT Server Status
          </div>
          <div style="display: grid; gap: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #a8b4d9; font-size: 0.85rem;">Ping Latency:</span>
              <span id="pingLatency" style="color: #e8f0ff; font-weight: 600; font-size: 0.9rem;">
                <i class="fas fa-spinner fa-spin"></i> Testing...
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #a8b4d9; font-size: 0.85rem;">Jitter:</span>
              <span id="jitterValue" style="color: #e8f0ff; font-weight: 600; font-size: 0.9rem;">
                <i class="fas fa-spinner fa-spin"></i> Testing...
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #a8b4d9; font-size: 0.85rem;">Server Location:</span>
              <span style="color: #e8f0ff; font-size: 0.85rem;">Cloudflare</span>
            </div>
          </div>
        </div>
        
        <div style="padding: 12px 16px;">
          <button class="wallpaper-button" onclick="testNetworkSpeed()" style="width: 100%; font-size: 0.85rem; padding: 8px;">
            <i class="fas fa-sync-alt"></i>
            Refresh Connection Test
          </button>
        </div>
      </div>
    </div>
    <div class="menu-item time-item" id="timeMenu">
      <span id="currentTime"></span>
      <div class="time-menu" id="timeDropdown">
        <div class="time-header">
          <div class="time-display" id="fullTime"></div>
          <div class="date-display" id="fullDate"></div>
          <div class="timezone-display" id="timezone"></div>
        </div>
        
        <div class="weather-section">
          <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
          <div class="weather-info">
            <div class="weather-temp" id="weatherTemp">22¬∞C</div>
            <div class="weather-desc" id="weatherDesc">Partly Cloudy</div>
            <div class="weather-location" id="weatherLocation">Casper, Wyoming</div>
          </div>
        </div>
        
        <div class="weather-details">
          <div class="weather-detail">
            <div class="weather-detail-label">Humidity</div>
            <div class="weather-detail-value" id="humidity">65%</div>
          </div>
          <div class="weather-detail">
            <div class="weather-detail-label">Wind</div>
            <div class="weather-detail-value" id="wind">12 mph</div>
          </div>
          <div class="weather-detail">
            <div class="weather-detail-label">Pressure</div>
            <div class="weather-detail-value" id="pressure">1013 mb</div>
          </div>
          <div class="weather-detail">
            <div class="weather-detail-label">UV Index</div>
            <div class="weather-detail-value" id="uvIndex">3</div>
          </div>
        </div>
        
        <div class="location-section">
          <div class="location-text">Location services enabled</div>
          <div class="location-update" onclick="updateLocation()">üìç Update location</div>
        </div>
      </div>
    </div>
    <div class="menu-item" id="utilitiesMenu" style="cursor: pointer; position: relative;">
      <i class="fas fa-ellipsis-h"></i>
      <div class="xorbit-menu" id="utilitiesDropdown" style="left: auto; right: 0;">
        <div class="xorbit-menu-item" onclick="toggleFullscreen()">
          <i class="fas fa-expand" id="fullscreenIcon"></i>
          <span id="fullscreenText">Enter Fullscreen</span>
        </div>
        <div class="xorbit-menu-item" onclick="refreshDesktop()">
          <i class="fas fa-sync"></i>
          <span>Refresh Desktop</span>
        </div>
        <div class="xorbit-menu-divider"></div>
        <div class="xorbit-menu-item" onclick="openTaskManager()">
          <i class="fas fa-tasks"></i>
          <span>Task Manager</span>
        </div>
        <div class="xorbit-menu-item" onclick="openSettingsWindow()">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </div>
        <div class="xorbit-menu-divider"></div>
        <div class="xorbit-menu-item" onclick="restartDesktop()">
          <i class="fas fa-redo"></i>
          <span>Restart Desktop</span>
        </div>
        <div class="xorbit-menu-item" onclick="logout()">
          <i class="fas fa-power-off"></i>
          <span>Shut Down</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="desktop" id="desktop">
  <div class="desktop-icons">
    <div class="desktop-icon" data-app="Browser" data-src="browser.html" data-icon="fas fa-globe">
      <i class="fas fa-globe"></i>
      <span>Browser</span>
    </div>
    <div class="desktop-icon" data-app="Settings" data-src="settings.html" data-icon="fas fa-cog">
      <i class="fas fa-cog"></i>
      <span>Settings</span>
    </div>
    <div class="desktop-icon" data-app="Terminal" data-src="terminal.html" data-icon="fas fa-terminal">
      <i class="fas fa-terminal"></i>
      <span>Terminal</span>
    </div>
    <div class="desktop-icon" data-app="X-MUSIC" data-src="spotify-player.html" data-icon="fas fa-music">
  <i class="fas fa-music"></i>
  <span>X-MUSIC</span>
</div>
  </div>
</div>
<!-- Update Notification Badge - Desktop Corner -->
<div class="desktop-update-badge" id="desktopUpdateBadge">
  <i class="fas fa-sync-alt desktop-update-badge-icon"></i>
  <div class="desktop-update-badge-content">
    <div class="desktop-update-badge-title">Update Available</div>
    <div class="desktop-update-badge-text">Go to Settings ‚Üí System to install the latest version</div>
  </div>
  <div class="desktop-update-badge-close" onclick="hideDesktopUpdateBadge(event)">
    <i class="fas fa-times"></i>
  </div>
</div>
<div class="dock">
  <div class="dock-item" data-app="Home" data-src="render.html" data-icon="fas fa-home">
    <i class="fas fa-home"></i>
    <div class="tooltip">Home</div>
  </div>
  <div class="dock-item" data-app="Browser" data-src="browser.html" data-icon="fas fa-globe">
    <i class="fas fa-globe"></i>
    <div class="tooltip">Browser</div>
  </div>
  <div class="dock-item" data-app="Privacy Policy" data-src="privacy-policy.html" data-icon="fas fa-shield-alt">
    <i class="fas fa-shield-alt"></i>
    <div class="tooltip">Privacy</div>
  </div>
  <div class="dock-item" data-app="Terms of Service" data-src="tos.html" data-icon="fas fa-file-contract">
    <i class="fas fa-file-contract"></i>
    <div class="tooltip">Terms</div>
  </div>
  <div class="dock-item" data-app="Pricing" data-src="pricing.html" data-icon="fas fa-tags">
    <i class="fas fa-tags"></i>
    <div class="tooltip">Pricing</div>
  </div>
  <div class="dock-item" data-app="Team" data-src="team.html" data-icon="fas fa-users">
    <i class="fas fa-users"></i>
    <div class="tooltip">Team</div>
  </div>
  <div class="dock-item" data-app="Support" data-src="support.html" data-icon="fas fa-headset">
    <i class="fas fa-headset"></i>
    <div class="tooltip">Support</div>
  </div>
  <div class="dock-item" data-app="Changelog" data-src="changelogs.html" data-icon="fas fa-list-alt">
    <i class="fas fa-list-alt"></i>
    <div class="tooltip">Changes</div>
  </div>
  <div class="dock-item" data-app="Settings" data-src="settings.html" data-icon="fas fa-cog">
    <i class="fas fa-cog"></i>
    <div class="tooltip">Settings</div>
  </div>
  <div class="dock-item" data-app="Credits" data-src="credits.html" data-icon="fas fa-heart">
    <i class="fas fa-heart"></i>
    <div class="tooltip">Credits</div>
  </div>
</div>

<!-- Tutorial Overlay -->
<div class="tutorial-overlay" id="tutorialOverlay">
  <div class="tutorial-content" id="tutorialContent">
    <div class="tutorial-header">
      <i class="tutorial-icon" id="tutorialIcon">üöÄ</i>
      <div class="tutorial-title" id="tutorialTitle">Welcome to X-ORBIT!</div>
      <div class="tutorial-step" id="tutorialStep">Step 1 of 6</div>
    </div>
    
    <div class="tutorial-description" id="tutorialDescription">
      Welcome to your new desktop environment! Let's take a quick tour to help you get started with X-ORBIT's features.
    </div>
    
    <div class="tutorial-highlight" id="tutorialHighlight">
      <div class="tutorial-highlight-title" id="tutorialHighlightTitle">üí° Quick Tip</div>
      <div class="tutorial-highlight-text" id="tutorialHighlightText">
        This tour will only show once. You can skip it anytime or restart it from the Help menu.
      </div>
    </div>
    
    <div class="tutorial-controls">
      <div class="tutorial-progress" id="tutorialProgress">
        <div class="tutorial-dot active"></div>
        <div class="tutorial-dot"></div>
        <div class="tutorial-dot"></div>
        <div class="tutorial-dot"></div>
        <div class="tutorial-dot"></div>
        <div class="tutorial-dot"></div>
      </div>
      
      <div class="tutorial-buttons">
        <button class="tutorial-btn secondary" id="tutorialSkip">
          <i class="fas fa-times"></i>
          <span>Skip Tour</span>
        </button>
        <button class="tutorial-btn secondary" id="tutorialPrev" style="display: none;">
          <i class="fas fa-arrow-left"></i>
          <span>Previous</span>
        </button>
        <button class="tutorial-btn primary" id="tutorialNext">
          <span>Next</span>
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Global variable to track update check interval
let updateCheckInterval = null;
let desktopUpdateBadgeShown = false;

// Start automatic update checking every 30 seconds
function startAutomaticUpdateChecking() {
  console.log('Starting automatic update checking (every 30 seconds)');
  
  // Check immediately on start
  checkForUpdatesQuietly();
  
  // Then check every 30 seconds
  if (updateCheckInterval) {
    clearInterval(updateCheckInterval);
  }
  
  updateCheckInterval = setInterval(() => {
    checkForUpdatesQuietly();
  }, 30000); // 30 seconds
}

// Stop automatic update checking
function stopAutomaticUpdateChecking() {
  if (updateCheckInterval) {
    clearInterval(updateCheckInterval);
    updateCheckInterval = null;
    console.log('Automatic update checking stopped');
  }
}

// Quiet update check (doesn't show UI, just checks and shows badge if needed)
async function checkForUpdatesQuietly() {
  try {
    console.log('[Auto-Check] Checking for updates...');
    
    // Initialize Supabase if not already done
    if (!supabaseClient) {
      const initialized = initSupabaseClient();
      if (!initialized) {
        console.error('[Auto-Check] Cannot check updates: Supabase not initialized');
        return;
      }
    }
    
    // Query the update_check table
    const { data, error } = await supabaseClient
      .from('update_check')
      .select('*')
      .single();
    
    if (error) {
      console.error('[Auto-Check] Error checking for updates:', error);
      return;
    }
    
    if (!data) {
      console.error('[Auto-Check] No update data found');
      return;
    }
    
    // Compare versions
    const latestVersion = data.version;
    const latestVersionName = data.version_name || `X-ORBIT Desktop ${latestVersion}`;
    const updateSize = data.update_size || 'Unknown';
    
    if (latestVersion !== CURRENT_VERSION) {
      // Update available
      console.log('[Auto-Check] ‚úÖ Update available:', latestVersion);
      latestUpdateData = {
        version: latestVersion,
        versionName: latestVersionName,
        size: updateSize
      };
      
      // Show desktop badge if not already shown
      if (!desktopUpdateBadgeShown) {
        showDesktopUpdateBadge();
      }
    } else {
      // Up to date
      console.log('[Auto-Check] ‚úÖ System is up to date');
      // Hide badge if it's showing
      if (desktopUpdateBadgeShown) {
        hideDesktopUpdateBadge();
      }
    }
  } catch (e) {
    console.error('[Auto-Check] Error in checkForUpdatesQuietly:', e);
  }
}

// Show the desktop update badge
function showDesktopUpdateBadge() {
  const badge = document.getElementById('desktopUpdateBadge');
  if (badge && !desktopUpdateBadgeShown) {
    badge.classList.add('show');
    desktopUpdateBadgeShown = true;
    
    // Make badge clickable to open settings
    badge.onclick = function(e) {
      if (e.target.closest('.desktop-update-badge-close')) return;
      openSettingsToSystemSection();
    };
    
    console.log('Desktop update badge shown');
  }
}

// Hide the desktop update badge
function hideDesktopUpdateBadge(event) {
  if (event) {
    event.stopPropagation();
  }
  
  const badge = document.getElementById('desktopUpdateBadge');
  if (badge) {
    badge.classList.remove('show');
    desktopUpdateBadgeShown = false;
    console.log('Desktop update badge hidden');
  }
}

// Open settings window directly to System section
function openSettingsToSystemSection() {
  console.log('Opening settings to System section...');
  
  // Check if settings window is already open
  const settingsWindowId = activeWindows.get('Settings');
  if (settingsWindowId) {
    // Focus existing window and switch to System section
    focusWindow(settingsWindowId);
    const settingsWindow = document.getElementById(settingsWindowId);
    if (settingsWindow) {
      // Click on System nav item
      const systemNavItem = settingsWindow.querySelector('[data-section="system"]');
      if (systemNavItem) {
        systemNavItem.click();
      }
    }
  } else {
    // Open new settings window
    openSettingsWindow();
    
    // Wait for window to load, then switch to System section
    setTimeout(() => {
      const settingsWindowId = activeWindows.get('Settings');
      if (settingsWindowId) {
        const settingsWindow = document.getElementById(settingsWindowId);
        if (settingsWindow) {
          const systemNavItem = settingsWindow.querySelector('[data-section="system"]');
          if (systemNavItem) {
            systemNavItem.click();
          }
        }
      }
    }, 500);
  }
  
  // Hide the badge
  hideDesktopUpdateBadge();
}
// Global variables
let windowCounter = 0;
let activeWindows = new Map();
let isAuthenticated = false;
let zIndexCounter = 100;
let currentUser = {
  username: '',
  email: ''
};
let userLocation = {
  city: 'Casper',
  state: 'Wyoming',
  country: 'US',
  lat: 42.8666,
  lon: -106.3130,
  timezone: 'America/Denver'
};
let weatherData = {
  temp: 22,
  description: 'Partly Cloudy',
  icon: 'üå§Ô∏è',
  humidity: 65,
  wind: 12,
  pressure: 1013,
  uvIndex: 3
};
let settings = {
  theme: 'dark',
  transparency: true,
  animations: true,
  backgroundOpacity: 80,
  dockAutohide: false,
  dockPosition: 'bottom',
  dockSize: 56,
  dockMagnification: true,
  dockTooltips: true,
  windowSnapping: true,
  windowShadows: true,
  launchFullscreen: false,
  customWallpaper: null,
  startupWindows: 'welcome' // Options: 'welcome', 'none', 'browser', 'terminal', 'settings'
};

// Tutorial system
let currentTutorialStep = 0;
let tutorialSteps = [
  {
    icon: 'fas fa-rocket',
    title: 'Welcome to X-ORBIT!',
    description: 'Welcome to your new desktop environment! Let\'s take a quick tour to help you get started and personalize X-ORBIT to your preferences.',
    highlightTitle: 'Quick Tip',
    highlightText: 'Use arrow keys or spacebar to navigate this tour. Press Escape to skip anytime.',
    highlightElement: null
  },
  {
    icon: 'fas fa-palette',
    title: 'Choose Your Theme',
    description: 'X-ORBIT offers multiple beautiful themes. Which style do you prefer?',
    highlightTitle: 'Available Themes',
    highlightText: 'Dark Mode, Light Mode, or Halloween 2025. You can change this anytime in Settings.',
    highlightElement: null,
    isConfig: true,
    configType: 'theme'
  },
  {
    icon: 'fas fa-grip-horizontal',
    title: 'Dock Configuration',
    description: 'Customize how your dock behaves. Choose the position and whether it should auto-hide.',
    highlightTitle: 'Dock Options',
    highlightText: 'Bottom or Left position. Enable auto-hide to maximize screen space.',
    highlightElement: null,
    isConfig: true,
    configType: 'dock'
  },
  {
    icon: 'fas fa-expand',
    title: 'Fullscreen Mode',
    description: 'Would you like X-ORBIT to launch in fullscreen mode by default?',
    highlightTitle: 'Immersive Experience',
    highlightText: 'Fullscreen mode hides browser UI for a true desktop experience.',
    highlightElement: null,
    isConfig: true,
    configType: 'fullscreen'
  },
  {
    icon: 'fas fa-mouse-pointer',
    title: 'Desktop & Windows',
    description: 'This is your desktop workspace. You can open multiple windows, move them around, resize them, and organize your workspace however you like.',
    highlightTitle: 'Try This',
    highlightText: 'Click and drag window titlebars to move them. Use the colored buttons to close, minimize, or maximize windows.',
    highlightElement: '.desktop'
  },
  {
    icon: 'fas fa-bars',
    title: 'Menu Bar & Controls',
    description: 'The top menu bar gives you access to system controls. Click "X-ORBIT" for system options like logout and settings, or click the time for weather info.',
    highlightTitle: 'Time & Weather',
    highlightText: 'Click the time to see detailed weather information and timezone data for your location.',
    highlightElement: '.menu-bar'
  },
  {
    icon: 'fas fa-th-large',
    title: 'The Dock',
    description: 'Your dock provides quick access to applications. Hover over icons to see names, and click to launch apps instantly.',
    highlightTitle: 'Pro Tips',
    highlightText: 'Icons show a dot when apps are running. You can customize dock settings anytime.',
    highlightElement: '.dock'
  },
  {
    icon: 'fas fa-check-circle',
    title: 'You\'re All Set!',
    description: 'Congratulations! You now know the basics of X-ORBIT. Explore the applications, customize your settings, and make this desktop your own.',
    highlightTitle: 'Ready to Explore',
    highlightText: 'Your desktop is ready! Open some apps, try the settings, and enjoy your new workspace.',
    highlightElement: null
  }
];

// Load user data from session storage
function loadUserData() {
  try {
    const authData = sessionStorage.getItem('xorbit_auth_session') || 
                     localStorage.getItem('xorbit_auth_session');
    if (authData) {
      const authSession = JSON.parse(authData);
      currentUser.username = authSession.username || '';
      currentUser.email = authSession.email || '';
      console.log('‚úÖ User data loaded:', currentUser.username);
      updateUserDisplay();
    }
  } catch (e) {
    console.warn('Could not load user data:', e);
  }
}

// Update the user display in the menu bar
function updateUserDisplay() {
  const menuRight = document.querySelector('.menu-right');
  
  if (!menuRight) return;
  
  // Check if user display already exists
  let userDisplay = document.getElementById('userDisplay');
  
  if (!userDisplay && currentUser.username) {
    // Create user display element
    userDisplay = document.createElement('div');
    userDisplay.id = 'userDisplay';
    userDisplay.className = 'menu-item';
    userDisplay.style.cssText = `
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      background: rgba(120, 80, 255, 0.1);
      border: 1px solid rgba(120, 80, 255, 0.2);
      border-radius: 8px;
      cursor: default;
    `;
    
    userDisplay.innerHTML = `
      <i class="fas fa-user" style="color: #7d5cff;"></i>
      <span style="font-weight: 500;">${currentUser.username}</span>
    `;
    
    // Insert before the time menu
    const timeMenu = document.getElementById('timeMenu');
    if (timeMenu) {
      menuRight.insertBefore(userDisplay, timeMenu);
    } else {
      menuRight.appendChild(userDisplay);
    }
  } else if (userDisplay && currentUser.username) {
    // Update existing display
    const usernameSpan = userDisplay.querySelector('span');
    if (usernameSpan) {
      usernameSpan.textContent = currentUser.username;
    }
  }
}

// Wallpaper management
function handleWallpaperUpload(event) {
  event.preventDefault();
  event.stopPropagation();
  
  const file = event.target.files[0];
  if (!file) return;
  
  // Check if it's an image
  if (!file.type.startsWith('image/')) {
    alert('Please select a valid image file');
    return;
  }
  
  // Read the file and convert to base64
  const reader = new FileReader();
  reader.onload = function(e) {
    const imageData = e.target.result;
    
    // Save to settings
    settings.customWallpaper = imageData;
    localStorage.setItem('xorbit-settings', JSON.stringify(settings));
    
    // Apply wallpaper
    applyWallpaper(imageData);
    
    // Update preview in settings
    updateWallpaperPreview(imageData);
    
    // Clear the file input
    event.target.value = '';
  };
  reader.readAsDataURL(file);
}

function resetWallpaper() {
  event.preventDefault();
  event.stopPropagation();
  
  settings.customWallpaper = null;
  localStorage.setItem('xorbit-settings', JSON.stringify(settings));
  applyWallpaper(null);
  
  // Hide preview
  const preview = document.getElementById('wallpaperPreview');
  if (preview) preview.style.display = 'none';
}

function applyWallpaper(imageData) {
  if (imageData) {
    // Show custom wallpaper
    document.body.style.backgroundImage = `url(${imageData})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
    document.body.style.backgroundRepeat = 'no-repeat';
    
    // Hide globe icon
    const style = document.createElement('style');
    style.id = 'custom-wallpaper-style';
    style.textContent = 'body::after { display: none !important; }';
    
    // Remove old style if exists
    const oldStyle = document.getElementById('custom-wallpaper-style');
    if (oldStyle) oldStyle.remove();
    
    document.head.appendChild(style);
  } else {
    // Reset to default (globe background)
    document.body.style.backgroundImage = '';
    
    // Remove hide globe style
    const oldStyle = document.getElementById('custom-wallpaper-style');
    if (oldStyle) oldStyle.remove();
  }
}

function updateWallpaperPreview(imageData) {
  const preview = document.getElementById('wallpaperPreview');
  const previewImg = document.getElementById('wallpaperPreviewImg');
  
  if (preview && previewImg && imageData) {
    previewImg.src = imageData;
    preview.style.display = 'block';
  }
}

// Load settings from localStorage
function loadSettings() {
  const saved = localStorage.getItem('xorbit-settings');
  if (saved) {
    try {
      settings = { ...settings, ...JSON.parse(saved) };
    } catch (e) {
      console.warn('Failed to load settings');
    }
  }
  // Load the theme stylesheet
  loadTheme(settings.theme);
  applySettings();
  
  // Apply custom wallpaper if set
  if (settings.customWallpaper) {
    applyWallpaper(settings.customWallpaper);
  }
}

// Load theme stylesheet dynamically
function loadTheme(theme) {
  const existingTheme = document.getElementById('theme-stylesheet');
  if (existingTheme) {
    existingTheme.remove();
  }
  
  const link = document.createElement('link');
  link.id = 'theme-stylesheet';
  link.rel = 'stylesheet';
  
  // Select the appropriate theme file
  if (theme === 'light') {
    link.href = 'theme-light.css';
    document.body.classList.remove('halloween-theme');
  } else if (theme === 'orange') {
    link.href = 'theme-orange.css';
    document.body.classList.add('halloween-theme');
  } else {
    link.href = 'theme-dark.css';
    document.body.classList.remove('halloween-theme');
  }
  
  document.head.appendChild(link);
  
  console.log('Theme loaded:', theme);
}

// Apply settings to the desktop
function applySettings() {
  // Theme is now handled by loadTheme() function with external stylesheets

  // Apply dock settings
  const dock = document.querySelector('.dock');
  if (dock) {
    // Reset dock positioning
    dock.style.cssText = '';
    dock.className = 'dock';

    switch (settings.dockPosition) {
      case 'bottom':
        dock.style.bottom = '16px';
        dock.style.left = '50%';
        dock.style.transform = 'translateX(-50%)';
        dock.style.flexDirection = 'row';
        break;
      case 'top':
        dock.style.top = '48px';
        dock.style.left = '50%';
        dock.style.transform = 'translateX(-50%)';
        dock.style.flexDirection = 'row';
        break;
      case 'left':
        dock.style.left = '16px';
        dock.style.top = '50%';
        dock.style.transform = 'translateY(-50%)';
        dock.style.flexDirection = 'column';
        break;
      case 'right':
        dock.style.right = '16px';
        dock.style.top = '50%';
        dock.style.transform = 'translateY(-50%)';
        dock.style.flexDirection = 'column';
        break;
    }

    // Apply dock size
    const dockItems = document.querySelectorAll('.dock-item');
    dockItems.forEach(item => {
      if (item) {
        item.style.width = settings.dockSize + 'px';
        item.style.height = settings.dockSize + 'px';
      }
    });

    // Auto-hide functionality
    if (settings.dockAutohide) {
      dock.classList.add('dock-autohide');
      setupDockAutohide();
    }
  }

  // Apply other settings
  if (!settings.transparency) {
    document.body.classList.add('no-transparency');
  } else {
    document.body.classList.remove('no-transparency');
  }

  if (!settings.animations) {
    document.body.classList.add('no-animations');
  } else {
    document.body.classList.remove('no-animations');
  }
}

// Setup dock auto-hide
function setupDockAutohide() {
  const dock = document.querySelector('.dock');
  if (!dock) return;
  
  let hideTimeout;
  let showTimeout;
  const PROXIMITY_THRESHOLD = 100; // pixels from edge to trigger show
  const SHOW_DELAY = 1000; // ms to hover before showing (1 second)
  const HIDE_DELAY = 1000; // ms before hiding
  
  function showDock() {
    clearTimeout(hideTimeout);
    clearTimeout(showTimeout);
    dock.classList.add('dock-visible');
  }
  
  function scheduleDockShow() {
    clearTimeout(showTimeout);
    showTimeout = setTimeout(() => {
      dock.classList.add('dock-visible');
    }, SHOW_DELAY);
  }
  
  function cancelDockShow() {
    clearTimeout(showTimeout);
  }
  
  function scheduleDockHide() {
    clearTimeout(hideTimeout);
    clearTimeout(showTimeout);
    hideTimeout = setTimeout(() => {
      dock.classList.remove('dock-visible');
    }, HIDE_DELAY);
  }
  
  function checkMouseProximity(e) {
    const mouseX = e.clientX;
    const mouseY = e.clientY;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    // Determine dock position from computed style
    const dockStyle = dock.style;
    const isBottom = dockStyle.bottom && dockStyle.bottom !== 'auto';
    const isTop = dockStyle.top && dockStyle.top !== 'auto' && !isBottom;
    const isLeft = dockStyle.left && dockStyle.flexDirection === 'column';
    const isRight = dockStyle.right && dockStyle.flexDirection === 'column';
    
    let shouldShow = false;
    
    if (isBottom) {
      // Mouse near bottom edge
      shouldShow = mouseY > windowHeight - PROXIMITY_THRESHOLD;
    } else if (isTop) {
      // Mouse near top edge (below menu bar)
      shouldShow = mouseY < PROXIMITY_THRESHOLD + 32; // 32px for menu bar
    } else if (isLeft) {
      // Mouse near left edge
      shouldShow = mouseX < PROXIMITY_THRESHOLD;
    } else if (isRight) {
      // Mouse near right edge
      shouldShow = mouseX > windowWidth - PROXIMITY_THRESHOLD;
    } else {
      // Default to bottom if position unclear
      shouldShow = mouseY > windowHeight - PROXIMITY_THRESHOLD;
    }
    
    if (shouldShow) {
      // Mouse is in proximity zone - start the 2 second timer if not already showing
      if (!dock.classList.contains('dock-visible')) {
        scheduleDockShow();
      } else {
        // Already visible, keep it visible
        clearTimeout(hideTimeout);
      }
    } else {
      // Mouse left proximity zone
      cancelDockShow();
      if (dock.classList.contains('dock-visible')) {
        scheduleDockHide();
      }
    }
  }
  
  // Listen for mouse movement globally
  document.addEventListener('mousemove', checkMouseProximity);
  
  // Show dock immediately when hovering over it (override the 2 second delay)
  dock.addEventListener('mouseenter', showDock);
  
  // Hide dock when leaving it
  dock.addEventListener('mouseleave', scheduleDockHide);
  
  // Start with dock hidden
  dock.classList.remove('dock-visible');
}

// Listen for messages
window.addEventListener('message', async function(event) {
  if (event.data === 'session-timeout') {
    console.log('üö´ Received session timeout message from auth.html');
    stopBanChecking(); // Stop checking on timeout
    window.location.href = 'timeout.html';
  } else if (event.data === 'auth-success') {
    console.log('‚úÖ Received auth success message');
    isAuthenticated = true;
    
    // Check ban status before proceeding
    const isBanned = await checkAccountBanStatus();
    if (isBanned) {
      return;
    }
    
    const welcomeOverlay = document.getElementById('welcomeOverlay');
    if (welcomeOverlay) {
      welcomeOverlay.style.display = 'none';
    }
    loadUserData();
    initDesktop();
    
    // Start periodic ban checking
    startBanChecking();
  } else if (event.data && event.data.type === 'settings-updated') {
    settings = { ...settings, ...event.data.settings };
    applySettings();
  }
});

// Initialize desktop
function initDesktop() {
  loadSettings();
  loadUserData();
  updateTime();
  setInterval(updateTime, 1000);
  
  // Update detailed time every second when menu is open
  setInterval(() => {
    const timeDropdown = document.getElementById('timeDropdown');
    if (timeDropdown && timeDropdown.classList.contains('show')) {
      updateDetailedTime();
    }
  }, 1000);
  
  const dockItems = document.querySelectorAll('.dock-item');
  dockItems.forEach(function(item, index) {
    if (item) {
      item.style.opacity = '0';
      item.style.transform = 'translateY(20px)';
      setTimeout(function() {
        item.style.transition = 'all 0.4s ease';
        item.style.opacity = '1';
        item.style.transform = 'translateY(0)';
      }, index * 100);
    }
  });
  
  // Check if this is first time and show tutorial
  setTimeout(function() {
    console.log('Checking if first time user...');
    if (isFirstTimeUser()) {
      console.log('First time user detected, showing tutorial');
      showTutorial();
    } else {
      console.log('Returning user, checking startup windows setting');
      openStartupWindow();
    }
  }, 1500);
  startAutomaticUpdateChecking();
}

// Open startup window based on settings
function openStartupWindow() {
  const startupOption = settings.startupWindows || 'welcome';
  
  switch(startupOption) {
    case 'welcome':
      openWindow('Welcome to X-ORBIT', 'render.html', 'fas fa-rocket');
      break;
    case 'browser':
      openWindow('Browser', 'browser.html', 'fas fa-globe');
      break;
    case 'terminal':
      openWindow('Terminal', 'terminal.html', 'fas fa-terminal');
      break;
    case 'settings':
      openSettingsWindow();
      break;
    case 'files':
      openWindow('File Manager', 'files.html', 'fas fa-folder');
      break;
    case 'none':
      // Do nothing - no startup window
      console.log('Startup windows disabled');
      break;
    default:
      openWindow('Welcome to X-ORBIT', 'render.html', 'fas fa-rocket');
  }
}

// Tutorial System Functions
function isFirstTimeUser() {
  const completed = localStorage.getItem('xorbit-tutorial-completed');
  console.log('Tutorial completed status:', completed);
  return !completed;
}

function markTutorialCompleted() {
  localStorage.setItem('xorbit-tutorial-completed', 'true');
  console.log('Tutorial marked as completed');
}

function showTutorial() {
  console.log('Attempting to show tutorial...');
  const tutorialOverlay = document.getElementById('tutorialOverlay');
  
  if (!tutorialOverlay) {
    console.error('Tutorial overlay not found!');
    return;
  }
  
  // Close any open menus
  document.querySelectorAll('.xorbit-menu.show, .time-menu.show').forEach(menu => {
    menu.classList.remove('show');
  });
  
  currentTutorialStep = 0;
  console.log('Starting tutorial at step:', currentTutorialStep);
  
  // Show overlay first
  tutorialOverlay.style.display = 'flex';
  
  // Then update content and show with animation
  setTimeout(() => {
    updateTutorialStep();
    tutorialOverlay.classList.add('show');
    setupTutorialEventListeners();
    console.log('Tutorial should now be visible');
  }, 50);
}

function hideTutorial() {
  console.log('Hiding tutorial...');
  const tutorialOverlay = document.getElementById('tutorialOverlay');
  if (tutorialOverlay) {
    tutorialOverlay.classList.remove('show');
    clearTutorialHighlight();
    markTutorialCompleted();
    
    // Hide overlay after animation
    setTimeout(() => {
      tutorialOverlay.style.display = 'none';
      // Open welcome window after tutorial
      openWindow('Welcome to X-ORBIT', 'render.html', 'fas fa-rocket');
    }, 500);
  }
}

function setupTutorialEventListeners() {
  const nextBtn = document.getElementById('tutorialNext');
  const prevBtn = document.getElementById('tutorialPrev');
  const skipBtn = document.getElementById('tutorialSkip');
  
  if (nextBtn) {
    nextBtn.onclick = function() {
      if (currentTutorialStep < tutorialSteps.length - 1) {
        currentTutorialStep++;
        updateTutorialStep();
      } else {
        hideTutorial();
      }
    };
  }
  
  if (prevBtn) {
    prevBtn.onclick = function() {
      if (currentTutorialStep > 0) {
        currentTutorialStep--;
        updateTutorialStep();
      }
    };
  }
  
  if (skipBtn) {
    skipBtn.onclick = function() {
      if (confirm('Skip the tour? You can restart it from X-ORBIT ‚Üí Desktop Tour later.')) {
        hideTutorial();
      }
    };
  }
  
  // Prevent clicks outside tutorial from closing it
  const tutorialOverlay = document.getElementById('tutorialOverlay');
  if (tutorialOverlay) {
    tutorialOverlay.addEventListener('click', function(e) {
      if (e.target === tutorialOverlay) {
        // Don't close on background click - user should use skip or complete
        return;
      }
    });
  }
  
  // Add keyboard navigation for tutorial
  document.addEventListener('keydown', function(e) {
    const tutorialOverlay = document.getElementById('tutorialOverlay');
    if (tutorialOverlay && tutorialOverlay.classList.contains('show')) {
      if (e.key === 'ArrowRight' || e.key === 'Space' || e.key === 'Enter') {
        e.preventDefault();
        const nextBtn = document.getElementById('tutorialNext');
        if (nextBtn) nextBtn.click();
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        if (currentTutorialStep > 0) {
          currentTutorialStep--;
          updateTutorialStep();
        }
      } else if (e.key === 'Escape') {
        e.preventDefault();
        const skipBtn = document.getElementById('tutorialSkip');
        if (skipBtn) skipBtn.click();
      }
    }
  });
}

function updateTutorialStep() {
  const step = tutorialSteps[currentTutorialStep];
  const tutorialContent = document.getElementById('tutorialContent');
  
  if (!step || !tutorialContent) return;
  
  // Update content
  const iconEl = document.getElementById('tutorialIcon');
  const titleEl = document.getElementById('tutorialTitle');
  const stepEl = document.getElementById('tutorialStep');
  const descEl = document.getElementById('tutorialDescription');
  const highlightTitleEl = document.getElementById('tutorialHighlightTitle');
  const highlightTextEl = document.getElementById('tutorialHighlightText');
  const highlightBox = document.getElementById('tutorialHighlight');
  const nextBtn = document.getElementById('tutorialNext');
  const prevBtn = document.getElementById('tutorialPrev');
  
  // Update icon to use Font Awesome
  if (iconEl) {
    iconEl.textContent = '';
    iconEl.className = 'tutorial-icon ' + step.icon;
  }
  if (titleEl) titleEl.textContent = step.title;
  if (stepEl) stepEl.textContent = `Step ${currentTutorialStep + 1} of ${tutorialSteps.length}`;
  if (descEl) descEl.textContent = step.description;
  if (highlightTitleEl) highlightTitleEl.textContent = step.highlightTitle;
  if (highlightTextEl) highlightTextEl.textContent = step.highlightText;
  
  // Show configuration UI if this is a config step
  if (step.isConfig && highlightBox) {
    highlightBox.innerHTML = renderConfigUI(step.configType);
  } else if (highlightBox) {
    highlightBox.innerHTML = `
      <div class="tutorial-highlight-title">${step.highlightTitle}</div>
      <div class="tutorial-highlight-text">${step.highlightText}</div>
    `;
  }
  
  // Update button text for last step
  if (nextBtn) {
    const nextSpan = nextBtn.querySelector('span');
    const nextIcon = nextBtn.querySelector('i');
    if (currentTutorialStep === tutorialSteps.length - 1) {
      if (nextSpan) nextSpan.textContent = 'Get Started!';
      if (nextIcon) nextIcon.className = 'fas fa-rocket';
    } else {
      if (nextSpan) nextSpan.textContent = 'Next';
      if (nextIcon) nextIcon.className = 'fas fa-arrow-right';
    }
  }
  
  // Show/hide previous button
  if (prevBtn) {
    prevBtn.style.display = currentTutorialStep > 0 ? 'flex' : 'none';
  }
  
  // Update progress dots
  const dots = document.querySelectorAll('.tutorial-dot');
  dots.forEach((dot, index) => {
    dot.classList.toggle('active', index === currentTutorialStep);
  });
  
  // Highlight element if specified
  clearTutorialHighlight();
  if (step.highlightElement) {
    highlightTutorialElement(step.highlightElement);
  }
}

function renderConfigUI(configType) {
  switch(configType) {
    case 'theme':
      return `
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <div style="font-weight: 600; color: #e8f0ff; margin-bottom: 8px;">Select Your Theme:</div>
          <button class="tutorial-config-btn" onclick="applyTutorialConfig('theme', 'dark')" data-theme="dark">
            <i class="fas fa-moon"></i>
            <span>Dark Mode</span>
          </button>
          <button class="tutorial-config-btn" onclick="applyTutorialConfig('theme', 'light')" data-theme="light">
            <i class="fas fa-sun"></i>
            <span>Light Mode</span>
          </button>
          <button class="tutorial-config-btn" onclick="applyTutorialConfig('theme', 'orange')" data-theme="orange">
            <i class="fas fa-ghost"></i>
            <span>Halloween 2025</span>
          </button>
        </div>
      `;
    case 'dock':
      return `
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <div style="font-weight: 600; color: #e8f0ff; margin-bottom: 8px;">Dock Settings:</div>
          <div style="display: flex; gap: 12px;">
            <button class="tutorial-config-btn" onclick="applyTutorialConfig('dockPosition', 'bottom')" data-dock="bottom">
              <i class="fas fa-arrows-alt-h"></i>
              <span>Bottom</span>
            </button>
            <button class="tutorial-config-btn" onclick="applyTutorialConfig('dockPosition', 'left')" data-dock="left">
              <i class="fas fa-arrows-alt-v"></i>
              <span>Left</span>
            </button>
          </div>
          <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(120, 80, 255, 0.1); border-radius: 10px; cursor: pointer;">
            <input type="checkbox" id="tutorialAutohide" onchange="applyTutorialConfig('dockAutohide', this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
            <span style="color: #e8f0ff;">Enable Auto-hide Dock</span>
          </label>
        </div>
      `;
    case 'fullscreen':
      return `
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <div style="font-weight: 600; color: #e8f0ff; margin-bottom: 8px;">Fullscreen Launch:</div>
          <button class="tutorial-config-btn" onclick="applyTutorialConfig('launchFullscreen', true)" data-fullscreen="true">
            <i class="fas fa-expand"></i>
            <span>Yes, Launch Fullscreen</span>
          </button>
          <button class="tutorial-config-btn" onclick="applyTutorialConfig('launchFullscreen', false)" data-fullscreen="false">
            <i class="fas fa-compress"></i>
            <span>No, Normal Window</span>
          </button>
        </div>
      `;
    default:
      return '';
  }
}

function applyTutorialConfig(setting, value) {
  // Apply the setting immediately
  if (setting === 'theme') {
    settings.theme = value;
    loadTheme(value);
  } else if (setting === 'dockPosition') {
    settings.dockPosition = value;
  } else if (setting === 'dockAutohide') {
    settings.dockAutohide = value;
  } else if (setting === 'launchFullscreen') {
    settings.launchFullscreen = value;
  }
  
  // Save settings
  localStorage.setItem('xorbit-settings', JSON.stringify(settings));
  applySettings();
  
  // Visual feedback on button
  const buttons = document.querySelectorAll('.tutorial-config-btn');
  buttons.forEach(btn => btn.classList.remove('selected'));
  event.target.closest('.tutorial-config-btn')?.classList.add('selected');
}

function highlightTutorialElement(selector) {
  try {
    const element = document.querySelector(selector);
    if (element) {
      element.classList.add('tutorial-highlight-element');
    }
  } catch (e) {
    console.warn('Could not highlight element:', selector);
  }
}

function clearTutorialHighlight() {
  try {
    document.querySelectorAll('.tutorial-highlight-element').forEach(el => {
      el.classList.remove('tutorial-highlight-element');
    });
  } catch (e) {
    console.warn('Error clearing highlights');
  }
}

// Add restart tutorial function to help menu
function restartTutorial() {
  document.getElementById('xorbitDropdown').classList.remove('show');
  
  if (confirm('Restart the desktop tour? This will show you how to use X-ORBIT.')) {
    console.log('Restarting tutorial...');
    // Clear completion flag temporarily
    localStorage.removeItem('xorbit-tutorial-completed');
    showTutorial();
  }
}

// Temporary function for testing - remove in production
function forceShowTutorial() {
  console.log('Force showing tutorial for testing...');
  localStorage.removeItem('xorbit-tutorial-completed');
  showTutorial();
}

// Make forceShowTutorial available globally for testing
window.forceShowTutorial = forceShowTutorial;

// Update time
function updateTime() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const timeEl = document.getElementById('currentTime');
  if (timeEl) timeEl.textContent = timeStr;
  
  // Update detailed time info
  updateDetailedTime(now);
}

// Update detailed time information
function updateDetailedTime(now = new Date()) {
  const fullTimeEl = document.getElementById('fullTime');
  const fullDateEl = document.getElementById('fullDate');
  const timezoneEl = document.getElementById('timezone');
  
  if (fullTimeEl) {
    const timeStr = now.toLocaleTimeString([], { 
      hour: '2-digit', 
      minute: '2-digit',
      second: '2-digit'
    });
    fullTimeEl.textContent = timeStr;
  }
  
  if (fullDateEl) {
    const dateStr = now.toLocaleDateString([], {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    fullDateEl.textContent = dateStr;
  }
  
  if (timezoneEl) {
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const offset = now.getTimezoneOffset();
    const offsetHours = Math.floor(Math.abs(offset) / 60);
    const offsetMins = Math.abs(offset) % 60;
    const offsetSign = offset <= 0 ? '+' : '-';
    const offsetStr = `${offsetSign}${offsetHours.toString().padStart(2, '0')}:${offsetMins.toString().padStart(2, '0')}`;
    timezoneEl.textContent = `${timezone} (UTC${offsetStr})`;
  }
}

// Open window
function openWindow(title, src, icon) {
  if (!isAuthenticated) return;
  
  if (activeWindows.has(title)) {
    focusWindow(activeWindows.get(title));
    return;
  }
  
  windowCounter++;
  const windowId = 'win' + windowCounter;
  
  const windowEl = document.createElement('div');
  windowEl.className = 'window';
  if (settings.animations) {
    windowEl.classList.add('window-opening');
  }
  windowEl.id = windowId;
  
  // Calculate safe position to prevent overflow - SIMPLIFIED
  const windowWidth = 600;
  const windowHeight = 450;
  
  // Get viewport size
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  
  // Safe margins
  const leftMargin = 50;
  const rightMargin = 50;
  const topMargin = 80;
  const bottomMargin = 120;
  
  // Calculate actual available space
  const availableWidth = vw - leftMargin - rightMargin;
  const availableHeight = vh - topMargin - bottomMargin;
  
  // Reduce window size if it won't fit
  const actualWidth = Math.min(windowWidth, availableWidth);
  const actualHeight = Math.min(windowHeight, availableHeight);
  
  // Calculate safe position range
  const minX = leftMargin;
  const maxX = vw - actualWidth - rightMargin;
  const minY = topMargin;
  const maxY = vh - actualHeight - bottomMargin;
  
  // Generate position (centered with slight randomness)
  const centerX = (vw - actualWidth) / 2;
  const centerY = (vh - actualHeight) / 2;
  const randomOffsetX = (Math.random() - 0.5) * 100;
  const randomOffsetY = (Math.random() - 0.5) * 100;
  
  let x = centerX + randomOffsetX;
  let y = centerY + randomOffsetY;
  
  // Clamp to bounds
  x = Math.max(minX, Math.min(x, maxX));
  y = Math.max(minY, Math.min(y, maxY));
  
  windowEl.style.left = Math.floor(x) + 'px';
  windowEl.style.top = Math.floor(y) + 'px';
  windowEl.style.width = Math.floor(actualWidth) + 'px';
  windowEl.style.height = Math.floor(actualHeight) + 'px';
  
  // Get username and update window title if it's the Browser
  let displayTitle = title;
  if (title === 'Browser' && currentUser.username) {
    displayTitle = `Browser - ${currentUser.username}`;
    // Also append username to iframe src as URL parameter
    src = `${src}?username=${encodeURIComponent(currentUser.username)}`;
  }
  
  windowEl.innerHTML = 
    '<div class="window-titlebar">' +
      '<div class="window-controls">' +
        '<div class="window-control close"></div>' +
        '<div class="window-control minimize"></div>' +
        '<div class="window-control maximize"></div>' +
      '</div>' +
      '<div class="window-title">' +
        '<i class="' + icon + '" style="margin-right: 8px;"></i>' +
        displayTitle +
      '</div>' +
    '</div>' +
    '<div class="window-content">' +
      '<iframe src="' + src + '"></iframe>' +
    '</div>';
  
  const desktop = document.getElementById('desktop');
  if (desktop) {
    desktop.appendChild(windowEl);
  }
  activeWindows.set(title, windowId);
  focusWindow(windowId);
  
  setupWindowEvents(windowEl, windowId, title);
  
  // Add resize observer to prevent overflow
  constrainWindowSize(windowEl);
  
  // Force immediate position check
  setTimeout(() => {
    forceWindowInBounds(windowEl);
    // Trigger smooth animation like weather UI
    windowEl.classList.add('window-visible');
  }, 0);
}

// Setup window events
function setupWindowEvents(windowEl, windowId, title) {
  const titlebar = windowEl.querySelector('.window-titlebar');
  const closeBtn = windowEl.querySelector('.window-control.close');
  const minBtn = windowEl.querySelector('.window-control.minimize');
  const maxBtn = windowEl.querySelector('.window-control.maximize');
  
  if (closeBtn) {
    closeBtn.onclick = function() {
      if (settings.animations) {
        windowEl.classList.remove('window-visible');
        setTimeout(function() {
          windowEl.remove();
          activeWindows.delete(title);
        }, 400);
      } else {
        windowEl.remove();
        activeWindows.delete(title);
      }
    };
  }
  
  if (minBtn) {
  minBtn.onclick = function() {
    // Hide window but keep it in DOM for background playback
    windowEl.classList.add('minimized');
    windowEl.style.visibility = 'hidden';
    windowEl.style.pointerEvents = 'none';
  };
}
  
  if (maxBtn) {
    maxBtn.onclick = function() {
      // Check if already fullscreen
      if (windowEl.classList.contains('fullscreen')) {
        // Restore to previous size
        windowEl.classList.remove('fullscreen');
        windowEl.style.position = 'absolute';
        windowEl.style.left = windowEl.dataset.prevLeft || '100px';
        windowEl.style.top = windowEl.dataset.prevTop || '100px';
        windowEl.style.width = windowEl.dataset.prevWidth || '600px';
        windowEl.style.height = windowEl.dataset.prevHeight || '450px';
        windowEl.style.borderRadius = '16px';
      } else {
        // Save current position/size
        windowEl.dataset.prevLeft = windowEl.style.left;
        windowEl.dataset.prevTop = windowEl.style.top;
        windowEl.dataset.prevWidth = windowEl.style.width;
        windowEl.dataset.prevHeight = windowEl.style.height;
        
        // Go fullscreen (CSS handles positioning)
        windowEl.classList.add('fullscreen');
        windowEl.style.width = '100vw';
        windowEl.style.height = 'calc(100vh - 32px)';
        windowEl.style.borderRadius = '0';
      }
    };
  }
  
  // Window dragging
  let isDragging = false;
  let dragOffset = { x: 0, y: 0 };
  
  if (titlebar) {
    titlebar.onmousedown = function(e) {
      if (e.target.closest('.window-control')) return;
      // Don't allow dragging if fullscreen
      if (windowEl.classList.contains('fullscreen')) return;
      
      isDragging = true;
      focusWindow(windowId);
      
      const rect = windowEl.getBoundingClientRect();
      dragOffset.x = e.clientX - rect.left;
      dragOffset.y = e.clientY - rect.top;
      
      document.onmousemove = function(e) {
        if (!isDragging) return;
        
        const rect = windowEl.getBoundingClientRect();
        const windowWidth = rect.width;
        const windowHeight = rect.height;
        
        let newX = e.clientX - dragOffset.x;
        let newY = e.clientY - dragOffset.y;
        
        // Constrain to screen bounds
        const minX = 0;
        const minY = 32; // Below menu bar
        const maxX = window.innerWidth - windowWidth;
        const maxY = window.innerHeight - 50; // Keep some visible at bottom
        
        newX = Math.max(minX, Math.min(newX, maxX));
        newY = Math.max(minY, Math.min(newY, maxY));
        
        windowEl.style.left = newX + 'px';
        windowEl.style.top = newY + 'px';
      };
      
      document.onmouseup = function() {
        isDragging = false;
        document.onmousemove = null;
        document.onmouseup = null;
      };
    };
  }
}

// Focus window
function focusWindow(windowId) {
  const windows = document.querySelectorAll('.window');
  windows.forEach(function(w) {
    w.classList.remove('active');
  });
  
  const windowEl = document.getElementById(windowId);
  if (windowEl) {
    windowEl.classList.add('active');
    windowEl.style.zIndex = ++zIndexCounter;
  }
}

document.addEventListener('click', function(e) {
  const dockItem = e.target.closest('.dock-item');
  const desktopIcon = e.target.closest('.desktop-icon');
  
  if (dockItem) {
    const title = dockItem.dataset.app;
    const src = dockItem.dataset.src;
    const icon = dockItem.dataset.icon;
    
    if (title === 'Settings') {
      openSettingsWindow();
    } else {
      // Check if window exists and is minimized
      const existingWindowId = activeWindows.get(title);
      if (existingWindowId) {
        const existingWindow = document.getElementById(existingWindowId);
        if (existingWindow && existingWindow.classList.contains('minimized')) {
          // Restore minimized window
          existingWindow.classList.remove('minimized');
          existingWindow.style.visibility = 'visible';
          existingWindow.style.pointerEvents = 'auto';
          focusWindow(existingWindowId);
          return;
        }
      openWindow(title, src, icon);
    }
  }
  
  if (desktopIcon) {
    const title = desktopIcon.dataset.app;
    const src = desktopIcon.dataset.src;
    const icon = desktopIcon.dataset.icon;
    
    if (title === 'Settings') {
      openSettingsWindow();
    } else {
      // Check if window exists and is minimized
      const existingWindowId = activeWindows.get(title);
      if (existingWindowId) {
        const existingWindow = document.getElementById(existingWindowId);
        if (existingWindow && existingWindow.classList.contains('minimized')) {
          // Restore minimized window
          existingWindow.classList.remove('minimized');
          existingWindow.style.visibility = 'visible';
          existingWindow.style.pointerEvents = 'auto';
          focusWindow(existingWindowId);
          return;
        }
      }
      openWindow(title, src, icon);
    }
  }
});
});
function openSettingsWindow() {
  if (!isAuthenticated) return;
  
  const title = 'Settings';
  if (activeWindows.has(title)) {
    focusWindow(activeWindows.get(title));
    return;
  }
  
  windowCounter++;
  const windowId = 'win' + windowCounter;
  
  const windowEl = document.createElement('div');
  windowEl.className = 'window';
  if (settings.animations) {
    windowEl.classList.add('window-opening');
  }
  windowEl.id = windowId;
  
  const x = Math.random() * (window.innerWidth - 800) + 50;
  const y = Math.random() * (window.innerHeight - 700) + 80;
  
  windowEl.style.left = x + 'px';
  windowEl.style.top = y + 'px';
  windowEl.style.width = '800px';
  windowEl.style.height = '700px';
  
  windowEl.innerHTML = 
    '<div class="window-titlebar">' +
      '<div class="window-controls">' +
        '<div class="window-control close"></div>' +
        '<div class="window-control minimize"></div>' +
        '<div class="window-control maximize"></div>' +
      '</div>' +
      '<div class="window-title">' +
        '<i class="fas fa-cog" style="margin-right: 8px;"></i>' +
        'Settings' +
      '</div>' +
    '</div>' +
    '<div class="window-content" style="padding: 0; background: transparent;">' +
      createSettingsContent() +
    '</div>';
  
  const desktop = document.getElementById('desktop');
  if (desktop) {
    desktop.appendChild(windowEl);
  }
  activeWindows.set(title, windowId);
  focusWindow(windowId);
  
  setupWindowEvents(windowEl, windowId, title);
  setupSettingsEvents(windowEl);
}

// Create settings content - REDESIGNED UNIQUE UI
function createSettingsContent() {
  return `
    <style>
      /* X-ORBIT Unique Settings UI */
      .xorbit-settings-container {
        height: 100%;
        display: flex;
        background: linear-gradient(135deg, rgba(10, 5, 30, 0.95) 0%, rgba(15, 10, 40, 0.95) 100%);
        overflow: hidden;
      }
      
      /* Sidebar Navigation */
      .settings-sidebar {
        width: 240px;
        background: rgba(20, 15, 40, 0.6);
        border-right: 1px solid rgba(120, 80, 255, 0.15);
        padding: 24px 16px;
        overflow-y: auto;
      }
      
      .settings-logo {
        text-align: center;
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 1px solid rgba(120, 80, 255, 0.2);
      }
      
      .settings-logo i {
        font-size: 2.5rem;
        color: #7d5cff;
        margin-bottom: 12px;
        display: block;
        animation: settingsLogoSpin 8s linear infinite;
      }
      
      @keyframes settingsLogoSpin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      .settings-logo-text {
        font-size: 1.1rem;
        font-weight: 700;
        color: #e8f0ff;
        letter-spacing: 2px;
      }
      
      .settings-nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        margin-bottom: 8px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        color: #a8b4d9;
        font-size: 0.95rem;
        font-weight: 500;
        position: relative;
        overflow: hidden;
      }
      
      .settings-nav-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(180deg, #7d5cff 0%, #3c82ff 100%);
        transform: scaleY(0);
        transition: transform 0.3s ease;
      }
      
      .settings-nav-item:hover {
        background: rgba(120, 80, 255, 0.15);
        color: #e8f0ff;
        transform: translateX(4px);
      }
      
      .settings-nav-item.active {
        background: rgba(120, 80, 255, 0.25);
        color: #ffffff;
        box-shadow: 0 4px 16px rgba(120, 80, 255, 0.3);
      }
      
      .settings-nav-item.active::before {
        transform: scaleY(1);
      }
      
      .settings-nav-item i {
        font-size: 1.1rem;
        width: 24px;
        text-align: center;
      }
      
      /* Main Content Area */
      .settings-main {
  flex: 1;
  padding: 32px 40px;
  overflow-y: auto;
  position: relative;  /* Add this line */
}
      
      .settings-header {
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 2px solid rgba(120, 80, 255, 0.2);
      }
      
      .settings-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #e8f0ff;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 16px;
      }
      
      .settings-header h1 i {
        color: #7d5cff;
        font-size: 1.8rem;
      }
      
      .settings-header p {
        color: #a8b4d9;
        font-size: 0.95rem;
        margin-left: 52px;
      }
      
      /* Settings Grid */
      .settings-grid {
        display: grid;
        gap: 24px;
      }
      
      /* Setting Card */
      .setting-card {
        background: rgba(30, 25, 50, 0.4);
        border: 1px solid rgba(120, 80, 255, 0.2);
        border-radius: 16px;
        padding: 24px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      
      .setting-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #7d5cff 0%, #3c82ff 100%);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
      }
      
      .setting-card:hover {
        border-color: rgba(120, 80, 255, 0.4);
        box-shadow: 0 8px 32px rgba(120, 80, 255, 0.2);
        transform: translateY(-2px);
      }
      
      .setting-card:hover::before {
        transform: scaleX(1);
      }
      
      .setting-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
      }
      
      .setting-card-title {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .setting-card-icon {
        width: 42px;
        height: 42px;
        background: linear-gradient(135deg, rgba(120, 80, 255, 0.2) 0%, rgba(60, 130, 255, 0.2) 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #7d5cff;
        font-size: 1.2rem;
      }
      
      .setting-card-label {
        font-size: 1.15rem;
        font-weight: 600;
        color: #e8f0ff;
      }
      
      .setting-card-desc {
        color: #a8b4d9;
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 20px;
      }
      
      /* Modern Toggle Switch */
      .xorbit-toggle {
        position: relative;
        width: 56px;
        height: 32px;
        background: rgba(120, 80, 255, 0.2);
        border: 2px solid rgba(120, 80, 255, 0.3);
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .xorbit-toggle::before {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 22px;
        height: 22px;
        background: #ffffff;
        border-radius: 50%;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      
      .xorbit-toggle.active {
        background: linear-gradient(135deg, #7d5cff 0%, #3c82ff 100%);
        border-color: rgba(120, 80, 255, 0.6);
        box-shadow: 0 0 20px rgba(120, 80, 255, 0.4);
      }
      
      .xorbit-toggle.active::before {
        transform: translateX(24px);
      }
      
      /* Modern Select Dropdown */
      .xorbit-select {
        position: relative;
        width: 100%;
      }
      
      .xorbit-select select {
        width: 100%;
        padding: 12px 16px;
        background: rgba(120, 80, 255, 0.1);
        border: 2px solid rgba(120, 80, 255, 0.3);
        border-radius: 12px;
        color: #e8f0ff;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        appearance: none;
      }
      
      .xorbit-select select:hover {
        border-color: rgba(120, 80, 255, 0.5);
        background: rgba(120, 80, 255, 0.15);
      }
      
      .xorbit-select select:focus {
        outline: none;
        border-color: rgba(120, 80, 255, 0.7);
        box-shadow: 0 0 20px rgba(120, 80, 255, 0.3);
      }
      
      .xorbit-select::after {
        content: '\\f078';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #7d5cff;
        pointer-events: none;
      }
      
      /* Modern Slider */
      .xorbit-slider-container {
        width: 100%;
      }
      
      .xorbit-slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: rgba(120, 80, 255, 0.2);
        outline: none;
        appearance: none;
        cursor: pointer;
        position: relative;
      }
      
      .xorbit-slider::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #7d5cff 0%, #3c82ff 100%);
        cursor: pointer;
        box-shadow: 0 0 15px rgba(120, 80, 255, 0.6), 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: all 0.2s ease;
      }
      
      .xorbit-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 0 25px rgba(120, 80, 255, 0.8), 0 6px 12px rgba(0, 0, 0, 0.4);
      }
      
      .xorbit-slider-value {
        text-align: center;
        margin-top: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        color: #7d5cff;
      }
      
      /* Wallpaper Controls */
      .wallpaper-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      
      .xorbit-button {
        padding: 12px 20px;
        background: rgba(120, 80, 255, 0.15);
        border: 2px solid rgba(120, 80, 255, 0.3);
        border-radius: 12px;
        color: #e8f0ff;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .xorbit-button:hover {
        background: rgba(120, 80, 255, 0.25);
        border-color: rgba(120, 80, 255, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(120, 80, 255, 0.3);
      }
      
      .xorbit-button.danger {
        background: rgba(255, 87, 87, 0.15);
        border-color: rgba(255, 87, 87, 0.3);
        color: #ff6b6b;
      }
      
      .xorbit-button.danger:hover {
        background: rgba(255, 87, 87, 0.25);
        border-color: rgba(255, 87, 87, 0.5);
      }
      
      /* Wallpaper Preview */
      .wallpaper-preview {
        margin-top: 16px;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid rgba(120, 80, 255, 0.3);
        display: none;
      }
      
      .wallpaper-preview img {
        width: 100%;
        height: auto;
        display: block;
      }
      
      /* Reset Button */
      .reset-all-button {
        width: 100%;
        padding: 16px 24px;
        background: rgba(255, 87, 87, 0.1);
        border: 2px solid rgba(255, 87, 87, 0.4);
        border-radius: 12px;
        color: #ff6b6b;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-top: 32px;
      }
      
      .reset-all-button:hover {
        background: rgba(255, 87, 87, 0.2);
        border-color: rgba(255, 87, 87, 0.6);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(255, 87, 87, 0.3);
      }
      
      /* Save Indicator */
      .xorbit-save-indicator {
        position: fixed;
        top: 80px;
        right: 40px;
        background: rgba(40, 202, 66, 0.95);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        transform: translateX(200px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10000;
        pointer-events: none;
        box-shadow: 0 8px 32px rgba(40, 202, 66, 0.4);
      }
      
      .xorbit-save-indicator.show {
        opacity: 1;
        transform: translateX(0);
      }
      
      /* Section Visibility */
      .settings-section {
        display: none;
      }
      
      .settings-section.active {
        display: block;
        animation: settingsFadeIn 0.4s ease;
      }
      
      @keyframes settingsFadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* Scrollbar Styling */
      .settings-sidebar::-webkit-scrollbar,
      .settings-main::-webkit-scrollbar {
        width: 8px;
      }
      
      .settings-sidebar::-webkit-scrollbar-track,
      .settings-main::-webkit-scrollbar-track {
        background: rgba(120, 80, 255, 0.1);
        border-radius: 4px;
      }
      
      .settings-sidebar::-webkit-scrollbar-thumb,
      .settings-main::-webkit-scrollbar-thumb {
        background: rgba(120, 80, 255, 0.4);
        border-radius: 4px;
      }
      
      .settings-sidebar::-webkit-scrollbar-thumb:hover,
      .settings-main::-webkit-scrollbar-thumb:hover {
        background: rgba(120, 80, 255, 0.6);
      }
    </style>
    
    <div class="xorbit-settings-container">
      <!-- Sidebar Navigation -->
      <div class="settings-sidebar">
        <div class="settings-logo">
          <i class="fas fa-cog"></i>
          <div class="settings-logo-text">X-ORBIT</div>
        </div>
        
        <div class="settings-nav-item active" data-section="appearance">
          <i class="fas fa-palette"></i>
          <span>Appearance</span>
        </div>
        
        <div class="settings-nav-item" data-section="dock">
          <i class="fas fa-grip-horizontal"></i>
          <span>Dock</span>
        </div>
        
        <div class="settings-nav-item" data-section="windows">
          <i class="fas fa-window-restore"></i>
          <span>Windows</span>
        </div>
        
        <div class="settings-nav-item" data-section="system">
          <i class="fas fa-sliders-h"></i>
          <span>System</span>
        </div>
      </div>
      
      <!-- Main Content -->
      <div class="settings-main">
        <!-- Appearance Section -->
        <div class="settings-section active" id="appearance-section">
          <div class="settings-header">
            <h1><i class="fas fa-palette"></i> Appearance</h1>
            <p>Customize the look and feel of your X-ORBIT desktop</p>
          </div>
          
          <div class="settings-grid">
            <!-- Theme -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-moon"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Theme</div>
                  </div>
                </div>
              </div>
              <div class="setting-card-desc">
                Choose your preferred color scheme for the desktop environment
              </div>
              <div class="xorbit-select">
                <select id="themeSelect">
                  <option value="dark">Dark Mode</option>
                  <option value="light">Light Mode</option>
                  <option value="orange">Halloween 2025</option>
                  <option value="auto">Auto (System)</option>
                </select>
              </div>
            </div>
            
            <!-- Desktop Wallpaper -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-image"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Desktop Wallpaper</div>
                  </div>
                </div>
              </div>
              <div class="setting-card-desc">
                Upload a custom background image or use the default X-ORBIT globe
              </div>
              <input type="file" id="wallpaperUpload" accept="image/*" style="display: none;">
              <div class="wallpaper-controls">
                <button class="xorbit-button" onclick="document.getElementById('wallpaperUpload').click();">
                  <i class="fas fa-upload"></i>
                  Choose Image
                </button>
                <button class="xorbit-button danger" onclick="resetWallpaper();">
                  <i class="fas fa-undo"></i>
                  Reset Default
                </button>
              </div>
              <div class="wallpaper-preview" id="wallpaperPreview">
                <img id="wallpaperPreviewImg" alt="Wallpaper preview">
              </div>
            </div>
            
            <!-- Transparency -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-adjust"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Transparency Effects</div>
                  </div>
                </div>
                <div class="xorbit-toggle active" id="transparencyToggle"></div>
              </div>
              <div class="setting-card-desc">
                Enable glass morphism and backdrop blur effects for windows and dock
              </div>
            </div>
            
            <!-- Animations -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-magic"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Animations</div>
                  </div>
                </div>
                <div class="xorbit-toggle active" id="animationsToggle"></div>
              </div>
              <div class="setting-card-desc">
                Enable smooth animations and transitions throughout the interface
              </div>
            </div>
            
            <!-- Background Opacity -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-tint"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Background Opacity</div>
                  </div>
                </div>
              </div>
              <div class="setting-card-desc">
                Adjust the transparency level of window backgrounds
              </div>
              <div class="xorbit-slider-container">
                <input type="range" class="xorbit-slider" id="opacityRange" min="20" max="100" value="80">
                <div class="xorbit-slider-value" id="opacityValue">80%</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Dock Section -->
        <div class="settings-section" id="dock-section">
          <div class="settings-header">
            <h1><i class="fas fa-grip-horizontal"></i> Dock</h1>
            <p>Configure your application dock behavior and appearance</p>
          </div>
          
          <div class="settings-grid">
            <!-- Auto-hide -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-eye-slash"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Auto-hide Dock</div>
                  </div>
                </div>
                <div class="xorbit-toggle" id="autohideToggle"></div>
              </div>
              <div class="setting-card-desc">
                Automatically hide the dock when not in use to maximize screen space
              </div>
            </div>
            
            <!-- Position -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-arrows-alt"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Dock Position</div>
                  </div>
                </div>
              </div>
              <div class="setting-card-desc">
                Choose where the dock appears on your screen
              </div>
              <div class="xorbit-select">
                <select id="dockPositionSelect">
                  <option value="bottom">Bottom</option>
                  <option value="left">Left</option>
                </select>
              </div>
            </div>
            
            <!-- Size -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-expand-arrows-alt"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Dock Size</div>
                  </div>
                </div>
              </div>
              <div class="setting-card-desc">
                Adjust the size of dock icons
              </div>
              <div class="xorbit-slider-container">
                <input type="range" class="xorbit-slider" id="dockSizeRange" min="40" max="80" value="56">
                <div class="xorbit-slider-value" id="dockSizeValue">56px</div>
              </div>
            </div>
            
            <!-- Magnification -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-search-plus"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Hover Magnification</div>
                  </div>
                </div>
                <div class="xorbit-toggle active" id="magnificationToggle"></div>
              </div>
              <div class="setting-card-desc">
                Enable zoom effect when hovering over dock icons
              </div>
            </div>
          </div>
        </div>
        
        <!-- Windows Section -->
        <div class="settings-section" id="windows-section">
          <div class="settings-header">
            <h1><i class="fas fa-window-restore"></i> Windows</h1>
            <p>Manage window behavior and startup preferences</p>
          </div>
          
          <div class="settings-grid">
            <!-- Window Snapping -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-th-large"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Window Snapping</div>
                  </div>
                </div>
                <div class="xorbit-toggle active" id="snappingToggle"></div>
              </div>
              <div class="setting-card-desc">
                Snap windows to screen edges for organized workspace management
              </div>
            </div>
            
            <!-- Window Shadows -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-cube"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Window Shadows</div>
                  </div>
                </div>
                <div class="xorbit-toggle active" id="shadowsToggle"></div>
              </div>
              <div class="setting-card-desc">
                Enable drop shadows to add depth to window elements
              </div>
            </div>
            
            <!-- Launch Fullscreen -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-expand"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Launch in Fullscreen</div>
                  </div>
                </div>
                <div class="xorbit-toggle" id="launchFullscreenToggle"></div>
              </div>
              <div class="setting-card-desc">
                Start X-ORBIT in fullscreen mode for an immersive experience
              </div>
            </div>
            
            <!-- Startup Window -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-rocket"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Startup Window</div>
                  </div>
                </div>
              </div>
              <div class="setting-card-desc">
                Choose which window opens automatically when X-ORBIT starts
              </div>
              <div class="xorbit-select">
                <select id="startupWindowsSelect">
                  <option value="welcome">Welcome Screen</option>
                  <option value="none">None (Disabled)</option>
                  <option value="browser">Browser</option>
                  <option value="terminal">Terminal</option>
                  <option value="settings">Settings</option>
                  <option value="files">File Manager</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <!-- System Section -->
        <div class="settings-section" id="system-section">
          <div class="settings-header">
            <h1><i class="fas fa-sliders-h"></i> System</h1>
            <p>Advanced system settings and configurations</p>
          </div>
          
          <div class="settings-grid">
            <!-- Software Update Card -->
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-sync-alt"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">Software Update</div>
                  </div>
                </div>
              </div>
              <div class="setting-card-desc">
                Check for the latest version of X-ORBIT Desktop
              </div>
              
              <div id="updateCheckContainer" style="margin-top: 16px;">
                <div id="updateCheckStatus" style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
                  <div style="color: #a8b4d9; text-align: center;">
                    <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                    Checking for updates...
                  </div>
                </div>
                
                <!-- Update Available UI (hidden by default) -->
                <div id="updateAvailable" style="display: none;">
                  <div style="background: rgba(40, 202, 66, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(40, 202, 66, 0.3); margin-bottom: 16px;">
                    <div style="color: #28ca42; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                      <i class="fas fa-arrow-circle-up"></i>
                      <span>Update Available</span>
                    </div>
                    <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
                      <strong id="updateVersionName">X-ORBIT Desktop 4.6.0 Beta</strong>
                    </div>
                    <div style="color: #a8b4d9; font-size: 0.85rem;">
                      Version: <span id="updateVersionNumber">4.6.0</span> ‚Ä¢ Size: <span id="updateSize">Loading...</span>
                    </div>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="xorbit-button" id="updateLaterBtn" style="background: rgba(120, 80, 255, 0.1);">
                      <i class="fas fa-clock"></i>
                      Update on Close
                    </button>
                    <button class="xorbit-button" id="updateNowBtn" style="background: linear-gradient(135deg, #28ca42 0%, #20a03a 100%); border-color: rgba(40, 202, 66, 0.5);">
                      <i class="fas fa-download"></i>
                      Update Now
                    </button>
                  </div>
                </div>
                
                <!-- Up to Date UI (hidden by default) -->
                <div id="upToDate" style="display: none;">
                  <div style="background: rgba(40, 202, 66, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(40, 202, 66, 0.3); text-align: center;">
                    <div style="color: #28ca42; font-weight: 600; margin-bottom: 8px;">
                      <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                      You're up to date!
                    </div>
                    <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
                      <strong>X-ORBIT Desktop 4.6.0 Astra</strong>
                    </div>
                    <div style="color: #a8b4d9; font-size: 0.85rem;">
                      You have the latest version installed
                    </div>
                  </div>
                  
                  <button class="xorbit-button" id="recheckUpdateBtn" style="width: 100%; margin-top: 12px;">
                    <i class="fas fa-sync"></i>
                    Check Again
                  </button>
                </div>
                
                <!-- Error UI (hidden by default) -->
                <div id="updateError" style="display: none;">
                  <div style="background: rgba(255, 87, 87, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(255, 87, 87, 0.3); text-align: center;">
                    <div style="color: #ff5757; font-weight: 600; margin-bottom: 8px;">
                      <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                      Update Check Failed
                    </div>
                    <div style="color: #a8b4d9; font-size: 0.85rem;">
                      Unable to connect to update servers
                    </div>
                  </div>
                  
                  <button class="xorbit-button" id="retryUpdateBtn" style="width: 100%; margin-top: 12px;">
                    <i class="fas fa-redo"></i>
                    Retry
                  </button>
                </div>
              </div>
            </div>
            
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon">
                    <i class="fas fa-info-circle"></i>
                  </div>
                  <div>
                    <div class="setting-card-label">About X-ORBIT</div>
                  </div>
                </div>
              </div>
              <div class="setting-card-desc">
                Version 4.6.0 Astra ‚Ä¢ Built by Demitri Burns
              </div>
            </div>
            
            <button class="reset-all-button" id="resetButton">
              <i class="fas fa-undo-alt"></i>
              Reset All Settings to Default
            </button>
          </div>
        </div>
        
        <div class="xorbit-save-indicator" id="saveIndicator">
          <i class="fas fa-check-circle"></i>
          Settings saved!
        </div>
      </div>
    </div>
  `;
}

// Setup settings event handlers
// Setup settings event handlers
function setupSettingsEvents(windowEl) {
  const settingsContent = windowEl.querySelector('.window-content');
  
  // Navigation
  const navItems = settingsContent.querySelectorAll('.settings-nav-item');
  navItems.forEach(item => {
    item.addEventListener('click', function() {
      // Update active state
      navItems.forEach(nav => nav.classList.remove('active'));
      this.classList.add('active');
      
      // Show corresponding section
      const section = this.dataset.section;
      const sections = settingsContent.querySelectorAll('.settings-section');
      sections.forEach(sec => sec.classList.remove('active'));
      settingsContent.querySelector(`#${section}-section`).classList.add('active');
      
      // If System section, check for updates
      if (section === 'system') {
        setTimeout(() => {
          checkForSystemUpdates();
        }, 300);
      }
    });
  });
  
  // Load current settings into UI
  function loadSettingsUI() {
    const themeSelect = settingsContent.querySelector('#themeSelect');
    const transparencyToggle = settingsContent.querySelector('#transparencyToggle');
    const animationsToggle = settingsContent.querySelector('#animationsToggle');
    const opacityRange = settingsContent.querySelector('#opacityRange');
    const opacityValue = settingsContent.querySelector('#opacityValue');
    const autohideToggle = settingsContent.querySelector('#autohideToggle');
    const dockPositionSelect = settingsContent.querySelector('#dockPositionSelect');
    const dockSizeRange = settingsContent.querySelector('#dockSizeRange');
    const dockSizeValue = settingsContent.querySelector('#dockSizeValue');
    const magnificationToggle = settingsContent.querySelector('#magnificationToggle');
    const snappingToggle = settingsContent.querySelector('#snappingToggle');
    const shadowsToggle = settingsContent.querySelector('#shadowsToggle');
    const launchFullscreenToggle = settingsContent.querySelector('#launchFullscreenToggle');
    const startupWindowsSelect = settingsContent.querySelector('#startupWindowsSelect');
    
    if (themeSelect) themeSelect.value = settings.theme;
    if (transparencyToggle) transparencyToggle.classList.toggle('active', settings.transparency);
    if (animationsToggle) animationsToggle.classList.toggle('active', settings.animations);
    if (opacityRange) {
      opacityRange.value = settings.backgroundOpacity;
      if (opacityValue) opacityValue.textContent = settings.backgroundOpacity + '%';
    }
    if (autohideToggle) autohideToggle.classList.toggle('active', settings.dockAutohide);
    if (dockPositionSelect) dockPositionSelect.value = settings.dockPosition;
    if (dockSizeRange) {
      dockSizeRange.value = settings.dockSize;
      if (dockSizeValue) dockSizeValue.textContent = settings.dockSize + 'px';
    }
    if (magnificationToggle) magnificationToggle.classList.toggle('active', settings.dockMagnification);
    if (snappingToggle) snappingToggle.classList.toggle('active', settings.windowSnapping);
    if (shadowsToggle) shadowsToggle.classList.toggle('active', settings.windowShadows);
    if (launchFullscreenToggle) launchFullscreenToggle.classList.toggle('active', settings.launchFullscreen);
    if (startupWindowsSelect) startupWindowsSelect.value = settings.startupWindows || 'welcome';
    
    // Update wallpaper preview if custom wallpaper is set
    if (settings.customWallpaper) {
      updateWallpaperPreview(settings.customWallpaper);
    }
  }
  
  // Save settings
  function saveSettings() {
    localStorage.setItem('xorbit-settings', JSON.stringify(settings));
    applySettings();
    showSaveIndicator();
  }
  
  // Show save indicator
  function showSaveIndicator() {
    const indicator = settingsContent.querySelector('#saveIndicator');
    if (indicator) {
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 2000);
    }
  }
  
  // Load initial settings
  loadSettingsUI();
  
  // Theme select
  const themeSelect = settingsContent.querySelector('#themeSelect');
  if (themeSelect) {
    themeSelect.addEventListener('change', function() {
      settings.theme = this.value;
      loadTheme(this.value);
      saveSettings();
    });
  }
  
  // Toggle switches
  settingsContent.querySelectorAll('.xorbit-toggle').forEach(toggle => {
    toggle.addEventListener('click', function() {
      const isActive = this.classList.contains('active');
      this.classList.toggle('active', !isActive);
      
      const setting = this.id.replace('Toggle', '');
      switch (setting) {
        case 'transparency':
          settings.transparency = !isActive;
          break;
        case 'animations':
          settings.animations = !isActive;
          break;
        case 'autohide':
          settings.dockAutohide = !isActive;
          break;
        case 'magnification':
          settings.dockMagnification = !isActive;
          break;
        case 'snapping':
          settings.windowSnapping = !isActive;
          break;
        case 'shadows':
          settings.windowShadows = !isActive;
          break;
        case 'launchFullscreen':
          settings.launchFullscreen = !isActive;
          break;
      }
      
      saveSettings();
    });
  });
  
  // Dock position select
  const dockPositionSelect = settingsContent.querySelector('#dockPositionSelect');
  if (dockPositionSelect) {
    dockPositionSelect.addEventListener('change', function() {
      settings.dockPosition = this.value;
      saveSettings();
    });
  }
  
  // Startup windows select
  const startupWindowsSelect = settingsContent.querySelector('#startupWindowsSelect');
  if (startupWindowsSelect) {
    startupWindowsSelect.addEventListener('change', function() {
      settings.startupWindows = this.value;
      saveSettings();
    });
  }
  
  // Range sliders
  const opacityRange = settingsContent.querySelector('#opacityRange');
  const opacityValue = settingsContent.querySelector('#opacityValue');
  if (opacityRange && opacityValue) {
    opacityRange.addEventListener('input', function() {
      settings.backgroundOpacity = parseInt(this.value);
      opacityValue.textContent = this.value + '%';
      saveSettings();
    });
  }
  
  const dockSizeRange = settingsContent.querySelector('#dockSizeRange');
  const dockSizeValue = settingsContent.querySelector('#dockSizeValue');
  if (dockSizeRange && dockSizeValue) {
    dockSizeRange.addEventListener('input', function() {
      settings.dockSize = parseInt(this.value);
      dockSizeValue.textContent = this.value + 'px';
      saveSettings();
    });
  }
  
  // Reset button
  const resetButton = settingsContent.querySelector('#resetButton');
  if (resetButton) {
    resetButton.addEventListener('click', function() {
      if (confirm('Reset all settings to default? This cannot be undone.')) {
        settings = {
          theme: 'dark',
          transparency: true,
          animations: true,
          backgroundOpacity: 80,
          dockAutohide: false,
          dockPosition: 'bottom',
          dockSize: 56,
          dockMagnification: true,
          dockTooltips: true,
          windowSnapping: true,
          windowShadows: true,
          launchFullscreen: false,
          customWallpaper: null,
          startupWindows: 'welcome'
        };
        loadSettingsUI();
        saveSettings();
      }
    });
  }
  
  // Wallpaper upload listener
  const wallpaperUpload = settingsContent.querySelector('#wallpaperUpload');
  if (wallpaperUpload) {
    wallpaperUpload.addEventListener('change', function(event) {
      event.preventDefault();
      event.stopPropagation();
      handleWallpaperUpload(event);
    });
  }
  
  // Setup update handlers - THIS IS THE KEY FIX
  setupUpdateHandlers(settingsContent);
  
  // Check for updates immediately if System section is visible
  const systemSection = settingsContent.querySelector('#system-section');
  if (systemSection && systemSection.classList.contains('active')) {
    setTimeout(() => {
      checkForSystemUpdates();
    }, 500);
  }
}

// Helper function to enter fullscreen with browser compatibility
function enterFullscreen() {
  const elem = document.documentElement;
  
  if (elem.requestFullscreen) {
    elem.requestFullscreen().catch(err => {
      console.log('Fullscreen request failed:', err);
    });
  } else if (elem.webkitRequestFullscreen) { // Safari
    elem.webkitRequestFullscreen().catch(err => {
      console.log('Webkit fullscreen request failed:', err);
    });
  } else if (elem.msRequestFullscreen) { // IE11
    elem.msRequestFullscreen().catch(err => {
      console.log('MS fullscreen request failed:', err);
    });
  } else if (elem.mozRequestFullScreen) { // Firefox
    elem.mozRequestFullScreen().catch(err => {
      console.log('Moz fullscreen request failed:', err);
    });
  } else {
    console.log('Fullscreen API not supported by this browser');
  }
}

// Startup Sequence
function playStartupSequence() {
  const startupScreen = document.getElementById('startupScreen');
  const welcomeOverlay = document.getElementById('welcomeOverlay');
  const progressBar = document.getElementById('startupProgress');
  const statusText = document.getElementById('startupStatus');
  
  // Show startup screen
  if (startupScreen) startupScreen.style.display = 'flex';
  if (welcomeOverlay) welcomeOverlay.style.display = 'none';
  
  // Create audio elements for startup sounds
  // Replace these URLs with your actual audio file URLs, or leave as-is to use generated sounds
  const STARTUP_SOUND_URL = 'https://codehs.com/uploads/a65c34b976260e021c991377c09738d7';
  const COMPLETION_SOUND_URL = 'https://codehs.com/uploads/08141181768ff6fbd3e7d9afe655e00b';
  
  const useGeneratedSounds = STARTUP_SOUND_URL.includes('your-audio-url.com');
  
  // Web Audio API for generated sounds (fallback)
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  
  function playGeneratedStartupSound() {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
    oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.5); // A5
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.2);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 1.2);
  }
  
  function playGeneratedCompletionSound() {
    // Create a pleasant three-note chime
    const times = [0, 0.15, 0.3];
    const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
    
    times.forEach((time, i) => {
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(frequencies[i], audioContext.currentTime + time);
      
      gainNode.gain.setValueAtTime(0.2, audioContext.currentTime + time);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.4);
      
      oscillator.start(audioContext.currentTime + time);
      oscillator.stop(audioContext.currentTime + time + 0.4);
    });
  }
  
  // Play startup sound
  if (useGeneratedSounds) {
    // Use generated sound
    try {
      playGeneratedStartupSound();
    } catch (e) {
      console.log('Generated audio playback failed:', e);
    }
  } else {
    // Use MP3 files
    const startupAudio = new Audio(STARTUP_SOUND_URL);
    startupAudio.volume = 0.5;
    startupAudio.onerror = function() {
      console.log('Failed to load startup audio from:', STARTUP_SOUND_URL);
      // Fallback to generated sound
      try {
        playGeneratedStartupSound();
      } catch (e) {
        console.log('Fallback audio also failed:', e);
      }
    };
    startupAudio.play().catch(e => {
      console.log('Startup audio playback failed:', e);
    });
  }
  
  // Simulate loading sequence (minimum 5 seconds, max 30 seconds)
  const loadingSteps = [
    { progress: 10, text: 'Initializing system...', delay: 500 },
    { progress: 20, text: 'Loading core systems...', delay: 600 },
    { progress: 35, text: 'Initializing graphics engine...', delay: 700 },
    { progress: 50, text: 'Loading user interface...', delay: 800 },
    { progress: 65, text: 'Configuring desktop environment...', delay: 700 },
    { progress: 80, text: 'Loading applications...', delay: 600 },
    { progress: 95, text: 'Finalizing startup...', delay: 500 },
    { progress: 100, text: 'Ready!', delay: 600 }
  ];
  
  let currentStep = 0;
  
  function nextStep() {
    if (currentStep >= loadingSteps.length) {
      // Startup complete - play completion sound and show continue button
      setTimeout(() => {
        if (useGeneratedSounds) {
          // Use generated sound
          try {
            playGeneratedCompletionSound();
          } catch (e) {
            console.log('Generated completion audio failed:', e);
          }
        } else {
          // Use MP3 file
          const completionAudio = new Audio(COMPLETION_SOUND_URL);
          completionAudio.volume = 0.5;
          completionAudio.onerror = function() {
            console.log('Failed to load completion audio from:', COMPLETION_SOUND_URL);
            // Fallback to generated sound
            try {
              playGeneratedCompletionSound();
            } catch (e) {
              console.log('Fallback audio also failed:', e);
            }
          };
          completionAudio.play().catch(e => {
            console.log('Completion audio playback failed:', e);
          });
        }
        
        // Show the continue button
        const continueBtn = document.getElementById('startupContinueBtn');
        if (continueBtn) {
          statusText.textContent = 'System ready!';
          setTimeout(() => {
            continueBtn.style.display = 'flex';
          }, 300);
        }
        
        // Set up continue button click handler
        continueBtn.onclick = function() {
          // Enter fullscreen with user interaction
          enterFullscreen();
          
          // Fade out startup screen
          startupScreen.classList.add('fade-out');
          
          setTimeout(() => {
            startupScreen.style.display = 'none';
            
            // Show and fade in the login page
            if (welcomeOverlay) {
              welcomeOverlay.style.display = 'flex';
              
              // Trigger fade-in after a brief delay
              setTimeout(() => {
                welcomeOverlay.classList.add('fade-in');
              }, 50);
            }
          }, 800);
        };
      }, 500);
      return;
    }
    
    const step = loadingSteps[currentStep];
    progressBar.style.width = step.progress + '%';
    statusText.textContent = step.text;
    
    currentStep++;
    setTimeout(nextStep, step.delay);
  }
  
  // Start loading sequence after a brief delay
  setTimeout(nextStep, 800);
}

// DOM Content Loaded
document.addEventListener('DOMContentLoaded', function() {
  // Load settings first
  loadSettings();
  
  // Start startup sequence
  playStartupSequence();
  
  setupXORBITMenu();
  setupUserMenu();
  setupWifiMenu();
  setupUtilitiesMenu();
  setupTimeMenu();
  getUserLocation();
  
  // Setup dock hover effects
  const dockItems = document.querySelectorAll('.dock-item');
  dockItems.forEach(function(item) {
    if (item) {
      item.addEventListener('mouseenter', function() {
        if (settings.dockMagnification) {
          this.style.transform = 'translateY(-8px) scale(1.15)';
        }
      });
      
      item.addEventListener('mouseleave', function() {
        if (!this.classList.contains('active')) {
          this.style.transform = 'translateY(0) scale(1)';
        }
      });
    }
  });
});

// Setup time menu functionality
function setupTimeMenu() {
  const timeMenuButton = document.getElementById('timeMenu');
  const timeDropdown = document.getElementById('timeDropdown');
  
  if (timeMenuButton && timeDropdown) {
    timeMenuButton.addEventListener('click', function(e) {
      e.stopPropagation();
      const isVisible = timeDropdown.classList.contains('show');
      
      // Hide all other menus first
      document.querySelectorAll('.xorbit-menu.show, .time-menu.show').forEach(menu => {
        menu.classList.remove('show');
      });
      
      if (!isVisible) {
        timeDropdown.classList.add('show');
        updateWeatherDisplay();
      }
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', function() {
      timeDropdown.classList.remove('show');
      // Also close X-ORBIT menu if open
      const xorbitDropdown = document.getElementById('xorbitDropdown');
      if (xorbitDropdown) {
        xorbitDropdown.classList.remove('show');
      }
    });
    
    // Prevent menu from closing when clicking inside
    timeDropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }
}

// Get user location
function getUserLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        userLocation.lat = position.coords.latitude;
        userLocation.lon = position.coords.longitude;
        
        // Reverse geocoding to get city name (simplified)
        reverseGeocode(userLocation.lat, userLocation.lon);
        
        // Get weather for the location
        getWeatherData();
      },
      function(error) {
        console.log('Location access denied, using default location');
        // Use default Casper, Wyoming location
        getWeatherData();
      }
    );
  } else {
    console.log('Geolocation not supported');
    getWeatherData();
  }
}

// Simplified reverse geocoding (you would use a real service)
function reverseGeocode(lat, lon) {
  // This is a simplified example. In production, use a real geocoding service
  const locations = [
    { lat: 42.8666, lon: -106.3130, city: 'Casper', state: 'Wyoming' },
    { lat: 40.7128, lon: -74.0060, city: 'New York', state: 'New York' },
    { lat: 34.0522, lon: -118.2437, city: 'Los Angeles', state: 'California' },
    { lat: 41.8781, lon: -87.6298, city: 'Chicago', state: 'Illinois' },
    { lat: 29.7604, lon: -95.3698, city: 'Houston', state: 'Texas' }
  ];
  
  // Find closest location (simplified)
  let closestLocation = locations[0];
  let minDistance = getDistance(lat, lon, closestLocation.lat, closestLocation.lon);
  
  locations.forEach(location => {
    const distance = getDistance(lat, lon, location.lat, location.lon);
    if (distance < minDistance) {
      minDistance = distance;
      closestLocation = location;
    }
  });
  
  userLocation.city = closestLocation.city;
  userLocation.state = closestLocation.state;
}

// Calculate distance between two coordinates
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Radius of the Earth in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Get weather data (simulated - you would use a real weather API)
function getWeatherData() {
  // Simulate weather data based on location and time
  const hour = new Date().getHours();
  const season = getCurrentSeason();
  const weatherConditions = getWeatherForLocation(userLocation.city, season, hour);
  
  weatherData = {
    ...weatherData,
    ...weatherConditions
  };
  
  updateWeatherDisplay();
}

// Get current season
function getCurrentSeason() {
  const month = new Date().getMonth() + 1;
  if (month >= 3 && month <= 5) return 'spring';
  if (month >= 6 && month <= 8) return 'summer';
  if (month >= 9 && month <= 11) return 'autumn';
  return 'winter';
}

// Get weather based on location, season, and time
function getWeatherForLocation(city, season, hour) {
  const weatherPatterns = {
    'Casper': {
      winter: { temp: -2, desc: 'Snow Showers', icon: 'üå®Ô∏è', humidity: 78 },
      spring: { temp: 12, desc: 'Partly Cloudy', icon: '‚õÖ', humidity: 65 },
      summer: { temp: 26, desc: 'Sunny', icon: '‚òÄÔ∏è', humidity: 45 },
      autumn: { temp: 8, desc: 'Cloudy', icon: '‚òÅÔ∏è', humidity: 70 }
    },
    'New York': {
      winter: { temp: 2, desc: 'Overcast', icon: '‚òÅÔ∏è', humidity: 72 },
      spring: { temp: 18, desc: 'Partly Cloudy', icon: '‚õÖ', humidity: 68 },
      summer: { temp: 28, desc: 'Sunny', icon: '‚òÄÔ∏è', humidity: 65 },
      autumn: { temp: 15, desc: 'Rainy', icon: 'üåßÔ∏è', humidity: 80 }
    },
    'Los Angeles': {
      winter: { temp: 18, desc: 'Sunny', icon: '‚òÄÔ∏è', humidity: 55 },
      spring: { temp: 22, desc: 'Clear', icon: '‚òÄÔ∏è', humidity: 60 },
      summer: { temp: 32, desc: 'Hot', icon: 'üåû', humidity: 50 },
      autumn: { temp: 25, desc: 'Partly Cloudy', icon: '‚õÖ', humidity: 58 }
    }
  };
  
  const baseWeather = weatherPatterns[city] || weatherPatterns['Casper'];
  const seasonWeather = baseWeather[season];
  
  // Add some randomization and time-based variations
  const tempVariation = Math.floor(Math.random() * 6) - 3; // ¬±3 degrees
  const isNight = hour < 6 || hour > 20;
  
  return {
    temp: seasonWeather.temp + tempVariation + (isNight ? -3 : 0),
    description: seasonWeather.desc,
    icon: isNight && seasonWeather.icon === '‚òÄÔ∏è' ? 'üåô' : seasonWeather.icon,
    humidity: seasonWeather.humidity + Math.floor(Math.random() * 10) - 5,
    wind: Math.floor(Math.random() * 20) + 5,
    pressure: 1013 + Math.floor(Math.random() * 40) - 20,
    uvIndex: isNight ? 0 : Math.floor(Math.random() * 8) + 1
  };
}

// Update weather display
function updateWeatherDisplay() {
  const elements = {
    weatherIcon: document.getElementById('weatherIcon'),
    weatherTemp: document.getElementById('weatherTemp'),
    weatherDesc: document.getElementById('weatherDesc'),
    weatherLocation: document.getElementById('weatherLocation'),
    humidity: document.getElementById('humidity'),
    wind: document.getElementById('wind'),
    pressure: document.getElementById('pressure'),
    uvIndex: document.getElementById('uvIndex')
  };
  
  if (elements.weatherIcon) elements.weatherIcon.textContent = weatherData.icon;
  if (elements.weatherTemp) elements.weatherTemp.textContent = `${weatherData.temp}¬∞C`;
  if (elements.weatherDesc) elements.weatherDesc.textContent = weatherData.description;
  if (elements.weatherLocation) elements.weatherLocation.textContent = `${userLocation.city}, ${userLocation.state}`;
  if (elements.humidity) elements.humidity.textContent = `${weatherData.humidity}%`;
  if (elements.wind) elements.wind.textContent = `${weatherData.wind} mph`;
  if (elements.pressure) elements.pressure.textContent = `${weatherData.pressure} mb`;
  if (elements.uvIndex) elements.uvIndex.textContent = weatherData.uvIndex;
}

function setupWifiMenu() {
  const wifiMenuButton = document.getElementById('wifiMenu');
  const wifiDropdown = document.getElementById('wifiDropdown');
  
  if (wifiMenuButton && wifiDropdown) {
    wifiMenuButton.addEventListener('click', function(e) {
      e.stopPropagation();
      const isVisible = wifiDropdown.classList.contains('show');
      
      // Hide all other menus first
      document.querySelectorAll('.xorbit-menu.show').forEach(menu => {
        menu.classList.remove('show');
      });
      document.querySelectorAll('.time-menu.show').forEach(menu => {
        menu.classList.remove('show');
      });
      
      if (!isVisible) {
        wifiDropdown.classList.add('show');
        // Test network speed when menu opens
        testNetworkSpeed();
      }
    });
    
    // Prevent menu from closing when clicking inside
    wifiDropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }
  
  // Update network type
  updateNetworkType();
  
  // Monitor online/offline status
  window.addEventListener('online', updateNetworkStatus);
  window.addEventListener('offline', updateNetworkStatus);
  updateNetworkStatus();
}

function updateNetworkType() {
  const networkType = document.getElementById('networkType');
  if (!networkType) return;
  
  const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  if (connection && connection.effectiveType) {
    const typeMap = {
      'slow-2g': '2G (Slow)',
      '2g': '2G',
      '3g': '3G',
      '4g': '4G',
      '5g': '5G'
    };
    networkType.textContent = typeMap[connection.effectiveType] || connection.effectiveType.toUpperCase();
  } else {
    networkType.textContent = 'WiFi/Ethernet';
  }
}

function updateNetworkStatus() {
  const networkStatus = document.getElementById('networkStatus');
  const wifiIcon = document.getElementById('wifiIcon');
  
  if (!networkStatus || !wifiIcon) return;
  
  if (navigator.onLine) {
    networkStatus.innerHTML = '<i class="fas fa-check-circle"></i> Online';
    networkStatus.style.color = '#28ca42';
    wifiIcon.className = 'fas fa-wifi';
    wifiIcon.style.color = '';
  } else {
    networkStatus.innerHTML = '<i class="fas fa-times-circle"></i> Offline';
    networkStatus.style.color = '#ff5757';
    wifiIcon.className = 'fas fa-wifi-slash';
    wifiIcon.style.color = '#ff5757';
  }
}

async function testNetworkSpeed() {
  const pingLatency = document.getElementById('pingLatency');
  const jitterValue = document.getElementById('jitterValue');
  
  if (!pingLatency || !jitterValue) return;
  
  // Show loading state
  pingLatency.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
  jitterValue.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
  
  // Cloudflare's 1.1.1.1 DNS (use their speed test endpoint)
  const testUrl = 'https://1.1.1.1/cdn-cgi/trace';
  const pingTests = 5;
  const results = [];
  
  try {
    for (let i = 0; i < pingTests; i++) {
      const startTime = performance.now();
      
      try {
        const response = await fetch(testUrl, {
          method: 'GET',
          cache: 'no-cache'
        });
        
        if (response.ok) {
          const endTime = performance.now();
          const latency = Math.round(endTime - startTime);
          results.push(latency);
        }
      } catch (err) {
        console.warn('Ping test failed:', err);
      }
      
      // Small delay between tests
      if (i < pingTests - 1) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
    }
    
    if (results.length > 0) {
      // Calculate average ping
      const avgPing = Math.round(results.reduce((a, b) => a + b, 0) / results.length);
      
      // Calculate jitter (average deviation from mean)
      const jitter = results.length > 1 
        ? Math.round(results.reduce((sum, val) => sum + Math.abs(val - avgPing), 0) / results.length)
        : 0;
      
      // Display results with color coding
      const pingColor = avgPing < 50 ? '#28ca42' : avgPing < 100 ? '#ffd700' : '#ff5757';
      const jitterColor = jitter < 10 ? '#28ca42' : jitter < 30 ? '#ffd700' : '#ff5757';
      
      pingLatency.innerHTML = `<span style="color: ${pingColor};">${avgPing} ms</span>`;
      jitterValue.innerHTML = `<span style="color: ${jitterColor};">${jitter} ms</span>`;
    } else {
      pingLatency.innerHTML = '<span style="color: #ff5757;">Failed</span>';
      jitterValue.innerHTML = '<span style="color: #ff5757;">Failed</span>';
    }
  } catch (error) {
    console.error('Network test error:', error);
    pingLatency.innerHTML = '<span style="color: #ff5757;">Error</span>';
    jitterValue.innerHTML = '<span style="color: #ff5757;">Error</span>';
  }
}

function setupUtilitiesMenu() {
  const utilitiesMenuButton = document.getElementById('utilitiesMenu');
  const utilitiesDropdown = document.getElementById('utilitiesDropdown');
  
  if (utilitiesMenuButton && utilitiesDropdown) {
    utilitiesMenuButton.addEventListener('click', function(e) {
      e.stopPropagation();
      const isVisible = utilitiesDropdown.classList.contains('show');
      
      // Hide all other menus first
      document.querySelectorAll('.xorbit-menu.show').forEach(menu => {
        menu.classList.remove('show');
      });
      document.querySelectorAll('.time-menu.show').forEach(menu => {
        menu.classList.remove('show');
      });
      
      if (!isVisible) {
        utilitiesDropdown.classList.add('show');
        updateFullscreenText();
      }
    });
    
    // Prevent menu from closing when clicking inside
    utilitiesDropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }
  
  // Listen for fullscreen changes
  document.addEventListener('fullscreenchange', updateFullscreenText);
  document.addEventListener('webkitfullscreenchange', updateFullscreenText);
  document.addEventListener('mozfullscreenchange', updateFullscreenText);
  document.addEventListener('MSFullscreenChange', updateFullscreenText);
}

function toggleFullscreen() {
  if (!document.fullscreenElement && !document.webkitFullscreenElement && 
      !document.mozFullScreenElement && !document.msFullscreenElement) {
    // Enter fullscreen
    enterFullscreen();
  } else {
    // Exit fullscreen
    exitFullscreen();
  }
  
  // Close menu
  const dropdown = document.getElementById('utilitiesDropdown');
  if (dropdown) dropdown.classList.remove('show');
}

function exitFullscreen() {
  if (document.exitFullscreen) {
    document.exitFullscreen();
  } else if (document.webkitExitFullscreen) {
    document.webkitExitFullscreen();
  } else if (document.mozCancelFullScreen) {
    document.mozCancelFullScreen();
  } else if (document.msExitFullscreen) {
    document.msExitFullscreen();
  }
}

function updateFullscreenText() {
  const fullscreenIcon = document.getElementById('fullscreenIcon');
  const fullscreenText = document.getElementById('fullscreenText');
  
  if (!fullscreenIcon || !fullscreenText) return;
  
  const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || 
                       document.mozFullScreenElement || document.msFullscreenElement;
  
  if (isFullscreen) {
    fullscreenIcon.className = 'fas fa-compress';
    fullscreenText.textContent = 'Exit Fullscreen';
  } else {
    fullscreenIcon.className = 'fas fa-expand';
    fullscreenText.textContent = 'Enter Fullscreen';
  }
}

function refreshDesktop() {
  // Close menu
  const dropdown = document.getElementById('utilitiesDropdown');
  if (dropdown) dropdown.classList.remove('show');
  
  // Reload the page
  location.reload();
}

function openTaskManager() {
  // Close menu
  const dropdown = document.getElementById('utilitiesDropdown');
  if (dropdown) dropdown.classList.remove('show');
  
  // Create task manager content
  const taskContent = `
    <div style="padding: 24px;">
      <h2 style="color: #e8f0ff; margin-bottom: 24px; font-size: 1.4rem;">
        <i class="fas fa-tasks" style="margin-right: 12px; color: #7d5cff;"></i>
        Task Manager
      </h2>
      
      <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
        <div style="color: #7d5cff; font-weight: 600; margin-bottom: 12px;">Active Windows</div>
        <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 8px;">
          Open Windows: <strong>${activeWindows.size}</strong>
        </div>
        <div style="color: #a8b4d9; font-size: 0.85rem;">
          Click on a window in the dock or desktop to focus it
        </div>
      </div>
      
      <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2); margin-top: 16px;">
        <div style="color: #7d5cff; font-weight: 600; margin-bottom: 12px;">System Resources</div>
        <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
          Browser: ${navigator.userAgent.split(' ').pop()}
        </div>
        <div style="color: #a8b4d9; font-size: 0.85rem;">
          Platform: ${navigator.platform}
        </div>
      </div>
    </div>
  `;
  
  openCustomWindow('Task Manager', taskContent, 'fas fa-tasks', 500, 400);
}



// Update location function
function updateLocation() {
  const locationUpdate = document.querySelector('.location-update');
  if (locationUpdate) {
    locationUpdate.innerHTML = 'üîÑ Updating...';
    locationUpdate.style.pointerEvents = 'none';
  }
  
  setTimeout(() => {
    getUserLocation();
    if (locationUpdate) {
      locationUpdate.innerHTML = 'üìç Update location';
      locationUpdate.style.pointerEvents = 'auto';
    }
  }, 1500);
}

// Setup X-ORBIT menu functionality
function setupXORBITMenu() {
  const xorbitMenuButton = document.getElementById('xorbitMenu');
  const xorbitDropdown = document.getElementById('xorbitDropdown');
  
  if (xorbitMenuButton && xorbitDropdown) {
    xorbitMenuButton.addEventListener('click', function(e) {
      e.stopPropagation();
      const isVisible = xorbitDropdown.classList.contains('show');
      
      // Hide all other menus first
      document.querySelectorAll('.xorbit-menu.show').forEach(menu => {
        menu.classList.remove('show');
      });
      
      if (!isVisible) {
        xorbitDropdown.classList.add('show');
      }
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', function() {
      xorbitDropdown.classList.remove('show');
      // Also close time menu if open
      const timeDropdown = document.getElementById('timeDropdown');
      if (timeDropdown) {
        timeDropdown.classList.remove('show');
      }
    });
    
    // Prevent menu from closing when clicking inside
    xorbitDropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }
}

function setupUserMenu() {
  const userMenuButton = document.getElementById('userNameplate');
  const userDropdown = document.getElementById('userDropdown');
  
  if (userMenuButton && userDropdown) {
    userMenuButton.addEventListener('click', function(e) {
      e.stopPropagation();
      const isVisible = userDropdown.classList.contains('show');
      
      // Hide all other menus first
      document.querySelectorAll('.xorbit-menu.show').forEach(menu => {
        menu.classList.remove('show');
      });
      document.querySelectorAll('.time-menu.show').forEach(menu => {
        menu.classList.remove('show');
      });
      
      if (!isVisible) {
        userDropdown.classList.add('show');
      }
    });
    
    // Prevent menu from closing when clicking inside
    userDropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }
  
  // Update user display name
  updateUserDisplay();
}

function updateUserDisplay() {
  const userNameDisplay = document.getElementById('userNameDisplay');
  if (!userNameDisplay) return;
  
  const authData = sessionStorage.getItem('xorbit_auth_session') || 
                   localStorage.getItem('xorbit_auth_session');
  
  if (authData) {
    try {
      const authSession = JSON.parse(authData);
      const username = authSession.username || authSession.name || 'User';
      userNameDisplay.textContent = username;
    } catch (e) {
      console.warn('Could not parse auth data');
      userNameDisplay.textContent = 'User';
    }
  } else {
    userNameDisplay.textContent = 'Guest';
  }
}

// X-ORBIT Menu Functions
// Global variable to store session start time
let sessionStartTime = new Date();

function showAccountInfo() {
  const authData = sessionStorage.getItem('xorbit_auth_session') || 
                   localStorage.getItem('xorbit_auth_session');
  
  let username = 'Guest';
  let email = 'Not logged in';
  
  if (authData) {
    try {
      const authSession = JSON.parse(authData);
      username = authSession.username || authSession.name || 'User';
      email = authSession.email || 'No email on file';
    } catch (e) {
      console.warn('Could not parse auth data');
    }
  }
  
  // Format last login time
  const lastLogin = sessionStartTime.toLocaleString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
  
  // Calculate session duration
  const now = new Date();
  const sessionDuration = Math.floor((now - sessionStartTime) / 1000); // in seconds
  const hours = Math.floor(sessionDuration / 3600);
  const minutes = Math.floor((sessionDuration % 3600) / 60);
  const seconds = sessionDuration % 60;
  const sessionTime = `${hours}h ${minutes}m ${seconds}s`;
  
  const accountContent = `
    <div style="padding: 24px;">
      <h2 style="color: #e8f0ff; margin-bottom: 24px; font-size: 1.4rem;">
        <i class="fas fa-user-circle" style="margin-right: 12px; color: #7d5cff;"></i>
        Account Information
      </h2>
      
      <div style="display: grid; gap: 16px;">
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">User Profile</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
            <i class="fas fa-user" style="margin-right: 8px; color: #7d5cff;"></i>
            Username: <strong>${username}</strong>
          </div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">
            <i class="fas fa-envelope" style="margin-right: 8px; color: #7d5cff;"></i>
            Email: ${email}
          </div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">Session Information</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
            <i class="fas fa-clock" style="margin-right: 8px; color: #7d5cff;"></i>
            Last Login: ${lastLogin}
          </div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">
            <i class="fas fa-hourglass-half" style="margin-right: 8px; color: #7d5cff;"></i>
            Session Duration: ${sessionTime}
          </div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">Location Information</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
            <i class="fas fa-map-marker-alt" style="margin-right: 8px; color: #7d5cff;"></i>
            Location: ${userLocation.city}, ${userLocation.state}
          </div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">
            <i class="fas fa-globe" style="margin-right: 8px; color: #7d5cff;"></i>
            Timezone: ${userLocation.timezone}
          </div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">System Status</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
            <i class="fas fa-check-circle" style="margin-right: 8px; color: #28ca42;"></i>
            Status: ${isAuthenticated ? 'Authenticated' : 'Guest Mode'}
          </div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">
            <i class="fas fa-window-restore" style="margin-right: 8px; color: #7d5cff;"></i>
            Active Windows: ${activeWindows.size}
          </div>
        </div>
      </div>
    </div>
  `;
  
  openCustomWindow('Account Information', accountContent, 'fas fa-user-circle', 600, 500);
  
  // Close both possible dropdowns
  const xorbitDropdown = document.getElementById('xorbitDropdown');
  if (xorbitDropdown) xorbitDropdown.classList.remove('show');
  
  const userDropdown = document.getElementById('userDropdown');
  if (userDropdown) userDropdown.classList.remove('show');
}

function showAboutDialog() {
  openWindow('Build Information', 'build-info.html', 'fas fa-info-circle');
  document.getElementById('xorbitDropdown').classList.remove('show');
}

function showSystemInfo() {
  const systemContent = `
    <div style="padding: 24px;">
      <h2 style="color: #e8f0ff; margin-bottom: 24px; font-size: 1.4rem;">
        <i class="fas fa-desktop" style="margin-right: 12px; color: #7d5cff;"></i>
        System Information
      </h2>
      
      <div style="display: grid; gap: 16px;">
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">Browser Information</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">User Agent: ${navigator.userAgent}</div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">Platform: ${navigator.platform}</div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">Display Information</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">Resolution: ${window.screen.width} √ó ${window.screen.height}</div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">Available: ${window.screen.availWidth} √ó ${window.screen.availHeight}</div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">X-ORBIT Status</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">Authentication: ${isAuthenticated ? '‚úÖ Active' : '‚ùå Inactive'}</div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">Active Windows: ${activeWindows.size}</div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">Current Settings</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">Theme: ${settings.theme}</div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">Dock Position: ${settings.dockPosition}</div>
        </div>
      </div>
    </div>
  `;
  
  openCustomWindow('System Information', systemContent, 'fas fa-desktop', 600, 500);
  document.getElementById('xorbitDropdown').classList.remove('show');
}

function checkForUpdates() {
  const updateContent = `
    <div style="text-align: center; padding: 40px 30px;">
      <div style="margin-bottom: 24px;">
        <i class="fas fa-download" style="font-size: 2.5rem; color: #7d5cff; margin-bottom: 16px;"></i>
        <h2 style="color: #e8f0ff; margin-bottom: 16px;">Check for Updates</h2>
      </div>
      
      <div id="updateStatus" style="background: rgba(120, 80, 255, 0.1); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid rgba(120, 80, 255, 0.2);">
        <div style="color: #a8b4d9; margin-bottom: 16px;">
          <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
          Checking for updates...
        </div>
        <div style="width: 100%; height: 4px; background: rgba(120, 80, 255, 0.2); border-radius: 2px; overflow: hidden;">
          <div style="width: 0%; height: 100%; background: linear-gradient(90deg, #7d5cff, #3c82ff); border-radius: 2px; transition: width 2s ease;" id="updateProgress"></div>
        </div>
      </div>
    </div>
  `;
  
  const windowEl = openCustomWindow('Software Update', updateContent, 'fas fa-download', 450, 300);
  
  // Simulate update check
  setTimeout(() => {
    const progressBar = windowEl.querySelector('#updateProgress');
    const statusDiv = windowEl.querySelector('#updateStatus');
    
    if (progressBar) progressBar.style.width = '100%';
    
    setTimeout(() => {
      if (statusDiv) {
        statusDiv.innerHTML = `
          <div style="color: #28ca42; margin-bottom: 8px;">
            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
            You're up to date!
          </div>
          <div style="color: #a8b4d9; font-size: 0.9rem;">
            X-ORBIT Desktop v1.0.0 is the latest version.
          </div>
        `;
      }
    }, 2000);
  }, 1000);
  
  document.getElementById('xorbitDropdown').classList.remove('show');
}

function restartDesktop() {
  if (confirm('Restart the desktop environment? All open windows will be closed.')) {
    // Close all windows
    activeWindows.forEach((windowId) => {
      const windowEl = document.getElementById(windowId);
      if (windowEl) windowEl.remove();
    });
    activeWindows.clear();
    
    // Show restart animation
    const restartDiv = document.createElement('div');
    restartDiv.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(10, 5, 25, 0.9);
        backdrop-filter: blur(60px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        color: #e8f0ff;
        flex-direction: column;
        gap: 20px;
      ">
        <i class="fas fa-sync fa-spin" style="font-size: 3rem; color: #7d5cff;"></i>
        <div style="font-size: 1.2rem; font-weight: 500;">Restarting Desktop...</div>
      </div>
    `;
    document.body.appendChild(restartDiv);
    
    setTimeout(() => {
      restartDiv.remove();
      initDesktop();
    }, 2000);
  }
  
  document.getElementById('xorbitDropdown').classList.remove('show');
}

function logout() {
  if (confirm('Are you sure you want to logout? All unsaved work will be lost.')) {
    // Stop ban checking
    stopBanChecking();
    stopAutomaticUpdateChecking();
    
    // Clear all windows
    activeWindows.forEach((windowId) => {
      const windowEl = document.getElementById(windowId);
      if (windowEl) windowEl.remove();
    });
    activeWindows.clear();
    
    // Reset authentication
    isAuthenticated = false;
    
    // Show logout animation and return to auth screen
    const logoutDiv = document.createElement('div');
    logoutDiv.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(10, 5, 25, 0.9);
        backdrop-filter: blur(60px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        color: #e8f0ff;
        flex-direction: column;
        gap: 20px;
      ">
        <i class="fas fa-sign-out-alt" style="font-size: 3rem; color: #ff6b6b;"></i>
        <div style="font-size: 1.2rem; font-weight: 500;">Logging out...</div>
      </div>
    `;
    document.body.appendChild(logoutDiv);
    
    setTimeout(() => {
      logoutDiv.remove();
      const welcomeOverlay = document.getElementById('welcomeOverlay');
      if (welcomeOverlay) {
        welcomeOverlay.style.display = 'flex';
      }
    }, 1500);
  }
  
  document.getElementById('xorbitDropdown').classList.remove('show');
}

// Helper function to create custom content windows
function openCustomWindow(title, content, icon, width = 600, height = 450) {
  if (!isAuthenticated) return null;
  
  if (activeWindows.has(title)) {
    focusWindow(activeWindows.get(title));
    return document.getElementById(activeWindows.get(title));
  }
  
  windowCounter++;
  const windowId = 'win' + windowCounter;
  
  const windowEl = document.createElement('div');
  windowEl.className = 'window';
  if (settings.animations) {
    windowEl.classList.add('window-opening');
  }
  windowEl.id = windowId;
  
  // Calculate safe position to prevent overflow - SIMPLIFIED
  // Get viewport size
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  
  // Safe margins
  const leftMargin = 50;
  const rightMargin = 50;
  const topMargin = 80;
  const bottomMargin = 120;
  
  // Calculate actual available space
  const availableWidth = vw - leftMargin - rightMargin;
  const availableHeight = vh - topMargin - bottomMargin;
  
  // Reduce window size if it won't fit
  const actualWidth = Math.min(width, availableWidth);
  const actualHeight = Math.min(height, availableHeight);
  
  // Calculate safe position range
  const minX = leftMargin;
  const maxX = vw - actualWidth - rightMargin;
  const minY = topMargin;
  const maxY = vh - actualHeight - bottomMargin;
  
  // Generate position (centered with slight randomness)
  const centerX = (vw - actualWidth) / 2;
  const centerY = (vh - actualHeight) / 2;
  const randomOffsetX = (Math.random() - 0.5) * 100;
  const randomOffsetY = (Math.random() - 0.5) * 100;
  
  let x = centerX + randomOffsetX;
  let y = centerY + randomOffsetY;
  
  // Clamp to bounds
  x = Math.max(minX, Math.min(x, maxX));
  y = Math.max(minY, Math.min(y, maxY));
  
  windowEl.style.left = Math.floor(x) + 'px';
  windowEl.style.top = Math.floor(y) + 'px';
  windowEl.style.width = Math.floor(actualWidth) + 'px';
  windowEl.style.height = Math.floor(actualHeight) + 'px';
  
  windowEl.innerHTML = 
    '<div class="window-titlebar">' +
      '<div class="window-controls">' +
        '<div class="window-control close"></div>' +
        '<div class="window-control minimize"></div>' +
        '<div class="window-control maximize"></div>' +
      '</div>' +
      '<div class="window-title">' +
        '<i class="' + icon + '" style="margin-right: 8px;"></i>' +
        title +
      '</div>' +
    '</div>' +
    '<div class="window-content" style="padding: 0; background: rgba(10, 10, 25, 0.3); border-radius: 0 0 16px 16px; overflow: auto;">' +
      content +
    '</div>';
  
  const desktop = document.getElementById('desktop');
  if (desktop) {
    desktop.appendChild(windowEl);
  }
  activeWindows.set(title, windowId);
  focusWindow(windowId);
  
  setupWindowEvents(windowEl, windowId, title);
  
  // Add resize observer to prevent overflow
  constrainWindowSize(windowEl);
  
  // Force immediate position check
  setTimeout(() => {
    forceWindowInBounds(windowEl);
    // Trigger smooth animation like weather UI
    windowEl.classList.add('window-visible');
  }, 0);
  
  return windowEl;
}

function forceWindowInBounds(windowEl) {
  const rect = windowEl.getBoundingClientRect();
  const menuBarHeight = 32;
  const margin = 10;
  
  let needsUpdate = false;
  let newLeft = parseFloat(windowEl.style.left);
  let newTop = parseFloat(windowEl.style.top);
  let newWidth = parseFloat(windowEl.style.width);
  let newHeight = parseFloat(windowEl.style.height);
  
  // Check right overflow
  if (rect.right > window.innerWidth - margin) {
    newLeft = window.innerWidth - rect.width - margin;
    needsUpdate = true;
  }
  
  // Check bottom overflow
  if (rect.bottom > window.innerHeight - margin) {
    newTop = window.innerHeight - rect.height - margin;
    needsUpdate = true;
  }
  
  // Check left overflow
  if (rect.left < margin) {
    newLeft = margin;
    needsUpdate = true;
  }
  
  // Check top overflow
  if (rect.top < menuBarHeight + margin) {
    newTop = menuBarHeight + margin;
    needsUpdate = true;
  }
  
  // Check if window is too wide
  if (rect.width > window.innerWidth - (2 * margin)) {
    newWidth = window.innerWidth - (2 * margin);
    newLeft = margin;
    needsUpdate = true;
  }
  
  // Check if window is too tall
  if (rect.height > window.innerHeight - menuBarHeight - (2 * margin)) {
    newHeight = window.innerHeight - menuBarHeight - (2 * margin);
    newTop = menuBarHeight + margin;
    needsUpdate = true;
  }
  
  if (needsUpdate) {
    windowEl.style.left = Math.round(newLeft) + 'px';
    windowEl.style.top = Math.round(newTop) + 'px';
    windowEl.style.width = Math.round(newWidth) + 'px';
    windowEl.style.height = Math.round(newHeight) + 'px';
  }
}

function constrainWindowSize(windowEl) {
  const resizeObserver = new ResizeObserver(entries => {
    for (let entry of entries) {
      const rect = entry.target.getBoundingClientRect();
      const menuBarHeight = 32;
      const dockHeight = 70;
      const margin = 20;
      
      let needsAdjustment = false;
      let newWidth = rect.width;
      let newHeight = rect.height;
      let newLeft = parseFloat(windowEl.style.left) || rect.left;
      let newTop = parseFloat(windowEl.style.top) || rect.top;
      
      // Check if window extends beyond right edge
      if (rect.right > window.innerWidth - margin) {
        newWidth = window.innerWidth - newLeft - margin;
        needsAdjustment = true;
      }
      
      // Check if window extends beyond bottom edge
      if (rect.bottom > window.innerHeight - dockHeight - margin) {
        newHeight = window.innerHeight - dockHeight - newTop - margin;
        needsAdjustment = true;
      }
      
      // Check if window position needs adjustment
      if (newLeft < margin) {
        newLeft = margin;
        needsAdjustment = true;
      }
      
      if (newTop < menuBarHeight + margin) {
        newTop = menuBarHeight + margin;
        needsAdjustment = true;
      }
      
      // Apply constraints
      if (needsAdjustment) {
        if (newWidth !== rect.width) {
          windowEl.style.width = Math.max(400, newWidth) + 'px';
        }
        if (newHeight !== rect.height) {
          windowEl.style.height = Math.max(300, newHeight) + 'px';
        }
        if (newLeft !== rect.left) {
          windowEl.style.left = newLeft + 'px';
        }
        if (newTop !== rect.top) {
          windowEl.style.top = newTop + 'px';
        }
      }
    }
  });
  
  resizeObserver.observe(windowEl);
}

// Terminal communication handler
// Terminal communication handler
window.addEventListener('message', function(event) {
    if (event.data.type === 'terminal-request') {
        switch(event.data.command) {
            case 'theme':
                settings.theme = event.data.value;
                applySettings();
                break;
            case 'dock':
                switch(event.data.setting) {
                    case 'position':
                        settings.dockPosition = event.data.value;
                        break;
                    case 'size':
                        settings.dockSize = parseInt(event.data.value);
                        break;
                    case 'autohide':
                        settings.dockAutohide = event.data.value === 'on';
                        break;
                }
                applySettings();
                break;
            case 'close-windows':
                // Close all open windows
                activeWindows.forEach((windowId) => {
                    const windowEl = document.getElementById(windowId);
                    if (windowEl) windowEl.remove();
                });
                activeWindows.clear();
                break;
            case 'restart':
                restartDesktop();
                break;
            case 'logout':
                logout();
                break;
            case 'refresh':
                // Refresh the current webpage
                location.reload();
                break;
            case 'browser-refresh':
                // Attempt to refresh the browser window
                if (window.parent) {
                    window.parent.location.reload();
                }
                break;
        }
    }
});
// Supabase initialization for ban checking
let supabaseClient = null;

// Initialize Supabase client
function initSupabaseClient() {
  try {
    if (window.supabase && window.supabase.createClient) {
      const { createClient } = window.supabase;
      const supabaseUrl = 'https://rujvmtvozorylfzsqppc.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1anZtdHZvem9yeWxmenNxcHBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjQxNDEsImV4cCI6MjA3MzA0MDE0MX0.b7jJz3Se_oXXDwwd0dWQ8-rEvhY0aU4JDHQVioE39iY';
      supabaseClient = createClient(supabaseUrl, supabaseKey);
      console.log('Supabase client initialized');
      return true;
    } else {
      console.error('Supabase library not loaded');
      return false;
    }
  } catch (e) {
    console.error('Error initializing Supabase:', e);
    return false;
  }
}

// Ban checking variables
let banCheckInterval = null;

// Check if account is banned or doesn't exist
async function checkAccountBanStatus() {
  try {
    console.log('=== BAN CHECK START ===');
    
    // Initialize Supabase if not already done
    if (!supabaseClient) {
      console.log('Supabase client not initialized, initializing now...');
      const initialized = initSupabaseClient();
      if (!initialized) {
        console.error('Cannot check ban status: Supabase not initialized');
        return false;
      }
    }
    
    const authData = sessionStorage.getItem('xorbit_auth_session') || 
                     localStorage.getItem('xorbit_auth_session');
    
    console.log('Auth data found:', !!authData);
    
    if (!authData) {
      console.log('No auth data found for ban check');
      return false;
    }
    
    const authSession = JSON.parse(authData);
    const email = authSession.email; // Using email instead of username
    
    console.log('Checking email:', email);
    
    if (!email) {
      console.log('No email in session for ban check');
      return false;
    }
    
    console.log('Querying Supabase for email:', email);
    
    // Query Supabase to check if account exists and is banned
    const { data, error } = await supabaseClient
      .from('clients')
      .select('blocked, ban_reason, name')
      .eq('email', email)
      .single();
    
    console.log('Supabase response - Data:', data);
    console.log('Supabase response - Error:', error);
    
    // Handle errors - account doesn't exist or other database issues
    if (error) {
      console.error('Error checking ban status:', error);
      console.log('Error code:', error.code);
      console.log('Error message:', error.message);
      
      // If the error is because no rows were found, the account doesn't exist
      if (error.code === 'PGRST116' || error.message.includes('No rows found') || error.message.includes('multiple')) {
        console.log('Account does not exist in database - logging out');
        
        // Stop the interval check
        if (banCheckInterval) {
          clearInterval(banCheckInterval);
        }
        
        // Store a generic message for account not found
        sessionStorage.setItem('ban_reason', 'Your account could not be found in our system. Please contact support if you believe this is an error.');
        sessionStorage.setItem('banned_username', email);
        
        // Redirect to blocked page
        console.log('Redirecting to blocked.html (account not found)');
        window.location.href = 'blocked.html';
        return true;
      }
      
      // For other errors, return false and continue checking
      return false;
    }
    
    // If no data returned, account doesn't exist
    if (!data) {
      console.log('No data returned - account does not exist in database - logging out');
      
      // Stop the interval check
      if (banCheckInterval) {
        clearInterval(banCheckInterval);
      }
      
      // Store a generic message for account not found
      sessionStorage.setItem('ban_reason', 'Your account could not be found in our system. Please contact support if you believe this is an error.');
      sessionStorage.setItem('banned_username', email);
      
      // Redirect to blocked page
      console.log('Redirecting to blocked.html (no data)');
      window.location.href = 'blocked.html';
      return true;
    }
    
    console.log('Data.blocked value:', data.blocked);
    console.log('Data.blocked type:', typeof data.blocked);
    console.log('Checking if blocked === "true":', data.blocked === 'true');
    console.log('Checking if blocked === true:', data.blocked === true);
    
    // Check if blocked is 'true' (string comparison) OR boolean true
    if (data.blocked === 'true' || data.blocked === true) {
      console.log('üö´ ACCOUNT IS BANNED! Ban reason:', data.ban_reason || 'No reason provided');
      
      // Stop the interval check
      if (banCheckInterval) {
        clearInterval(banCheckInterval);
      }
      
      // Store ban reason and name in session storage
      if (data.ban_reason) {
        sessionStorage.setItem('ban_reason', data.ban_reason);
        console.log('Stored ban reason in session');
      }
      if (data.name) {
        sessionStorage.setItem('banned_username', data.name);
        console.log('Stored username in session:', data.name);
      }
      
      // Redirect to blocked page
      console.log('üî¥ Redirecting to blocked.html (account banned)');
      window.location.href = 'blocked.html';
      return true;
    }
    
    console.log('‚úÖ Account status: Active (not banned)');
    console.log('=== BAN CHECK END ===');
    return false;
  } catch (e) {
    console.error('üí• Error in checkAccountBanStatus:', e);
    console.error('Error stack:', e.stack);
    return false;
  }
}

// Start periodic ban checking
function startBanChecking() {
  // Clear any existing interval
  if (banCheckInterval) {
    clearInterval(banCheckInterval);
  }
  
  // Check immediately
  checkAccountBanStatus();
  
  // Then check every 15 seconds
  banCheckInterval = setInterval(() => {
    checkAccountBanStatus();
  }, 15000); // 15 seconds
  
  console.log('Ban checking started (every 15 seconds)');
}

// Stop ban checking (useful when logging out)
function stopBanChecking() {
  if (banCheckInterval) {
    clearInterval(banCheckInterval);
    banCheckInterval = null;
    console.log('Ban checking stopped');
  }
}
// ============================================
// X-ORBIT UPDATE SYSTEM - JAVASCRIPT CODE
// Add this to your existing <script> section
// ============================================

// Add these global variables at the top with your other global variables:
const CURRENT_VERSION = '4.6.0';
const CURRENT_VERSION_NAME = 'X-ORBIT Desktop 4.6.0 Astra';
let pendingUpdateOnClose = false;
let latestUpdateData = null;

// Update checker function
async function checkForSystemUpdates() {
  try {
    console.log('Checking for system updates...');
    
    // Initialize Supabase if not already done
    if (!supabaseClient) {
      const initialized = initSupabaseClient();
      if (!initialized) {
        console.error('Cannot check updates: Supabase not initialized');
        showUpdateError();
        return;
      }
    }
    
    // Query the update_check table
    const { data, error } = await supabaseClient
      .from('update_check')
      .select('*')
      .single();
    
    if (error) {
      console.error('Error checking for updates:', error);
      showUpdateError();
      return;
    }
    
    if (!data) {
      console.error('No update data found');
      showUpdateError();
      return;
    }
    
    console.log('Update data received:', data);
    
    // Compare versions
    const latestVersion = data.version;
    const latestVersionName = data.version_name || `X-ORBIT Desktop ${latestVersion}`;
    const updateSize = data.update_size || 'Unknown';
    
    if (latestVersion !== CURRENT_VERSION) {
      // Update available
      console.log('Update available:', latestVersion);
      latestUpdateData = {
        version: latestVersion,
        versionName: latestVersionName,
        size: updateSize
      };
      showUpdateAvailable(latestVersionName, latestVersion, updateSize);
    } else {
      // Up to date
      console.log('System is up to date');
      showUpToDate();
    }
  } catch (e) {
    console.error('Error in checkForSystemUpdates:', e);
    showUpdateError();
  }
}

// UI update functions
function showUpdateCheckStatus() {
  const statusDiv = document.getElementById('updateCheckStatus');
  const availableDiv = document.getElementById('updateAvailable');
  const upToDateDiv = document.getElementById('upToDate');
  const errorDiv = document.getElementById('updateError');
  
  if (statusDiv) statusDiv.style.display = 'block';
  if (availableDiv) availableDiv.style.display = 'none';
  if (upToDateDiv) upToDateDiv.style.display = 'none';
  if (errorDiv) errorDiv.style.display = 'none';
}

function showUpdateAvailable(versionName, version, size) {
  const statusDiv = document.getElementById('updateCheckStatus');
  const availableDiv = document.getElementById('updateAvailable');
  const upToDateDiv = document.getElementById('upToDate');
  const errorDiv = document.getElementById('updateError');
  
  const versionNameEl = document.getElementById('updateVersionName');
  const versionNumberEl = document.getElementById('updateVersionNumber');
  const updateSizeEl = document.getElementById('updateSize');
  
  if (statusDiv) statusDiv.style.display = 'none';
  if (availableDiv) availableDiv.style.display = 'block';
  if (upToDateDiv) upToDateDiv.style.display = 'none';
  if (errorDiv) errorDiv.style.display = 'none';
  
  if (versionNameEl) versionNameEl.textContent = versionName;
  if (versionNumberEl) versionNumberEl.textContent = version;
  if (updateSizeEl) updateSizeEl.textContent = size;
}

function showUpToDate() {
  const statusDiv = document.getElementById('updateCheckStatus');
  const availableDiv = document.getElementById('updateAvailable');
  const upToDateDiv = document.getElementById('upToDate');
  const errorDiv = document.getElementById('updateError');
  
  if (statusDiv) statusDiv.style.display = 'none';
  if (availableDiv) availableDiv.style.display = 'none';
  if (upToDateDiv) upToDateDiv.style.display = 'block';
  if (errorDiv) errorDiv.style.display = 'none';
}

function showUpdateError() {
  const statusDiv = document.getElementById('updateCheckStatus');
  const availableDiv = document.getElementById('updateAvailable');
  const upToDateDiv = document.getElementById('upToDate');
  const errorDiv = document.getElementById('updateError');
  
  if (statusDiv) statusDiv.style.display = 'none';
  if (availableDiv) availableDiv.style.display = 'none';
  if (upToDateDiv) upToDateDiv.style.display = 'none';
  if (errorDiv) errorDiv.style.display = 'block';
}

// Update button handlers
function setupUpdateHandlers(settingsContent) {
  const updateNowBtn = settingsContent.querySelector('#updateNowBtn');
  const updateLaterBtn = settingsContent.querySelector('#updateLaterBtn');
  const recheckUpdateBtn = settingsContent.querySelector('#recheckUpdateBtn');
  const retryUpdateBtn = settingsContent.querySelector('#retryUpdateBtn');
  
  if (updateNowBtn) {
    updateNowBtn.addEventListener('click', function() {
      performUpdate();
    });
  }
  
  if (updateLaterBtn) {
    updateLaterBtn.addEventListener('click', function() {
      pendingUpdateOnClose = true;
      updateLaterBtn.innerHTML = '<i class="fas fa-check"></i> Will Update on Close';
      updateLaterBtn.style.background = 'rgba(40, 202, 66, 0.2)';
      updateLaterBtn.style.borderColor = 'rgba(40, 202, 66, 0.5)';
      updateLaterBtn.disabled = true;
      
      // Show confirmation
      showSaveIndicator();
    });
  }
  
  if (recheckUpdateBtn) {
    recheckUpdateBtn.addEventListener('click', function() {
      showUpdateCheckStatus();
      setTimeout(() => {
        checkForSystemUpdates();
      }, 500);
    });
  }
  
  if (retryUpdateBtn) {
    retryUpdateBtn.addEventListener('click', function() {
      showUpdateCheckStatus();
      setTimeout(() => {
        checkForSystemUpdates();
      }, 500);
    });
  }
}

function performUpdate() {
  // Find the update available container
  const updateAvailableDiv = document.getElementById('updateAvailable');
  if (!updateAvailableDiv) return;
  
  // Make the parent position relative
  updateAvailableDiv.style.position = 'relative';
  
  // Create the progress overlay
  const progressOverlay = document.createElement('div');
  progressOverlay.className = 'update-progress-overlay';
  progressOverlay.innerHTML = `
    <div class="update-cancel-btn" id="updateCancelBtn">
      <i class="fas fa-times"></i>
    </div>
    <i class="fas fa-download update-progress-icon" id="updateProgressIcon"></i>
    <div class="update-progress-title">Downloading Update</div>
    <div class="update-progress-status" id="updateProgressStatus">Initializing download...</div>
    <div class="update-progress-row">
      <div class="update-progress-bar-container">
        <div class="update-progress-bar" id="updateProgressBar"></div>
      </div>
      <div class="update-progress-percent" id="updateProgressPercent">0%</div>
    </div>
    <div class="update-progress-time" id="updateProgressTime">Time remaining: Calculating...</div>
  `;
  
  updateAvailableDiv.appendChild(progressOverlay);
  
  // Show overlay with animation
  setTimeout(() => {
    progressOverlay.classList.add('show');
  }, 50);
  
  const progressBar = progressOverlay.querySelector('#updateProgressBar');
  const progressPercent = progressOverlay.querySelector('#updateProgressPercent');
  const progressStatus = progressOverlay.querySelector('#updateProgressStatus');
  const progressTime = progressOverlay.querySelector('#updateProgressTime');
  const progressIcon = progressOverlay.querySelector('#updateProgressIcon');
  const cancelBtn = progressOverlay.querySelector('#updateCancelBtn');
  
  // Cancel button handler
  let updateCancelled = false;
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function() {
      if (confirm('Cancel the update? You can install it later.')) {
        updateCancelled = true;
        progressOverlay.remove();
      }
    });
  }
  
  // Realistic 5-minute update process with detailed steps
  const updateSteps = [
    // Initial connection (15 seconds)
    { progress: 1, status: 'Connecting to update server...', delay: 3000 },
    { progress: 2, status: 'Authenticating connection...', delay: 2000 },
    { progress: 3, status: 'Verifying update availability...', delay: 2000 },
    { progress: 5, status: 'Retrieving update manifest...', delay: 3000 },
    { progress: 7, status: 'Checking system compatibility...', delay: 2000 },
    { progress: 8, status: 'Preparing download...', delay: 3000 },
    
    // Download phase 1 - Core files (90 seconds)
    { progress: 10, status: 'Downloading core system files...', delay: 4000 },
    { progress: 12, status: 'Downloading framework updates...', delay: 5000 },
    { progress: 15, status: 'Downloading UI components...', delay: 4000 },
    { progress: 18, status: 'Downloading application modules...', delay: 5000 },
    { progress: 22, status: 'Downloading security patches...', delay: 4000 },
    { progress: 25, status: 'Downloading system libraries...', delay: 5000 },
    { progress: 28, status: 'Downloading asset files...', delay: 4000 },
    { progress: 32, status: 'Downloading configuration files...', delay: 5000 },
    { progress: 35, status: 'Downloading language packs...', delay: 4000 },
    
    // Download phase 2 - Additional content (60 seconds)
    { progress: 38, status: 'Downloading theme resources...', delay: 4000 },
    { progress: 42, status: 'Downloading icon sets...', delay: 5000 },
    { progress: 45, status: 'Downloading sound effects...', delay: 4000 },
    { progress: 48, status: 'Downloading wallpapers...', delay: 4000 },
    { progress: 51, status: 'Downloading fonts...', delay: 4000 },
    { progress: 54, status: 'Downloading documentation...', delay: 5000 },
    
    // Verification phase (45 seconds)
    { progress: 57, status: 'Verifying download integrity...', delay: 5000 },
    { progress: 60, status: 'Checking file checksums...', delay: 4000 },
    { progress: 63, status: 'Validating package signatures...', delay: 5000 },
    { progress: 66, status: 'Scanning for corruption...', delay: 4000 },
    { progress: 68, status: 'Verifying all components...', delay: 4000 },
    
    // Extraction phase (45 seconds)
    { progress: 70, status: 'Extracting update package...', delay: 5000 },
    { progress: 73, status: 'Decompressing core files...', delay: 4000 },
    { progress: 76, status: 'Extracting system components...', delay: 5000 },
    { progress: 79, status: 'Unpacking application files...', delay: 4000 },
    { progress: 82, status: 'Extracting resource files...', delay: 4000 },
    
    // Installation phase (45 seconds)
    { progress: 84, status: 'Preparing installation environment...', delay: 4000 },
    { progress: 86, status: 'Backing up current system...', delay: 5000 },
    { progress: 88, status: 'Installing core updates...', delay: 5000 },
    { progress: 90, status: 'Updating system components...', delay: 4000 },
    { progress: 92, status: 'Installing new features...', delay: 5000 },
    { progress: 94, status: 'Applying configuration changes...', delay: 4000 },
    
    // Finalization phase (30 seconds)
    { progress: 95, status: 'Cleaning up temporary files...', delay: 4000 },
    { progress: 96, status: 'Updating system registry...', delay: 3000 },
    { progress: 97, status: 'Configuring services...', delay: 3000 },
    { progress: 98, status: 'Optimizing system...', delay: 4000 },
    { progress: 99, status: 'Finalizing installation...', delay: 3000 },
    { progress: 100, status: 'Update complete!', delay: 2000 }
  ];
  
  let currentStep = 0;
  const startTime = Date.now();
  const totalDuration = updateSteps.reduce((sum, step) => sum + step.delay, 0);
  
  function formatTime(ms) {
    const totalSeconds = Math.ceil(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes}m ${seconds}s`;
  }
  
  function nextUpdateStep() {
    if (updateCancelled) return;
    
    if (currentStep >= updateSteps.length) {
      // Update complete
      setTimeout(() => {
        if (progressIcon) {
          progressIcon.className = 'fas fa-check-circle update-progress-icon success';
        }
        if (progressStatus) progressStatus.textContent = 'Update installed successfully!';
        if (progressTime) progressTime.textContent = 'Restarting system...';
        if (cancelBtn) cancelBtn.style.display = 'none';
        
        // Reload the page after 3 seconds
        setTimeout(() => {
          location.reload();
        }, 3000);
      }, 500);
      return;
    }
    
    const step = updateSteps[currentStep];
    const elapsedTime = Date.now() - startTime;
    const remainingTime = totalDuration - elapsedTime;
    
    if (progressBar) progressBar.style.width = step.progress + '%';
    if (progressPercent) progressPercent.textContent = step.progress + '%';
    if (progressStatus) progressStatus.textContent = step.status;
    if (progressTime && remainingTime > 0) {
      progressTime.textContent = 'Time remaining: ' + formatTime(remainingTime);
    }
    
    currentStep++;
    setTimeout(nextUpdateStep, step.delay);
  }
  
  // Start update process
  setTimeout(nextUpdateStep, 500);
}
// REPLACE YOUR EXISTING logout() function with this one:
function logout() {
  // Check if there's a pending update
  if (pendingUpdateOnClose && latestUpdateData) {
    if (confirm('An update is ready to install. Would you like to install it now before logging out?')) {
      performUpdate();
      return;
    }
  }
  
  // Original logout code
  if (confirm('Are you sure you want to logout? All unsaved work will be lost.')) {
    stopBanChecking();
    activeWindows.forEach((windowId) => {
      const windowEl = document.getElementById(windowId);
      if (windowEl) windowEl.remove();
    });
    activeWindows.clear();
    isAuthenticated = false;
    
    const logoutDiv = document.createElement('div');
    logoutDiv.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(10, 5, 25, 0.9);
        backdrop-filter: blur(60px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        color: #e8f0ff;
        flex-direction: column;
        gap: 20px;
      ">
        <i class="fas fa-sign-out-alt" style="font-size: 3rem; color: #ff6b6b;"></i>
        <div style="font-size: 1.2rem; font-weight: 500;">Logging out...</div>
      </div>
    `;
    document.body.appendChild(logoutDiv);
    
    setTimeout(() => {
      logoutDiv.remove();
      const welcomeOverlay = document.getElementById('welcomeOverlay');
      if (welcomeOverlay) {
        welcomeOverlay.style.display = 'flex';
      }
    }, 1500);
  }
  
  const xorbitDropdown = document.getElementById('xorbitDropdown');
  if (xorbitDropdown) xorbitDropdown.classList.remove('show');
}

// MODIFY YOUR EXISTING setupSettingsEvents function
// Find this function and ADD this code at the END of it (before the closing brace):

// Add to setupSettingsEvents function:
function enhanceSettingsWithUpdateChecker(settingsContent) {
  if (!settingsContent) return;
  
  setupUpdateHandlers(settingsContent);
  
  const systemNavItem = settingsContent.querySelector('[data-section="system"]');
  if (systemNavItem) {
    systemNavItem.addEventListener('click', function() {
      setTimeout(() => {
        checkForSystemUpdates();
      }, 300);
    });
  }
  
  const systemSection = settingsContent.querySelector('#system-section');
  if (systemSection && systemSection.classList.contains('active')) {
    setTimeout(() => {
      checkForSystemUpdates();
    }, 500);
  }
} // ADD THIS CLOSING BRACE
</script>
</body>
</html>
